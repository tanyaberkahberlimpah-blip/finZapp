<!DOCTYPE html>
<html lang="id">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
 <meta name="theme-color" content="#a855f7">
 <title>FinZ App - Gen Z Edition</title>
 <!-- Dynamic PWA Manifest Placeholder -->
 <link rel="manifest" id="dynamic-manifest">
 
 <!-- Tailwind CSS -->
 <script src="https://cdn.tailwindcss.com"></script>
 <!-- SweetAlert2 Library -->
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 <!-- Chart.js Library -->
 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 <!-- Google Fonts -->
 <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Poppins:wght@700;800;900&display=swap" rel="stylesheet">
  
 <style id="theme-style">
    /* --- BASE LAYOUT (LIGHT MODE) --- */
    :root {
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --bg-glass: rgba(255, 255, 255, 0.95);
      --text-main: #0f172a;       /* Sangat Gelap untuk Light Mode */
      --text-muted: #475569;      /* Slate gelap, mudah dibaca */
      --border-color: #e2e8f0;
      --input-bg: #f1f5f9;
      --border-glass: rgba(0, 0, 0, 0.08);
      --radius-xl: 28px;
      --radius-l: 20px;
      
      /* Semantic Text Colors (High Contrast) */
      --text-positive: #059669; /* Emerald 600 */
      --text-negative: #e11d48; /* Rose 600 */
      --text-info: #2563eb;     /* Blue 600 */
      --text-warning: #d97706;  /* Amber 600 */
    }

    /* --- DARK MODE OVERRIDE --- */
    body.dark-mode {
      --bg-body: #09090b;
      --bg-card: #18181b;
      --bg-glass: rgba(24, 24, 27, 0.95);
      --text-main: #f8fafc;       /* Putih terang untuk Dark Mode */
      --text-muted: #94a3b8;      /* Abu-abu terang */
      --border-color: #27272a;
      --input-bg: #1f1f22;
      --border-glass: rgba(255, 255, 255, 0.1);

      --text-positive: #34d399; /* Emerald 400 */
      --text-negative: #fb7185; /* Rose 400 */
      --text-info: #60a5fa;     /* Blue 400 */
      --text-warning: #fbbf24;  /* Amber 400 */
    }

    /* --- THEMES (Brand Accents & Contrast Safety) --- */
    body.theme-neon {
      --primary: #a855f7;
      --accent: #d946ef;
      --gradient-main: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #d946ef 100%);
      --text-on-gradient: #ffffff; /* Aman karena gradient gelap */
      --success-on-grad: #6ee7b7;
      --danger-on-grad: #fda4af;
      --info-on-grad: #93c5fd;
      --shadow-glow: 0 10px 30px -10px rgba(168, 85, 247, 0.3);
    }

    body.theme-pastel-enerjik {
      --primary: #f472b6;
      --accent: #facc15;
      --gradient-main: linear-gradient(135deg, #f472b6 0%, #fbbf24 100%);
      --text-on-gradient: #4c0519; /* Gradasi terang, butuh teks gelap */
      --success-on-grad: #065f46;
      --danger-on-grad: #9f1239;
      --info-on-grad: #1e3a8a;
      --shadow-glow: 4px 4px 0px rgba(244, 114, 182, 0.3);
    }

    body.theme-earth {
      --primary: #576b53;
      --accent: #b08968;
      --gradient-main: linear-gradient(135deg, #576b53 0%, #7f9c78 100%);
      --text-on-gradient: #ffffff;
      --success-on-grad: #a7f3d0;
      --danger-on-grad: #fecdd3;
      --info-on-grad: #bfdbfe;
      --shadow-glow: 0 10px 30px -10px rgba(87, 107, 83, 0.2);
    }

    body.theme-iridescent {
      --primary: #06b6d4;
      --accent: #8b5cf6;
      --gradient-main: linear-gradient(45deg, #06b6d4, #8b5cf6, #ec4899);
      --text-on-gradient: #ffffff;
      --success-on-grad: #6ee7b7;
      --danger-on-grad: #fda4af;
      --info-on-grad: #93c5fd;
      --shadow-glow: 0 8px 32px rgba(31, 38, 135, 0.15);
    }

    body.theme-pastel {
      --primary: #94a3b8;
      --accent: #cbd5e1;
      --gradient-main: linear-gradient(135deg, #94a3b8 0%, #cbd5e1 100%);
      --text-on-gradient: #0f172a; /* Gradasi terang, butuh teks gelap */
      --success-on-grad: #065f46;
      --danger-on-grad: #9f1239;
      --info-on-grad: #1e3a8a;
      --shadow-glow: 0 4px 15px -1px rgba(148, 163, 184, 0.2);
    }
    
    /* --- UTILITY CLASSES (Auto-Adaptive) --- */
    .bg-primary-alpha { background-color: color-mix(in srgb, var(--primary) 15%, transparent); color: var(--primary); }
    .bg-positive-alpha { background-color: color-mix(in srgb, var(--text-positive) 15%, transparent); color: var(--text-positive); }
    .bg-negative-alpha { background-color: color-mix(in srgb, var(--text-negative) 15%, transparent); color: var(--text-negative); }
    .bg-warning-alpha { background-color: color-mix(in srgb, var(--text-warning) 15%, transparent); color: var(--text-warning); }
    
    /* --- BASE RESET --- */
    *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
        font-family: 'Plus Jakarta Sans', sans-serif; 
        background: var(--bg-body); color: var(--text-main); 
        min-height: 100vh; transition: background 0.3s, color 0.3s;
        display: flex; flex-direction: column; overflow-x: hidden;
    }

    /* --- COMPONENTS --- */
    .font-heading { font-family: 'Outfit', sans-serif; }
    
    /* Custom Styling Nama Aplikasi */
    .font-poppins { font-family: 'Poppins', sans-serif; font-weight: 900; }
    .text-stroke-white { -webkit-text-stroke: 1.5px #ffffff; }
    
    .glass-card { 
        background: var(--bg-card); 
        border: 1px solid var(--border-color); 
        border-radius: var(--radius-xl); 
        box-shadow: var(--shadow-glow); 
        transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .glass-card:active { transform: scale(0.98); }

    .sticky-header { 
        background: var(--bg-glass); 
        backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
        border-bottom: 1px solid var(--border-color); 
        transition: background 0.3s; 
        z-index: 50;
    }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    /* --- SIDEBAR --- */
    #sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s; }
    #sidebar-overlay.active { opacity: 1; pointer-events: auto; }
    #sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 85%; max-width: 300px; background: var(--bg-card); z-index: 1001; transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); padding: 24px; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
    #sidebar.active { transform: translateX(0); }
    
    .sidebar-link { 
        display: flex; align-items: center; gap: 14px; padding: 16px; 
        border-radius: var(--radius-l); font-weight: 600; font-size: 15px; 
        color: var(--text-muted); transition: 0.2s; margin-bottom: 6px; cursor: pointer; 
    }
    .sidebar-link.active { 
        background: var(--gradient-main); color: var(--text-on-gradient) !important; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
    }
    .sidebar-close-btn { 
        width: 36px; height: 36px; border-radius: 50%; 
        background: var(--bg-body); color: var(--text-main); 
        display: flex; align-items: center; justify-content: center; 
        font-weight: 800; border: 1px solid var(--border-color);
        cursor: pointer;
    }

    /* --- AI COACH SIDEBAR --- */
    #ai-sidebar { 
        position: fixed; top: 0; right: 0; height: 100%; width: 90%; max-width: 360px; 
        background: var(--bg-card); z-index: 1002; 
        transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
        padding: 24px; display: flex; flex-direction: column; 
        border-left: 1px solid var(--border-color); 
        box-shadow: -10px 0 40px rgba(0,0,0,0.2); 
    }
    #ai-sidebar.active { transform: translateX(0); }

    /* --- BALANCE CARD (Funky Gradient) --- */
    .balance-card { 
        background: var(--gradient-main); 
        border-radius: 36px; padding: 32px 24px; color: var(--text-on-gradient); 
        position: relative; overflow: hidden; 
        box-shadow: 0 20px 50px -15px rgba(0,0,0,0.3);
    }
    .balance-sub-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 24px; }
    .balance-sub-item { 
        background: color-mix(in srgb, var(--bg-body) 20%, transparent); 
        border: 1px solid color-mix(in srgb, var(--bg-body) 10%, transparent); 
        border-radius: 20px; padding: 14px; backdrop-filter: blur(8px); 
    }
    
    /* --- CHIPS & BUTTONS --- */
    .filter-chip { 
        padding: 10px 18px; border-radius: 99px; font-size: 12px; font-weight: 700; 
        border: 1px solid var(--border-color); background: var(--bg-card); 
        color: var(--text-muted); transition: 0.2s; text-align: center;
    }
    .filter-chip.active { 
        background: var(--primary); color: var(--text-on-gradient); border-color: var(--primary); 
    }
    
    .fab-btn { 
        position: fixed; bottom: 32px; right: 24px; width: 68px; height: 68px; 
        border-radius: 28px; background: var(--primary); color: var(--text-on-gradient); 
        font-size: 36px; display: flex; align-items: center; justify-content: center; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 900; 
        cursor: pointer; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .fab-btn:active { transform: scale(0.9) rotate(45deg); }

    /* --- MODALS (Bottom Sheet Style) --- */
    .modal-overlay { 
        position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 2000; 
        display: none; align-items: flex-end; justify-content: center;
    }
    .modal-overlay.active { display: flex; }

    .modal-sheet { 
        background: var(--bg-card); color: var(--text-main); 
        width: 100%; max-width: 480px; 
        border-radius: 40px 40px 0 0; padding: 32px 24px; 
        padding-bottom: calc(32px + env(safe-area-inset-bottom)); 
        max-height: 92vh; overflow-y: auto; 
        animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
        position: relative; border-top: 1px solid var(--border-glass); 
        margin: 0 auto;
    }
    .modal-sheet::before {
        content: ''; display: block; width: 48px; height: 6px; 
        background-color: var(--border-color); border-radius: 99px; 
        margin: -10px auto 24px auto; opacity: 0.5;
    }

    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    /* --- INPUTS --- */
    .input-field { 
        width: 100%; padding: 18px; border-radius: 20px; 
        border: 2px solid var(--border-color); background: var(--input-bg); 
        font-weight: 600; font-size: 16px; outline: none; color: var(--text-main); 
        transition: 0.2s; 
    }
    .input-field:focus { border-color: var(--primary); background: var(--bg-card); }
    
    /* --- MISC --- */
    .grid-icon-item { 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
        gap: 10px; padding: 16px; border: 2px solid var(--border-color); 
        border-radius: 24px; cursor: pointer; transition: 0.2s; background: var(--bg-body); 
        color: var(--text-main);
    }
    .grid-icon-item.active { 
        border-color: var(--primary); background: color-mix(in srgb, var(--primary) 10%, transparent); transform: translateY(-4px); 
    }
    
    /* CHAT BUBBLES */
    .chat-bubble { padding: 12px 18px; border-radius: 24px; margin-bottom: 10px; font-size: 13px; line-height: 1.5; max-width: 85%; }
    .chat-user { background: var(--primary); color: var(--text-on-gradient); align-self: flex-end; border-bottom-right-radius: 4px; }
    .chat-bot { background: var(--bg-body); color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid var(--border-color); }

    /* ACTION BUTTONS */
    .action-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 16px; transition: 0.2s; cursor: pointer; }
    .action-btn:hover { transform: scale(1.1); }
    .action-btn-edit { background: color-mix(in srgb, var(--text-info) 15%, transparent); color: var(--text-info); }
    .action-btn-del { background: color-mix(in srgb, var(--text-negative) 15%, transparent); color: var(--text-negative); }

    /* FAB MENU */
    .fab-action-container {
        position: fixed; bottom: 110px; right: 24px; z-index: 899;
        display: flex; flex-direction: column; gap: 12px; align-items: flex-end;
        pointer-events: none; opacity: 0; transition: 0.3s; transform: translateY(20px);
    }
    .fab-action-container.active { pointer-events: auto; opacity: 1; transform: translateY(0); }

    .fab-action-item { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .fab-action-btn { width: 52px; height: 52px; border-radius: 20px; font-size: 22px; border: none; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); color: white;}
    .fab-action-label { background: var(--bg-card); color: var(--text-main); padding: 8px 16px; border-radius: 14px; font-weight: 800; font-size: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); letter-spacing: 0.5px; border: 1px solid var(--border-color); }

    /* CALENDAR */
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; margin-top: 16px; }
    .cal-day { width: 100%; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-weight: 700; font-size: 13px; cursor: pointer; transition: 0.2s; color: var(--text-main); }
    .cal-day:hover { background: var(--border-color); }
    .cal-day.active { background: var(--text-main); color: var(--bg-body) !important; border-radius: 12px; }
    .cal-day.range-start, .cal-day.range-end { background: var(--primary); border-radius: 12px; color: var(--text-on-gradient); }
    .cal-day.in-range { background: color-mix(in srgb, var(--primary) 20%, transparent); }
    .quick-select-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 24px; }
    .quick-btn { padding: 12px; border-radius: 16px; border: 1px solid var(--border-color); color: var(--text-muted); text-align: center; font-size: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .quick-btn.active { background: var(--text-main); color: var(--bg-card); border-color: var(--text-main); }
    
    /* TX TYPE PILL */
    .tx-type-pill { flex: 1; padding: 12px; text-align: center; border-radius: 99px; font-size: 12px; font-weight: 700; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
    .tx-type-pill.active { background: var(--bg-card); color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .big-amount-input { width: 100%; background: transparent; border: none; font-size: 32px; font-weight: 800; color: var(--text-main); outline: none; font-family: 'Outfit', sans-serif; }
    
    /* GLITCH EFFECT */
    @keyframes shake-glitch {
        0% { transform: translate(1px, 1px) rotate(0deg); border-color: #f43f5e; box-shadow: 0 0 20px rgba(244,63,94,0.6); filter: hue-rotate(90deg); }
        10% { transform: translate(-1px, -2px) rotate(-1deg); }
        20% { transform: translate(-3px, 0px) rotate(1deg); filter: invert(100%); }
        30% { transform: translate(3px, 2px) rotate(0deg); }
        40% { transform: translate(1px, -1px) rotate(1deg); }
        50% { transform: translate(-1px, 2px) rotate(-1deg); filter: hue-rotate(180deg); }
        60% { transform: translate(-3px, 1px) rotate(0deg); }
        70% { transform: translate(3px, 1px) rotate(-1deg); }
        80% { transform: translate(-1px, -1px) rotate(1deg); filter: invert(100%); }
        90% { transform: translate(1px, 2px) rotate(0deg); }
        100% { transform: translate(1px, -2px) rotate(-1deg); border-color: transparent; filter: none;}
    }
    .glitch-active { animation: shake-glitch 0.4s cubic-bezier(.36,.07,.19,.97) both; }
 </style>
</head>
<body class="no-scrollbar">

  <!-- SIDEBAR SYSTEM -->
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <nav id="sidebar">
      <div class="mb-10 flex items-center justify-between">
         <div class="text-3xl tracking-tighter font-poppins text-stroke-white bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent">FinZ App</div>
         <button onclick="toggleSidebar()" class="sidebar-close-btn">‚úï</button>
      </div>
      <div class="flex-1 space-y-3 overflow-y-auto no-scrollbar">
          <div class="sidebar-link active" id="side-home" onclick="switchView('home')">üè† Beranda</div>
          <div class="sidebar-link" id="side-reports" onclick="openReportModal()">üìä Analitik</div>
          <div class="sidebar-link" id="side-planner" onclick="switchView('planner')">üìÖ Planner</div>
          <div class="sidebar-link" id="side-budget" onclick="switchView('budget')">üìâ Budgeting</div>
          <div class="sidebar-link" id="side-aset" onclick="switchView('aset')">üíé Aset</div>
          <div class="sidebar-link" id="side-dompet" onclick="switchView('dompet')">üí≥ Dompet</div>
          <div class="sidebar-link" id="side-goals" onclick="switchView('goals')">üéØ Goals</div>
          <div class="sidebar-link" id="side-settings" onclick="switchView('settings')">‚öôÔ∏è Setelan</div>
      </div>
      <div class="pt-8 border-t border-dashed border-[var(--border-color)]">
          <button onclick="handleLogout()" class="sidebar-link text-[var(--text-negative)] hover:bg-negative-alpha">üö™ Logout</button>
      </div>
  </nav>

  <!-- AI COACH SIDEBAR -->
  <div id="ai-sidebar">
      <div class="flex justify-between items-center mb-8">
          <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-2xl bg-primary-alpha flex items-center justify-center text-2xl">ü§ñ</div>
              <div><h3 class="font-heading font-bold text-lg text-[var(--text-main)]">FinZ Coach</h3><p class="text-xs text-[var(--text-muted)] font-bold">AI Financial Bestie</p></div>
          </div>
          <button onclick="toggleAICoach()" class="sidebar-close-btn">‚úï</button>
      </div>
      <div id="chat-history-sidebar" class="flex-1 overflow-y-auto mb-4 space-y-3 flex flex-col px-2">
          <div class="chat-bubble chat-bot">Halo Bestie! üëã Aku FinZ Coach. Mau curhat soal keuangan apa hari ini?</div>
      </div>
      <div class="flex gap-2">
          <input type="text" id="chat-input-sidebar" class="input-field py-4 text-sm" placeholder="Tanya sesuatu..." onkeypress="if(event.key==='Enter') sendChatSidebar()">
          <button onclick="sendChatSidebar()" class="p-4 bg-[var(--primary)] text-[var(--text-on-gradient)] rounded-2xl shadow-lg active:scale-95 transition-transform">‚û§</button>
      </div>
  </div>

  <!-- AUTH SECTION (NEW MODERN DARK GLASSMORPHISM WITH TABS) -->
  <section id="auth-section" class="fixed inset-0 z-[3000] flex items-center justify-center p-6 bg-[#09090b] overflow-hidden">
    
    <!-- Ambient Background Glows -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div class="absolute -top-[10%] -left-[10%] w-96 h-96 bg-purple-600/30 rounded-full mix-blend-screen filter blur-[100px] animate-pulse"></div>
        <div class="absolute -bottom-[10%] -right-[10%] w-96 h-96 bg-pink-600/30 rounded-full mix-blend-screen filter blur-[100px] animate-pulse" style="animation-delay: 2s;"></div>
    </div>

    <!-- Glassmorphism Login Card -->
    <div id="login-card" class="w-full max-w-sm p-8 text-center relative z-10 transition-all duration-300 bg-white/5 backdrop-blur-2xl border border-white/10 rounded-[32px] shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar">
      
      <div class="mb-6">
          <h1 class="text-5xl tracking-tighter mb-2 font-poppins text-stroke-white bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent drop-shadow-sm">FinZ App</h1>
          <h2 id="auth-greeting" class="text-2xl font-bold mt-4 mb-2 text-white tracking-tight">Welcome Back! üëã</h2>
          <p class="text-sm font-medium text-gray-400">Manage Money, The Gen Z Way.</p>
      </div>

      <!-- TABS NAVIGATION -->
      <div class="flex w-full mb-6 border-b border-white/10">
          <button id="tab-btn-login" onclick="switchAuthTab('login')" class="flex-1 pb-3 text-sm font-bold border-b-2 border-purple-500 text-purple-400 transition-all">Masuk</button>
          <button id="tab-btn-register" onclick="switchAuthTab('register')" class="flex-1 pb-3 text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-300 transition-all">Daftar Akun</button>
      </div>
      
      <!-- FORM: LOGIN -->
      <div id="auth-form-login" class="space-y-4 mb-6 text-left relative z-20 transition-opacity duration-300 block">
          <!-- Email Input -->
          <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-500 group-focus-within:text-purple-400 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
              </div>
              <input type="email" id="login-email" class="w-full pl-12 pr-4 py-4 bg-black/40 border border-white/10 rounded-2xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all" placeholder="Email kamu...">
          </div>
          
          <!-- Password Input -->
          <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-500 group-focus-within:text-pink-400 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
              </div>
              <input type="password" id="login-password" class="w-full pl-12 pr-4 py-4 bg-black/40 border border-white/10 rounded-2xl text-white placeholder-gray-500 focus:outline-none focus:border-pink-500 focus:ring-1 focus:ring-pink-500 transition-all" placeholder="Password...">
          </div>

          <button id="btn-login" onclick="handleLogin()" class="w-full py-4 mt-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl font-bold text-lg shadow-[0_4px_20px_rgba(168,85,247,0.4)] active:scale-95 hover:shadow-[0_4px_25px_rgba(168,85,247,0.6)] transition-all relative z-20">Masuk</button>
          
          <p class="mt-6 text-xs font-bold text-gray-400 text-center cursor-pointer hover:text-white transition-colors relative z-20" onclick="fillDemo()">Gunakan Akun Demo (Data Penuh)</p>
      </div>

      <!-- FORM: REGISTER -->
      <div id="auth-form-register" class="space-y-4 mb-2 text-left relative z-20 transition-opacity duration-300 hidden">
          <!-- Name Input -->
          <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-500 group-focus-within:text-cyan-400 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
              </div>
              <input type="text" id="reg-name" class="w-full pl-12 pr-4 py-4 bg-black/40 border border-white/10 rounded-2xl text-white placeholder-gray-500 focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 transition-all" placeholder="Nama Panggilan">
          </div>

          <!-- Email Input -->
          <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-500 group-focus-within:text-purple-400 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
              </div>
              <input type="email" id="reg-email" class="w-full pl-12 pr-4 py-4 bg-black/40 border border-white/10 rounded-2xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all" placeholder="Email aktif...">
          </div>
          
          <!-- Password Input -->
          <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-500 group-focus-within:text-pink-400 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
              </div>
              <input type="password" id="reg-password" class="w-full pl-12 pr-4 py-4 bg-black/40 border border-white/10 rounded-2xl text-white placeholder-gray-500 focus:outline-none focus:border-pink-500 focus:ring-1 focus:ring-pink-500 transition-all" placeholder="Buat password...">
          </div>

          <!-- Confirm Password Input -->
          <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-500 group-focus-within:text-pink-400 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
              </div>
              <input type="password" id="reg-password-confirm" class="w-full pl-12 pr-4 py-4 bg-black/40 border border-white/10 rounded-2xl text-white placeholder-gray-500 focus:outline-none focus:border-pink-500 focus:ring-1 focus:ring-pink-500 transition-all" placeholder="Ulangi password...">
          </div>

          <button id="btn-register" onclick="handleRegister()" class="w-full py-4 mt-6 bg-white text-black rounded-2xl font-bold text-lg shadow-[0_4px_20px_rgba(255,255,255,0.2)] active:scale-95 hover:bg-gray-100 transition-all relative z-20">Daftar Sekarang</button>
      </div>

    </div>
  </section>

  <!-- MAIN APP CONTAINER -->
  <main id="main-app" class="container mx-auto max-w-md min-h-screen pb-32 relative hidden">
      
    <!-- HEADER -->
    <header class="sticky-header sticky top-0 z-50 px-6 py-5 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="w-12 h-12 rounded-2xl bg-[var(--bg-body)] border border-[var(--border-color)] flex flex-col items-center justify-center gap-1.5 shadow-sm active:scale-90 transition-transform">
                <div class="w-5 h-0.5 bg-[var(--text-main)] rounded-full"></div>
                <div class="w-5 h-0.5 bg-[var(--text-main)] rounded-full"></div>
            </button>
            <div>
                <h1 id="page-title" class="text-xl font-heading font-bold tracking-tight text-[var(--text-main)]">Beranda</h1>
                <p id="user-greet" class="text-[11px] font-bold text-[var(--primary)] uppercase tracking-wider">Halo, User</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleAICoach()" class="w-12 h-12 rounded-2xl bg-primary-alpha text-2xl flex items-center justify-center border border-[var(--border-glass)] active:scale-90 transition-transform">ü§ñ</button>
            <button id="theme-toggle-btn" onclick="toggleDarkMode()" class="text-xl w-10 h-10 flex items-center justify-center text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors">üåô</button>
        </div>
    </header>

    <!-- CONTENT VIEWS -->
    <div class="px-6 py-4 space-y-8">

        <!-- VIEW: HOME (BERANDA) -->
        <div id="view-home" class="space-y-8">
            <!-- Filter Periode -->
            <div onclick="toggleDateModal(true)" class="glass-card px-5 py-4 flex items-center justify-between cursor-pointer active:scale-95 transition-transform text-[var(--text-main)]">
                <div class="flex items-center gap-4"><span class="text-2xl">üóìÔ∏è</span><span id="home-period-label" class="text-sm font-bold">Bulan Ini</span></div>
                <span class="text-[var(--text-muted)] text-xs">‚ñº</span>
            </div>
            
            <!-- Card Utama -->
            <div class="balance-card">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-black tracking-widest opacity-90 uppercase">Total Saldo</span>
                    <span class="text-xl">üí≥</span>
                </div>
                <h2 id="home-balance" class="text-4xl font-heading font-extrabold mb-8">Rp 0</h2>
                <div class="balance-sub-grid">
                    <div class="balance-sub-item">
                        <p class="text-[10px] font-bold uppercase opacity-80 mb-1">Pemasukan</p>
                        <p id="home-inc" class="text-sm font-black text-[var(--success-on-grad)]">Rp 0</p>
                    </div>
                    <div class="balance-sub-item">
                        <p class="text-[10px] font-bold uppercase opacity-80 mb-1">Pengeluaran</p>
                        <p id="home-exp" class="text-sm font-black text-[var(--danger-on-grad)]">Rp 0</p>
                    </div>
                    <div class="balance-sub-item">
                        <p class="text-[10px] font-bold uppercase opacity-80 mb-1">Tabungan</p>
                        <p id="home-sav" class="text-sm font-black text-[var(--info-on-grad)]">Rp 0</p>
                    </div>
                    <div class="balance-sub-item">
                        <p class="text-[10px] font-bold uppercase opacity-80 mb-1">Investasi</p>
                        <p id="home-inv" class="text-sm font-black text-[var(--warn-on-grad)]">Rp 0</p>
                    </div>
                </div>
            </div>
            
            <!-- Grafik Pengeluaran -->
            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base font-bold font-heading text-[var(--text-main)]">Trend Pengeluaran</h3>
                    <span class="text-[10px] font-bold text-[var(--text-muted)] bg-[var(--input-bg)] px-2 py-1 rounded">7 Hari Terakhir</span>
                </div>
                <div class="relative w-full h-48">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>

            <!-- Distribusi -->
            <div class="glass-card p-6">
                <h3 class="text-base font-bold mb-6 font-heading text-[var(--text-main)]">Statistik Keuangan</h3>
                <div class="flex items-center gap-8">
                    <div class="relative w-28 h-28 flex items-center justify-center shrink-0">
                        <svg class="donut-chart-svg" viewBox="0 0 100 100" style="transform: rotate(-90deg); width:100%; height:100%;">
                            <circle class="donut-circle-bg" cx="50" cy="50" r="40" style="fill: none; stroke: var(--border-glass); stroke-width: 12;"></circle>
                            <circle id="d-inc" class="donut-circle-val" cx="50" cy="50" r="40" stroke-dasharray="0 251" style="fill: none; stroke-width: 12; stroke-linecap: round; stroke: var(--text-positive); transition: stroke-dasharray 0.6s ease;"></circle>
                            <circle id="d-exp" class="donut-circle-val" cx="50" cy="50" r="40" stroke-dasharray="0 251" style="fill: none; stroke-width: 12; stroke-linecap: round; stroke: var(--text-negative); transition: stroke-dasharray 0.6s ease;"></circle>
                            <circle id="d-sav" class="donut-circle-val" cx="50" cy="50" r="40" stroke-dasharray="0 251" style="fill: none; stroke-width: 12; stroke-linecap: round; stroke: var(--text-info); transition: stroke-dasharray 0.6s ease;"></circle>
                            <circle id="d-inv" class="donut-circle-val" cx="50" cy="50" r="40" stroke-dasharray="0 251" style="fill: none; stroke-width: 12; stroke-linecap: round; stroke: var(--primary); transition: stroke-dasharray 0.6s ease;"></circle>
                        </svg>
                        <span class="absolute text-2xl">üìä</span>
                    </div>
                    <div class="space-y-3 flex-1">
                        <div class="flex justify-between text-xs font-bold text-[var(--text-main)]"><span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-positive-alpha"></span>Masuk</span><span id="l-inc">0%</span></div>
                        <div class="flex justify-between text-xs font-bold text-[var(--text-main)]"><span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-negative-alpha"></span>Keluar</span><span id="l-exp">0%</span></div>
                        <div class="flex justify-between text-xs font-bold text-[var(--text-main)]"><span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background-color: var(--text-info);"></span>Tabung</span><span id="l-sav">0%</span></div>
                        <div class="flex justify-between text-xs font-bold text-[var(--text-main)]"><span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background-color: var(--primary);"></span>Invest</span><span id="l-inv">0%</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Horizontal Cards -->
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card p-5">
                    <p class="text-[10px] text-[var(--text-muted)] font-bold uppercase mb-2 tracking-wider">Top Pengeluaran</p>
                    <p id="top-expense-val" class="text-base font-black truncate text-[var(--text-negative)]">Rp 0</p>
                    <p id="top-expense-cat" class="text-xs font-bold text-[var(--text-main)] mt-1">-</p>
                </div>
                <div class="glass-card p-5">
                    <p class="text-[10px] text-[var(--text-muted)] font-bold uppercase mb-2 tracking-wider">Tagihan Dekat</p>
                    <p id="upcoming-bills-count" class="text-base font-black text-[var(--text-main)]">0 Tagihan</p>
                    <p class="text-xs font-bold text-[var(--primary)] mt-1">Cek Kalender</p>
                </div>
            </div>

            <!-- Daftar Transaksi -->
            <div>
                <div class="flex justify-between items-center mb-4 px-1">
                    <h3 class="text-base font-bold font-heading text-[var(--text-main)]">Transaksi Terakhir</h3>
                    <span class="text-xs font-bold text-[var(--primary)] cursor-pointer">Lihat Semua</span>
                </div>
                <div class="filter-chip-container mb-4 flex gap-2 overflow-x-auto no-scrollbar pb-1">
                    <button class="filter-chip active shrink-0" id="chip-all" onclick="filterTx('all', this)">Semua</button>
                    <button class="filter-chip shrink-0" id="chip-income" onclick="filterTx('income', this)">Masuk</button>
                    <button class="filter-chip shrink-0" id="chip-expense" onclick="filterTx('expense', this)">Keluar</button>
                    <button class="filter-chip shrink-0" id="chip-saving" onclick="filterTx('saving', this)">Tabung</button>
                    <button class="filter-chip shrink-0" id="chip-investment" onclick="filterTx('investment', this)">Invest</button>
                </div>
                <div id="tx-list-container" class="space-y-3 pb-20"></div>
            </div>
        </div>

        <!-- VIEW: PLANNER -->
        <div id="view-planner" class="hidden space-y-6">
            <!-- TAB NAVIGATION -->
            <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2 border-b border-[var(--border-color)] px-1">
                <button onclick="switchPlannerTab('overview')" id="tab-overview" class="whitespace-nowrap px-2 py-3 font-black text-sm text-[var(--primary)] border-b-2 border-[var(--primary)] transition-all">Overview</button>
                <button onclick="switchPlannerTab('tips')" id="tab-tips" class="whitespace-nowrap px-2 py-3 font-bold text-sm text-[var(--text-muted)] border-b-2 border-transparent transition-all">Smart Tips</button>
                <button onclick="switchPlannerTab('roadmap')" id="tab-roadmap" class="whitespace-nowrap px-2 py-3 font-bold text-sm text-[var(--text-muted)] border-b-2 border-transparent transition-all">Roadmap</button>
            </div>
            
            <!-- 1. OVERVIEW TAB -->
            <div id="planner-overview" class="space-y-6 animate-fade pb-10">
                <!-- PERBAIKAN PLANNER: Dihapus glass-card agar background alpha tidak tertimpa putih -->
                <div class="bg-primary-alpha rounded-[28px] shadow-[var(--shadow-glow)] border border-[var(--border-color)] p-8 flex flex-col items-center text-center relative overflow-hidden">
                    <div class="absolute -top-4 -right-4 opacity-10 text-8xl">ü©∫</div>
                    <h3 class="text-xs font-bold uppercase opacity-80 mb-6 tracking-widest text-[var(--primary)]">Financial Health Score</h3>
                    
                    <div class="relative w-40 h-40 mb-4 flex items-center justify-center">
                        <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-lg">
                            <circle cx="50" cy="50" r="45" stroke="var(--border-color)" stroke-width="8" fill="none"></circle>
                            <circle id="planner-score-ring" cx="50" cy="50" r="45" stroke="var(--primary)" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="283" stroke-dashoffset="283" style="transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 1.5s cubic-bezier(0.16, 1, 0.3, 1);"></circle>
                        </svg>
                        <span id="planner-score-val" class="absolute text-5xl font-black font-heading text-[var(--text-main)] drop-shadow-md">0</span>
                    </div>
                    
                    <p id="planner-score-status" class="text-xl font-black text-[var(--text-main)]">Menghitung...</p>
                    <p class="text-xs text-[var(--text-muted)] mt-2 max-w-[200px] leading-relaxed">Skor berbasis rasio hutang, kapasitas tabungan & ketahanan aset.</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Debt Ratio -->
                    <div class="glass-card p-5 relative flex flex-col justify-between">
                        <span onclick="showMetricInfo('debt')" class="absolute top-3 right-3 text-xs text-[var(--text-muted)] cursor-pointer hover:text-[var(--text-main)] transition-colors">‚ÑπÔ∏è</span>
                        <div class="mb-4 w-10 h-10 rounded-2xl bg-negative-alpha flex items-center justify-center text-[var(--text-negative)] text-lg shadow-sm">üí≥</div>
                        <div>
                            <p class="text-[10px] font-bold uppercase text-[var(--text-muted)] mb-1">Debt Ratio</p>
                            <div class="flex items-end gap-2 mb-2">
                                <h4 id="metric-debt" class="text-2xl font-black font-heading text-[var(--text-main)]">0%</h4>
                                <span id="metric-debt-ind" class="text-xs font-bold pb-1"></span>
                            </div>
                            <p class="text-[10px] text-[var(--text-positive)] font-bold bg-positive-alpha px-2 py-1 rounded w-fit">üéØ Target &lt;30%</p>
                        </div>
                    </div>
                    
                    <!-- Saving Capacity -->
                    <div class="glass-card p-5 relative flex flex-col justify-between">
                        <span onclick="showMetricInfo('saving')" class="absolute top-3 right-3 text-xs text-[var(--text-muted)] cursor-pointer hover:text-[var(--text-main)] transition-colors">‚ÑπÔ∏è</span>
                        <div class="mb-4 w-10 h-10 rounded-2xl bg-positive-alpha flex items-center justify-center text-[var(--text-positive)] text-lg shadow-sm">üè¶</div>
                        <div>
                            <p class="text-[10px] font-bold uppercase text-[var(--text-muted)] mb-1">Saving Rate</p>
                            <div class="flex items-end gap-2 mb-2">
                                <h4 id="metric-saving" class="text-2xl font-black font-heading text-[var(--text-main)]">0%</h4>
                                <span id="metric-saving-ind" class="text-xs font-bold pb-1"></span>
                            </div>
                            <p class="text-[10px] text-[var(--text-positive)] font-bold bg-positive-alpha px-2 py-1 rounded w-fit">üéØ Target &gt;20%</p>
                        </div>
                    </div>

                    <!-- Asset Coverage -->
                    <div class="glass-card p-5 relative flex flex-col justify-between">
                        <span onclick="showMetricInfo('asset')" class="absolute top-3 right-3 text-xs text-[var(--text-muted)] cursor-pointer hover:text-[var(--text-main)] transition-colors">‚ÑπÔ∏è</span>
                        <div class="mb-4 w-10 h-10 rounded-2xl bg-primary-alpha flex items-center justify-center text-[var(--primary)] text-lg shadow-sm">üõ°Ô∏è</div>
                        <div>
                            <p class="text-[10px] font-bold uppercase text-[var(--text-muted)] mb-1">Asset Cover</p>
                            <div class="flex items-end gap-2 mb-2">
                                <h4 id="metric-asset" class="text-2xl font-black font-heading text-[var(--text-main)]">0 Bln</h4>
                                <span id="metric-asset-ind" class="text-xs font-bold pb-1"></span>
                            </div>
                            <p class="text-[10px] text-[var(--text-positive)] font-bold bg-positive-alpha px-2 py-1 rounded w-fit">üéØ Target &gt;6 Bln</p>
                        </div>
                    </div>

                    <!-- Expense Ratio -->
                    <div class="glass-card p-5 relative flex flex-col justify-between">
                        <span onclick="showMetricInfo('expense')" class="absolute top-3 right-3 text-xs text-[var(--text-muted)] cursor-pointer hover:text-[var(--text-main)] transition-colors">‚ÑπÔ∏è</span>
                        <div class="mb-4 w-10 h-10 rounded-2xl bg-warning-alpha flex items-center justify-center text-[var(--text-warning)] text-lg shadow-sm">üí∏</div>
                        <div>
                            <p class="text-[10px] font-bold uppercase text-[var(--text-muted)] mb-1">Expense Ratio</p>
                            <div class="flex items-end gap-2 mb-2">
                                <h4 id="metric-expense" class="text-2xl font-black font-heading text-[var(--text-main)]">0%</h4>
                                <span id="metric-expense-ind" class="text-xs font-bold pb-1"></span>
                            </div>
                            <p class="text-[10px] text-[var(--text-positive)] font-bold bg-positive-alpha px-2 py-1 rounded w-fit">üéØ Target &lt;50%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. SMART TIPS TAB -->
            <div id="planner-tips" class="hidden space-y-4 animate-fade pb-10 text-[var(--text-main)]"></div>

            <!-- 3. ROADMAP TAB -->
            <div id="planner-roadmap" class="hidden animate-fade pb-10 mt-4">
                <div id="roadmap-container" class="relative ml-4 border-l-2 border-[var(--border-color)] space-y-10 pb-4 text-[var(--text-main)]"></div>
            </div>
        </div>

        <!-- VIEW: BUDGET -->
        <div id="view-budget" class="hidden space-y-6">
             <!-- PERBAIKAN BUDGET: Mengganti class glass-card agar background alpha tidak tertimpa putih di light mode -->
             <div class="bg-primary-alpha p-8 rounded-[28px] shadow-[var(--shadow-glow)] border border-[var(--border-color)]">
                 <div class="flex justify-between items-start mb-6">
                     <h2 class="font-black text-3xl text-[var(--primary)] font-heading">Budget</h2>
                     <span class="text-xs font-bold bg-[var(--bg-card)] text-[var(--primary)] px-3 py-1.5 rounded-full uppercase tracking-wider">On Track</span>
                 </div>
                 <div class="mb-3 flex justify-between text-xs font-bold uppercase tracking-wide text-[var(--text-main)]"><span>Terpakai</span><span>Total Limit</span></div>
                 <div class="flex justify-between text-lg font-black mb-4 text-[var(--text-main)]">
                     <span id="budget-used">Rp 0</span><span class="opacity-50">/</span><span id="budget-total">Rp 0</span>
                 </div>
                 <div class="w-full bg-[var(--border-glass)] rounded-full h-4 mb-3"><div id="budget-bar-main" class="bg-[var(--primary)] h-4 rounded-full w-0 transition-all duration-700"></div></div>
                 <p id="budget-pct" class="text-right text-xs font-black text-[var(--text-main)]">0% Digunakan</p>
             </div>
             <button onclick="generateAIBudget()" class="w-full py-5 bg-[var(--primary)] text-[var(--text-on-gradient)] rounded-2xl font-bold flex items-center justify-center gap-3 shadow-lg active:scale-95 transition-transform text-base"><span>‚ú®</span> Buat Budget Cerdas AI</button>
             
             <div class="glass-card p-6">
                 <div class="flex justify-between items-center mb-4">
                     <h3 class="font-bold text-base text-[var(--text-main)]">Tagihan Rutin</h3>
                     <button onclick="openRecurringModal()" class="text-xs font-bold text-[var(--primary)] bg-primary-alpha px-3 py-1.5 rounded-full">+ Tambah</button>
                 </div>
                 <div id="recurring-list" class="space-y-3"></div>
             </div>
             
             <div>
                 <div class="flex justify-between items-center mb-4">
                     <h3 class="font-bold text-base text-[var(--text-main)]">Kategori Budget</h3>
                     <button onclick="toggleModal('budget-modal', true)" class="text-xs font-bold text-[var(--primary)]">+ Tambah</button>
                 </div>
                 <div id="budget-list" class="space-y-3"></div>
             </div>
             <div><h3 class="font-bold text-base mb-4 text-[var(--text-main)]">Pengeluaran Tanpa Budget</h3><div id="unbudgeted-list" class="space-y-3"></div></div>
        </div>

        <!-- VIEW: ASET -->
        <div id="view-aset" class="hidden space-y-6">
            <!-- PERBAIKAN UTAMA ASET: Menambahkan style inline agar background gradient mutlak digunakan dan tidak kalah oleh CSS bawaan -->
            <div class="glass-card p-8 border-none" style="background: var(--gradient-main); color: var(--text-on-gradient);">
                <p class="text-xs font-bold uppercase opacity-90 mb-2 tracking-widest">Net Worth</p>
                <h2 id="asset-net-worth" class="text-4xl font-black mb-6">Rp 0</h2>
                <div class="flex gap-2 text-xs font-bold">
                    <span class="px-3 py-1.5 bg-[var(--bg-card)] text-[var(--text-main)] rounded-full shadow-sm">Total Aset: <span id="asset-count">0</span></span>
                </div>
            </div>
            <div>
                <h3 class="font-bold text-base mb-4 text-[var(--text-main)]">Komposisi Aset</h3>
                <div id="asset-composition" class="space-y-4 text-[var(--text-main)]"></div>
            </div>
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-base text-[var(--text-main)]">Daftar Aset</h3>
                    <button onclick="toggleModal('asset-modal', true)" class="text-xs font-bold text-[var(--primary)]">+ Tambah</button>
                </div>
                <div id="asset-list" class="space-y-3 pb-24 text-[var(--text-main)]"></div>
            </div>
        </div>

        <!-- VIEW: DOMPET -->
        <div id="view-dompet" class="hidden space-y-8">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-black font-heading text-[var(--text-main)]">Dompet Saya</h2><button onclick="toggleModal('wallet-modal', true)" class="w-10 h-10 bg-[var(--primary)] text-[var(--text-on-gradient)] rounded-xl font-bold shadow-lg">+</button></div>
            <div><h3 class="text-xs font-bold uppercase text-[var(--text-muted)] mb-4 tracking-wider">Saldo & Tabungan</h3><div id="wallet-list-cash" class="space-y-4"></div></div>
            <div><h3 class="text-xs font-bold uppercase text-[var(--text-muted)] mb-4 tracking-wider flex justify-between"><span>Kartu Kredit</span><span class="text-[var(--text-negative)]" id="total-debt">Utang: Rp 0</span></h3><div id="wallet-list-credit" class="space-y-4"></div></div>
        </div>

        <!-- VIEW: GOALS -->
        <div id="view-goals" class="hidden space-y-6">
             <div class="flex justify-between items-center"><h2 class="text-2xl font-black font-heading text-[var(--text-main)]">Target Impian</h2><button onclick="toggleModal('goal-modal', true)" class="w-10 h-10 bg-[var(--primary)] text-[var(--text-on-gradient)] rounded-xl font-bold shadow-lg">+</button></div>
             <div id="goals-list-container" class="space-y-5 pb-24 text-[var(--text-main)]"></div>
        </div>
        
        <!-- VIEW: SETTINGS -->
        <div id="view-settings" class="hidden space-y-6 pb-24">
             <!-- Avatar Section -->
             <div class="glass-card p-8 flex flex-col items-center relative">
                 <div class="relative mb-6 cursor-pointer group" onclick="changeAvatar()">
                     <img id="settings-avatar" src="https://ui-avatars.com/api/?name=User&background=random" class="profile-avatar w-28 h-28 border-4 border-[var(--bg-body)] shadow-2xl rounded-full object-cover">
                     <div class="absolute bottom-0 right-0 w-10 h-10 bg-[var(--primary)] rounded-full flex items-center justify-center text-[var(--text-on-gradient)] text-lg shadow-lg border-2 border-[var(--bg-body)] group-hover:scale-110 transition-transform">üì∑</div>
                 </div>
                 <h2 id="settings-name-display" class="text-2xl font-black font-heading text-[var(--text-main)]">User Name</h2>
                 <p id="settings-email-display" class="text-sm text-[var(--text-muted)] font-bold mt-1">user@email.com</p>
                 <input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="previewAvatar(this)">
             </div>
             
             <!-- Akun Section -->
             <div>
                 <h3 class="text-xs font-bold uppercase text-[var(--text-muted)] mb-4 px-2 tracking-widest">Akun</h3>
                 <div class="glass-card p-6 space-y-5">
                     <div><label class="text-[11px] font-bold uppercase text-[var(--text-muted)] block mb-2">Nama Tampilan</label><input type="text" id="set-name" class="input-field" placeholder="Nama Anda"></div>
                     <div><label class="text-[11px] font-bold uppercase text-[var(--text-muted)] block mb-2">Email</label><input type="email" id="set-email" class="input-field opacity-70" readonly></div>
                 </div>
             </div>
             
             <!-- Database & Cloud Section (DIKEMBALIKAN UTUH) -->
             <div>
                 <h3 class="text-xs font-bold uppercase text-[var(--text-muted)] mb-4 px-2 tracking-widest">Database & Cloud</h3>
                 <div class="glass-card p-4 flex items-center justify-between cursor-pointer hover:opacity-80 active:scale-95 transition-all border border-[var(--border-color)]" onclick="toggleModal('gsheet-modal', true)">
                     <div class="flex items-center gap-4">
                         <div class="w-12 h-12 rounded-2xl bg-positive-alpha flex items-center justify-center text-[var(--text-positive)] text-2xl shadow-sm">üìä</div>
                         <div>
                             <p class="text-sm font-bold text-[var(--text-main)]">Google Sheets Sync</p>
                             <p class="text-[11px] font-bold text-[var(--text-negative)] opacity-70 mt-0.5" id="gsheet-status-preview">Belum Terhubung</p>
                         </div>
                     </div>
                     <span class="text-xl text-[var(--text-muted)]">‚Ä∫</span>
                 </div>
             </div>
             
             <!-- Tema & Tampilan Section -->
             <div>
                 <h3 class="text-xs font-bold uppercase text-[var(--text-muted)] mb-4 px-2 tracking-widest">Tema & Tampilan</h3>
                 <div class="glass-card p-6 space-y-4">
                     <div class="grid grid-cols-5 gap-3">
                         <div class="theme-option active" id="theme-opt-neon" onclick="setThemeOption('neon')"><div class="theme-preview bg-gradient-to-r from-indigo-500 to-purple-500"></div><p class="text-[10px] font-bold mt-2 text-[var(--text-main)]">Neon</p></div>
                         <div class="theme-option" id="theme-opt-pastel-enerjik" onclick="setThemeOption('pastel-enerjik')"><div class="theme-preview bg-gradient-to-r from-pink-400 to-yellow-300"></div><p class="text-[10px] font-bold mt-2 text-[var(--text-main)]">Pop</p></div>
                         <div class="theme-option" id="theme-opt-earth" onclick="setThemeOption('earth')"><div class="theme-preview bg-gradient-to-r from-[#606c38] to-[#bc6c25]"></div><p class="text-[10px] font-bold mt-2 text-[var(--text-main)]">Earth</p></div>
                         <div class="theme-option" id="theme-opt-iridescent" onclick="setThemeOption('iridescent')"><div class="theme-preview bg-gradient-to-r from-cyan-400 to-fuchsia-500"></div><p class="text-[10px] font-bold mt-2 text-[var(--text-main)]">Holo</p></div>
                         <div class="theme-option" id="theme-opt-pastel" onclick="setThemeOption('pastel')"><div class="theme-preview bg-gradient-to-r from-slate-400 to-slate-300"></div><p class="text-[10px] font-bold mt-2 text-[var(--text-main)]">Soft</p></div>
                     </div>
                 </div>
             </div>
             <button onclick="saveSettings()" class="w-full py-5 bg-[var(--primary)] text-[var(--text-on-gradient)] rounded-2xl font-bold text-lg shadow-xl active:scale-95 transition-transform mt-4">Simpan Perubahan</button>
        </div>
    </div>

    <!-- FAB ADD BUTTON (DIPERBARUI) -->
    <div id="fab-container" class="fab-btn" onclick="toggleModal('add-method-modal', true)">+</div>

  </main>

  <!-- MODALS -->
  <!-- NEW MODAL: PILIH METODE TRANSAKSI -->
  <div id="add-method-modal" class="modal-overlay">
      <div class="modal-sheet">
          <div class="flex justify-between items-center mb-6 border-b border-[var(--border-color)] pb-4">
              <h2 class="text-xl font-black font-heading text-[var(--text-main)]">Pilih Metode</h2>
              <button onclick="toggleModal('add-method-modal', false)" class="p-2 bg-[var(--input-bg)] rounded-full font-bold text-[var(--text-muted)] hover:text-[var(--text-negative)] transition-colors w-10 h-10 flex items-center justify-center">‚úï</button>
          </div>
          
          <div class="space-y-4">
              <!-- Input Manual -->
              <div class="glass-card p-4 flex items-center justify-between cursor-pointer hover:opacity-80 active:scale-95 transition-all border border-[var(--border-color)]" onclick="toggleModal('add-method-modal', false); switchView('add-tx');">
                  <div class="flex items-center gap-4">
                      <div class="w-12 h-12 rounded-2xl bg-primary-alpha text-[var(--primary)] flex items-center justify-center text-2xl shadow-sm">üìù</div>
                      <div>
                          <p class="text-sm font-bold text-[var(--text-main)]">Input Manual</p>
                          <p class="text-[11px] font-bold text-[var(--text-muted)] opacity-80 mt-0.5">Ketik detail transaksi secara lengkap</p>
                      </div>
                  </div>
                  <span class="text-xl text-[var(--text-muted)]">‚Ä∫</span>
              </div>
              
              <!-- Scan Struk AI -->
              <div class="glass-card p-4 flex items-center justify-between cursor-pointer hover:opacity-80 active:scale-95 transition-all border border-[var(--border-color)]" onclick="toggleModal('add-method-modal', false); openReceiptScanner();">
                  <div class="flex items-center gap-4">
                      <div class="w-12 h-12 rounded-2xl bg-positive-alpha text-[var(--text-positive)] flex items-center justify-center text-2xl shadow-sm">üßæ</div>
                      <div>
                          <p class="text-sm font-bold text-[var(--text-main)]">Scan Struk <span class="bg-[var(--text-positive)] text-[var(--bg-card)] px-1.5 py-0.5 rounded text-[9px] ml-1">AI</span></p>
                          <p class="text-[11px] font-bold text-[var(--text-muted)] opacity-80 mt-0.5">Auto-catat massal dari teks struk belanja</p>
                      </div>
                  </div>
                  <span class="text-xl text-[var(--text-muted)]">‚Ä∫</span>
              </div>

              <!-- Rekam Suara AI -->
              <div class="glass-card p-4 flex items-center justify-between cursor-pointer hover:opacity-80 active:scale-95 transition-all border border-[var(--border-color)]" onclick="toggleModal('add-method-modal', false); startVoiceRecognition();">
                  <div class="flex items-center gap-4">
                      <div class="w-12 h-12 rounded-2xl bg-negative-alpha text-[var(--text-negative)] flex items-center justify-center text-2xl shadow-sm">üé§</div>
                      <div>
                          <p class="text-sm font-bold text-[var(--text-main)]">Rekam Suara <span class="bg-[var(--text-negative)] text-[var(--bg-card)] px-1.5 py-0.5 rounded text-[9px] ml-1">AI</span></p>
                          <p class="text-[11px] font-bold text-[var(--text-muted)] opacity-80 mt-0.5">Catat instan pakai perintah suara lisan</p>
                      </div>
                  </div>
                  <span class="text-xl text-[var(--text-muted)]">‚Ä∫</span>
              </div>
          </div>
      </div>
  </div>

  <div id="date-range-modal" class="modal-overlay">
      <div class="modal-sheet">
          <div class="flex justify-between items-center mb-8 pb-4 border-b border-[var(--border-color)]">
              <span class="text-2xl">üìÖ</span>
              <h2 class="text-xl font-black font-heading text-[var(--text-main)]">Filter Tanggal</h2>
              <button onclick="toggleDateModal(false)" class="w-10 h-10 rounded-full bg-[var(--input-bg)] flex items-center justify-center font-bold text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors">‚úï</button>
          </div>
          <h3 class="text-xs font-black uppercase text-[var(--text-muted)] mb-4">Pilihan Cepat</h3>
          <div class="quick-select-grid">
              <div onclick="selectQuickRange('today')" class="quick-btn" id="qs-today">Hari Ini</div>
              <div onclick="selectQuickRange('yesterday')" class="quick-btn" id="qs-yesterday">Kemarin</div>
              <div onclick="selectQuickRange('this_month')" class="quick-btn active" id="qs-this_month">Bulan Ini</div>
              <div onclick="selectQuickRange('last_month')" class="quick-btn" id="qs-last_month">Bulan Lalu</div>
              <div onclick="selectQuickRange('this_year')" class="quick-btn" id="qs-this_year">Tahun Ini</div>
              <div onclick="selectQuickRange('all')" class="quick-btn" id="qs-all">Semua Data</div>
          </div>
          <div style="background-color: var(--input-bg);" class="rounded-3xl p-6 mb-6">
              <div class="flex justify-between items-center mb-6">
                  <button onclick="changeCalMonth(-1)" class="w-8 h-8 flex items-center justify-center font-black text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors">‚Üê</button>
                  <h4 id="cal-header-label" class="text-base font-black uppercase tracking-wide text-[var(--text-main)]">Januari 2026</h4>
                  <button onclick="changeCalMonth(1)" class="w-8 h-8 flex items-center justify-center font-black text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors">‚Üí</button>
              </div>
              <div class="cal-grid" id="cal-grid-body"></div>
          </div>
          <div class="flex gap-4">
              <button onclick="toggleDateModal(false)" class="flex-1 py-4 bg-[var(--input-bg)] text-[var(--text-main)] rounded-2xl font-bold text-sm hover:opacity-80 transition-opacity">Batal</button>
              <button onclick="applyDateFilter()" class="flex-[2] py-4 bg-[var(--primary)] text-[var(--text-on-gradient)] rounded-2xl font-bold text-sm shadow-lg active:scale-95 transition-transform">Terapkan</button>
          </div>
      </div>
  </div>

  <div id="gsheet-modal" class="modal-overlay">
      <div class="modal-sheet">
          <div class="flex justify-between items-center mb-6 border-b border-[var(--border-color)] pb-4">
              <h2 class="text-xl font-black font-heading text-[var(--text-main)]">Integrasi Google Sheets</h2>
              <button onclick="toggleModal('gsheet-modal', false)" class="p-2 bg-[var(--input-bg)] rounded-full font-bold text-[var(--text-muted)] hover:text-[var(--text-negative)] transition-colors w-10 h-10 flex items-center justify-center">‚úï</button>
          </div>
          
          <div class="space-y-6">
              <!-- Status Koneksi -->
              <div class="flex justify-between items-center bg-[var(--input-bg)] p-4 rounded-2xl border border-[var(--border-glass)]">
                  <span class="text-sm font-bold text-[var(--text-muted)]">Status Koneksi</span>
                  <div id="gsheet-status-indicator" class="flex items-center gap-2 text-sm font-bold">
                      <span class="text-lg">‚ùå</span> <span class="text-[var(--text-negative)]">Tidak Terhubung</span>
                  </div>
              </div>

              <!-- Field URL -->
              <div class="space-y-2">
                  <label class="text-xs font-bold uppercase tracking-widest text-[var(--text-muted)] ml-1">URL Tersimpan</label>
                  <input type="text" id="gsheet-url-display" class="input-field text-sm opacity-60 cursor-not-allowed bg-[var(--input-bg)]" readonly placeholder="https://script.google.com/macros/s/...">
              </div>
              
              <!-- Tombol Aksi -->
              <div class="flex flex-col gap-3">
                   <button id="btn-edit-url" onclick="toggleEditUrl()" class="w-full py-4 bg-[var(--input-bg)] text-[var(--text-main)] border border-[var(--border-color)] rounded-2xl font-bold text-sm hover:brightness-95 transition-all">Edit URL Apps Script</button>
                   <button onclick="syncToGsheet()" class="w-full py-4 bg-[var(--text-positive)] text-white rounded-2xl font-bold text-sm shadow-lg active:scale-95 transition-transform">Sinkronkan ke Google Sheets</button>
                   <button onclick="loadFromGsheet()" class="w-full py-4 bg-[var(--primary)] text-[var(--text-on-gradient)] rounded-2xl font-bold text-sm shadow-lg active:scale-95 transition-transform">Muat dari Google Sheets</button>
              </div>

              <!-- Info -->
              <div class="bg-[var(--input-bg)] p-5 rounded-2xl border border-[var(--border-glass)]">
                  <h4 class="text-xs font-bold text-[var(--text-main)] uppercase tracking-widest mb-3">Catatan Penting:</h4>
                  <ul class="text-xs text-[var(--text-muted)] space-y-2 list-disc pl-4 marker:text-[var(--primary)]">
                      <li>URL hanya perlu disimpan sekali.</li>
                      <li>URL tersimpan secara permanen di perangkat.</li>
                      <li>Edit URL hanya jika ada update Apps Script.</li>
                      <li>Data akan otomatis tersinkronisasi.</li>
                  </ul>
              </div>

              <details class="group bg-[var(--input-bg)] rounded-2xl border border-[var(--border-glass)] overflow-hidden">
                  <summary class="p-4 font-bold text-sm text-[var(--text-main)] cursor-pointer list-none flex items-center gap-3 select-none">
                      <span class="transition-transform group-open:rotate-90 text-[var(--primary)] text-base">‚ñ∂</span>
                      Panduan Setup Lengkap
                  </summary>
                  <div class="p-4 pt-0 text-xs text-[var(--text-muted)] leading-relaxed border-t border-[var(--border-glass)] mt-2">
                      <ol class="list-decimal pl-4 space-y-3 mt-3">
                          <li>Buka Google Spreadsheet baru.</li>
                          <li>Klik <b>Extensions</b> > <b>Apps Script</b>.</li>
                          <li>Klik tombol <b>Salin Script</b> di bawah & tempelkan.</li>
                          <li>Klik <b>Deploy</b> > <b>New Deployment</b>.</li>
                          <li>Pilih Type: <b>Web App</b>. Execute: <b>Me</b>. Access: <b>Anyone</b>.</li>
                          <li>Salin <b>Web App URL</b> yang diberikan.</li>
                          <li>Klik tombol <b>Edit URL Apps Script</b> di atas dan tempelkan.</li>
                      </ol>
                      <button onclick="copyAppsScriptCode()" class="mt-5 w-full py-3 border-2 border-[var(--primary)] text-[var(--primary)] rounded-xl font-bold text-xs hover:bg-[var(--primary)] hover:text-[var(--text-on-gradient)] transition-all">üìã Salin Script</button>
                  </div>
              </details>
          </div>
      </div>
  </div>

  <!-- MODAL: ADD TRANSACTION (NEW MOBILE-FIRST DESIGN) -->
  <div id="view-add-tx" class="fixed inset-0 z-[2500] p-0 hidden flex-col bg-[var(--bg-body)]">
       <!-- Header dengan efek Glass -->
       <div class="px-6 py-5 border-b border-[var(--border-color)] flex justify-between items-center sticky top-0 z-20 bg-[var(--bg-glass)] backdrop-blur-xl">
          <h2 class="text-xl font-black font-heading tracking-tight text-[var(--text-main)]">Catat Transaksi</h2>
          <button onclick="switchView('home')" class="w-10 h-10 rounded-full bg-[var(--input-bg)] flex items-center justify-center font-bold text-[var(--text-muted)] hover:text-[var(--text-negative)] transition-colors shadow-sm">‚úï</button>
      </div>
      
      <div class="flex-1 overflow-y-auto no-scrollbar p-6 space-y-6 pb-32">
          
          <!-- 1. Type Selector (Horizontal Scrollable Pills) -->
          <div class="glass-card p-2 flex gap-2 overflow-x-auto no-scrollbar">
              <div onclick="setTxTypeNew('income')" id="pill-income" class="tx-type-pill shrink-0 whitespace-nowrap">Pemasukan</div>
              <div onclick="setTxTypeNew('expense')" id="pill-expense" class="tx-type-pill active shrink-0 whitespace-nowrap">Pengeluaran</div>
              <div onclick="setTxTypeNew('saving')" id="pill-saving" class="tx-type-pill shrink-0 whitespace-nowrap">Tabungan</div>
              <div onclick="setTxTypeNew('investment')" id="pill-investment" class="tx-type-pill shrink-0 whitespace-nowrap">Investasi</div>
          </div>

          <!-- 2. Big Amount Input Card -->
          <div class="glass-card p-8 flex flex-col items-center justify-center text-center relative overflow-hidden bg-primary-alpha">
              <p class="text-xs font-bold uppercase tracking-widest text-[var(--primary)] mb-4">Nominal Transaksi</p>
              <div class="flex items-center justify-center gap-3 w-full">
                  <span class="text-3xl font-bold opacity-50 text-[var(--primary)]">Rp</span>
                  <input type="text" id="tx-amount-new" class="bg-transparent border-none text-5xl font-black font-heading text-[var(--text-main)] outline-none w-full text-left" style="max-width: 220px;" placeholder="0" oninput="formatInputRibuan(this)">
              </div>
          </div>

          <!-- 3. Category Selection Card -->
          <div class="glass-card p-6">
               <div class="flex justify-between items-center mb-5">
                   <h3 class="text-xs font-bold uppercase tracking-widest text-[var(--text-muted)]">Pilih Kategori</h3>
                   <button onclick="openAddCategoryModal()" class="text-xs font-bold bg-primary-alpha text-[var(--primary)] px-3 py-1.5 rounded-full hover:opacity-80 transition-colors shadow-sm">+ Kategori Baru</button>
               </div>
               <div id="cat-grid-container" class="grid grid-cols-4 gap-3"></div>
          </div>

          <!-- 4. Details Card (One-Column Mobile Layout) -->
          <div class="glass-card p-6 space-y-6">
              <!-- Tanggal -->
              <div>
                  <label class="text-xs font-bold uppercase tracking-widest text-[var(--text-muted)] block mb-3">Tanggal</label>
                  <input type="date" id="tx-date-new" class="input-field w-full">
              </div>
              <!-- Sumber Dana -->
              <div>
                   <label class="text-xs font-bold uppercase tracking-widest text-[var(--text-muted)] block mb-3">Sumber Dana</label>
                   <select id="pay-select" class="input-field appearance-none hidden"></select>
                   <div id="pay-grid-container" class="flex gap-3 overflow-x-auto pb-2 no-scrollbar"></div>
              </div>
              <!-- Catatan -->
              <div>
                   <label class="text-xs font-bold uppercase tracking-widest text-[var(--text-muted)] block mb-3">Catatan (Opsional)</label>
                   <input type="text" id="tx-desc-new" placeholder="Tulis rincian transaksi..." class="input-field w-full">
              </div>
          </div>
      </div>

      <!-- Sticky Bottom Action Bar -->
      <div class="p-6 border-t border-[var(--border-color)] flex gap-4 bg-[var(--bg-glass)] backdrop-blur-xl absolute bottom-0 w-full z-20">
          <button onclick="switchView('home')" class="flex-1 py-4 bg-[var(--input-bg)] text-[var(--text-main)] rounded-2xl font-bold hover:opacity-80 transition-opacity">Batal</button>
          <button onclick="saveTxNew()" class="flex-[2] py-4 bg-[var(--primary)] text-[var(--text-on-gradient)] rounded-2xl font-bold shadow-[0_4px_20px_rgba(168,85,247,0.3)] active:scale-95 transition-transform">Simpan Transaksi</button>
      </div>
  </div>

  <!-- PERBAIKAN: Menambahkan z-[2600] agar muncul di atas layar Catat Transaksi (z-[2500]) -->
  <div id="modal-add-category" class="modal-overlay z-[2600]">
      <div class="modal-sheet">
          <div class="flex justify-between items-center mb-8">
              <h3 class="text-xl font-black font-heading text-center text-[var(--text-main)]">Tambah Kategori</h3>
              <button onclick="closeAddCategoryModal()" class="p-2 bg-[var(--input-bg)] text-[var(--text-muted)] rounded-full font-bold hover:text-[var(--text-negative)] transition-colors w-10 h-10 flex items-center justify-center">‚úï</button>
          </div>
          <div class="flex gap-4 mb-6">
              <input type="text" id="new-cat-emoji" class="w-24 text-center text-4xl border-2 border-[var(--border-color)] rounded-3xl py-4 focus:border-indigo-500 outline-none bg-[var(--input-bg)] text-[var(--text-main)]" placeholder="‚ú®">
              <input type="text" id="new-cat-name" class="flex-1 border-2 border-[var(--border-color)] rounded-3xl px-6 py-4 font-bold text-lg focus:border-indigo-500 outline-none bg-[var(--input-bg)] text-[var(--text-main)]" placeholder="Nama Kategori">
          </div>
          <div class="flex gap-4">
              <button onclick="closeAddCategoryModal()" class="flex-1 py-4 bg-[var(--input-bg)] text-[var(--text-main)] font-bold rounded-2xl hover:opacity-80 transition-opacity">Batal</button>
              <button onclick="saveNewCategoryCustom()" class="flex-1 py-4 bg-[var(--primary)] text-[var(--text-on-gradient)] font-bold rounded-2xl shadow-lg active:scale-95 transition-transform">Simpan</button>
          </div>
      </div>
  </div>
  
  <div id="forecast-modal" class="modal-overlay">
      <div class="modal-sheet">
          <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-black font-heading text-[var(--text-main)]">Estimasi Target</h2>
              <button onclick="toggleModal('forecast-modal', false)" class="p-2 bg-[var(--input-bg)] text-[var(--text-muted)] hover:text-[var(--text-negative)] rounded-full font-bold transition-colors w-10 h-10 flex items-center justify-center">‚úï</button>
          </div>
          <div class="glass-card p-6 mb-6">
              <h3 id="forecast-title" class="font-bold text-xl mb-1 text-[var(--text-main)]">Nama Goal</h3>
              <p class="text-sm opacity-60 text-[var(--text-muted)]">Proyeksi tabungan bulanan.</p>
              <div class="mt-6 h-48 w-full flex items-end justify-between px-2 gap-2" id="forecast-chart"></div>
              <div class="flex justify-between mt-3 text-xs opacity-60 font-bold text-[var(--text-muted)]"><span>Sekarang</span><span>Target</span></div>
          </div>
          <div class="bg-primary-alpha p-6 rounded-3xl text-center">
              <p class="text-xs font-bold text-[var(--primary)] uppercase tracking-widest">Estimasi Waktu</p>
              <h2 id="forecast-time" class="text-3xl font-black text-[var(--primary)] my-2">0 Bulan</h2>
              <p class="text-xs text-[var(--text-main)] opacity-80">Dengan menabung rutin <span id="forecast-saving" class="font-bold">Rp 0</span>/bulan</p>
          </div>
      </div>
  </div>
  
  <div id="receipt-modal" class="modal-overlay">
      <div class="modal-sheet">
          <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-black font-heading text-[var(--text-main)]">Scan Struk (AI)</h2>
              <button onclick="toggleModal('receipt-modal', false)" class="p-2 bg-[var(--input-bg)] text-[var(--text-muted)] rounded-full font-bold">‚úï</button>
          </div>
          <p class="text-sm opacity-70 mb-4 leading-relaxed text-[var(--text-main)]">Paste teks dari struk belanja Anda di sini. AI akan otomatis memecahnya menjadi beberapa transaksi.</p>
          <textarea id="receipt-text" class="input-field h-40 mb-6 font-mono text-sm" placeholder="Contoh: &#10;Roti Tawar 15000&#10;Sabun Mandi 25000"></textarea>
          <button onclick="processReceipt()" class="w-full py-4 bg-[var(--primary)] text-[var(--text-on-gradient)] rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">Proses Struk Sekarang</button>
      </div>
  </div>
  
  <div id="recurring-modal" class="modal-overlay">
      <div class="modal-sheet">
          <h2 class="text-xl font-black font-heading mb-6 text-[var(--text-main)]">Tambah Tagihan Rutin</h2>
          <div class="space-y-4 mb-6">
              <input id="rec-name" class="input-field" placeholder="Nama Tagihan (e.g. Netflix)">
              <input id="rec-amount" class="input-field" type="number" placeholder="Nominal (Rp)">
              <div class="grid grid-cols-2 gap-4">
                  <input id="rec-date" class="input-field" type="number" min="1" max="31" placeholder="Tgl (1-31)">
                  <select id="rec-cat" class="input-field"><option value="Tagihan">Tagihan</option><option value="Hiburan">Hiburan</option><option value="Rumah">Rumah</option></select>
              </div>
          </div>
          <button onclick="saveRecurring()" class="w-full py-4 bg-[var(--primary)] text-[var(--text-on-gradient)] rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">Simpan Tagihan</button>
          <button onclick="toggleModal('recurring-modal', false)" class="mt-3 w-full py-4 bg-[var(--input-bg)] text-[var(--text-main)] rounded-2xl font-bold hover:opacity-80 transition-opacity">Batal</button>
      </div>
  </div>
  
  <div id="metric-info-modal" class="modal-overlay">
      <div class="modal-sheet">
          <div class="flex justify-between items-center mb-6">
               <h3 class="text-xl font-black font-heading text-[var(--text-main)]" id="metric-info-title">Judul Metrik</h3>
               <button onclick="closeMetricInfo()" class="p-2 bg-[var(--input-bg)] text-[var(--text-muted)] rounded-full font-bold w-10 h-10 flex items-center justify-center hover:text-[var(--text-negative)] transition-colors">‚úï</button>
          </div>
          <div class="bg-[var(--input-bg)] p-6 rounded-3xl mb-6">
            <p class="text-sm text-[var(--text-main)] leading-relaxed font-medium" id="metric-info-desc">Deskripsi.</p>
          </div>
          <button onclick="closeMetricInfo()" class="w-full py-4 bg-[var(--primary)] text-[var(--text-on-gradient)] font-bold rounded-2xl active:scale-95 transition-transform">Mengerti</button>
      </div>
  </div>

  <div id="report-modal" class="modal-overlay">
      <div class="modal-sheet">
          <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-black font-heading text-[var(--text-main)]">Laporan Keuangan</h2>
              <button onclick="toggleModal('report-modal', false)" class="p-2 bg-[var(--input-bg)] rounded-full font-bold text-[var(--text-muted)] hover:text-[var(--text-negative)] transition-colors w-10 h-10 flex items-center justify-center">‚úï</button>
          </div>
          
          <div class="space-y-8">
              <div>
                  <h3 class="text-xs font-bold text-[var(--text-muted)] mb-3 uppercase tracking-widest ml-1">Wawasan Cerdas</h3>
                  <div id="report-insights" class="flex gap-4 overflow-x-auto pb-4 no-scrollbar snap-x text-[var(--text-main)]"></div>
              </div>

              <div>
                  <h3 class="text-xs font-bold text-[var(--text-muted)] mb-3 uppercase tracking-widest ml-1">Kesehatan Finansial</h3>
                  <div class="glass-card p-6 text-center border border-[var(--border-color)] text-[var(--text-main)]">
                      <div class="relative flex justify-center items-center mb-4">
                          <svg viewBox="0 0 100 100" class="w-32 h-32">
                              <circle cx="50" cy="50" r="40" stroke="var(--border-color)" stroke-width="10" fill="none" opacity="0.3"/>
                              <circle id="report-score-ring" cx="50" cy="50" r="40" stroke="var(--primary)" stroke-width="10" fill="none" stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="251.2" class="transition-all duration-1000 origin-center -rotate-90" />
                          </svg>
                          <div class="absolute flex flex-col items-center">
                              <span id="report-score-val" class="text-4xl font-black font-heading">0</span>
                              <span class="text-[10px] text-[var(--text-muted)] font-bold uppercase tracking-widest">Skor</span>
                          </div>
                      </div>
                      <p id="report-score-text" class="text-lg font-bold text-[var(--primary)] mb-6">Menghitung...</p>
                      
                      <div class="grid grid-cols-3 gap-2 text-center border-t border-[var(--border-glass)] pt-4">
                          <div><p class="text-[9px] uppercase text-[var(--text-muted)] font-bold mb-1 tracking-wider">Tabungan</p><p id="score-sav" class="text-sm font-black">0%</p></div>
                          <div><p class="text-[9px] uppercase text-[var(--text-muted)] font-bold mb-1 tracking-wider">Disiplin</p><p id="score-bud" class="text-sm font-black">0%</p></div>
                          <div><p class="text-[9px] uppercase text-[var(--text-muted)] font-bold mb-1 tracking-wider">Keamanan</p><p id="score-sec" class="text-sm font-black">0 Bln</p></div>
                      </div>
                  </div>
              </div>

              <div>
                  <h3 class="text-xs font-bold text-[var(--text-muted)] mb-3 uppercase tracking-widest ml-1">Performa Anggaran</h3>
                  <div id="report-budget-list" class="space-y-4 text-[var(--text-main)]"></div>
              </div>
          </div>

          <button onclick="toggleModal('report-modal', false)" class="mt-8 w-full py-4 bg-[var(--input-bg)] text-[var(--text-main)] rounded-2xl font-bold hover:opacity-80 active:scale-95 transition-all">Tutup Laporan</button>
      </div>
  </div>

  <div id="asset-modal" class="modal-overlay">
      <div class="modal-sheet">
          <h2 class="text-xl font-black mb-6 text-[var(--text-main)]">Kelola Aset</h2>
          <div class="space-y-4 mb-6">
              <input id="asset-name" class="input-field" placeholder="Nama Aset">
              <div class="flex gap-2">
                  <select id="asset-type" class="input-field flex-1"><option>Tunai & Tabungan</option><option>Investasi</option><option>Properti</option></select>
                  <button onclick="toggleCustomInput('asset-type')" class="w-14 bg-[var(--input-bg)] text-[var(--text-main)] rounded-2xl font-bold">‚úèÔ∏è</button>
              </div>
              <input id="asset-val" class="input-field" type="number" placeholder="Nilai (Rp)">
          </div>
          <button onclick="saveAsset()" class="w-full py-4 bg-[var(--primary)] text-[var(--text-on-gradient)] rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">Simpan</button>
          <button onclick="toggleModal('asset-modal', false)" class="mt-3 w-full py-4 bg-[var(--input-bg)] text-[var(--text-main)] rounded-2xl font-bold hover:opacity-80 transition-opacity">Batal</button>
      </div>
  </div>
  
  <div id="wallet-modal" class="modal-overlay">
      <div class="modal-sheet">
          <h2 class="text-xl font-black mb-6 text-[var(--text-main)]">Kelola Dompet</h2>
          <div class="space-y-4 mb-6">
              <input id="wallet-name" class="input-field" placeholder="Nama Dompet">
              <input id="wallet-bal" class="input-field" type="number" placeholder="Saldo Awal">
              <div class="flex gap-2">
                  <select id="wallet-type" class="input-field flex-1"><option value="Cash">Cash</option><option value="Bank">Bank</option><option value="Credit">Kartu Kredit</option><option value="E-Wallet">E-Wallet</option></select>
                  <button onclick="toggleCustomInput('wallet-type')" class="w-14 bg-[var(--input-bg)] text-[var(--text-main)] rounded-2xl font-bold">‚úèÔ∏è</button>
              </div>
          </div>
          <button onclick="saveWallet()" class="w-full py-4 bg-[var(--primary)] text-[var(--text-on-gradient)] rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">Simpan</button>
          <button onclick="toggleModal('wallet-modal', false)" class="mt-3 w-full py-4 bg-[var(--input-bg)] text-[var(--text-main)] rounded-2xl font-bold hover:opacity-80 transition-opacity">Batal</button>
      </div>
  </div>
  
  <div id="budget-modal" class="modal-overlay">
      <div class="modal-sheet">
          <h2 class="text-xl font-black mb-6 text-[var(--text-main)]">Kelola Budget</h2>
          <div class="space-y-4 mb-6">
              <input id="budget-cat" class="input-field" placeholder="Kategori (Misal: Makan)">
              <input id="budget-limit" class="input-field" type="number" placeholder="Limit Bulanan (Rp)">
          </div>
          <button onclick="saveBudget()" class="w-full py-4 bg-[var(--primary)] text-[var(--text-on-gradient)] rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">Simpan</button>
          <button onclick="toggleModal('budget-modal', false)" class="mt-3 w-full py-4 bg-[var(--input-bg)] text-[var(--text-main)] rounded-2xl font-bold hover:opacity-80 transition-opacity">Batal</button>
      </div>
  </div>
  
  <div id="goal-modal" class="modal-overlay">
      <div class="modal-sheet">
          <h2 class="text-xl font-black mb-6 text-[var(--text-main)]">Kelola Goals</h2>
          <div class="space-y-4 mb-6">
              <input id="goal-name" class="input-field" placeholder="Nama Target">
              <input id="goal-target" class="input-field" type="number" placeholder="Nominal Target (Rp)">
              <input id="goal-current" class="input-field" type="number" placeholder="Terkumpul (Rp)">
              <input id="goal-date" class="input-field" type="date">
          </div>
          <button onclick="saveGoal()" class="w-full py-4 bg-[var(--primary)] text-[var(--text-on-gradient)] rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">Simpan</button>
          <button onclick="toggleModal('goal-modal', false)" class="mt-3 w-full py-4 bg-[var(--input-bg)] text-[var(--text-main)] rounded-2xl font-bold hover:opacity-80 transition-opacity">Batal</button>
      </div>
  </div>

<script>
    /* --- DATA STORE & STATE --- */
    const DB_KEY = 'finz_data_ultimate_v3'; 
    
    // Injeksi Data Demo untuk testing yang komprehensif saat baru dibuka / localStorage kosong
    const DEMO_DATA_FALLBACK = {
      "user": null, // <-- PERBAIKAN: Nilai diubah menjadi null agar Navigation Guard mencegah akses ke dashboard
      "settings": { "theme": "neon", "gsheet_url": "", "isDarkMode": true },
      "wallets": [
        { "id": "w1", "name": "BCA Utama", "type": "Bank", "balance": 12500000 },
        { "id": "w2", "name": "Gopay", "type": "E-Wallet", "balance": 450000 },
        { "id": "w3", "name": "Dompet Tunai", "type": "Cash", "balance": 150000 },
        { "id": "w4", "name": "CC BCA", "type": "Credit", "balance": -3200000 }
      ],
      "assets": [
        { "id": "a1", "name": "Reksadana Sucor", "value": 15000000, "type": "Investasi" },
        { "id": "a2", "name": "Emas Antam 10g", "value": 12000000, "type": "Investasi" },
        { "id": "a3", "name": "Honda Scoopy", "value": 18000000, "type": "Properti" }
      ],
      "goals": [
        { "id": "g1", "name": "Dana Darurat", "target": 20000000, "current": 12000000, "date": "2026-12-31" },
        { "id": "g2", "name": "Beli iPhone 15", "target": 15000000, "current": 13500000, "date": "2026-03-15" },
        { "id": "g3", "name": "Liburan Bali", "target": 5000000, "current": 5000000, "date": "2026-02-28" },
        { "id": "g4", "name": "DP Rumah", "target": 100000000, "current": 5000000, "date": "2029-01-01" }
      ],
      "budget": [
        { "cat": "Makan", "limit": 3000000 },
        { "cat": "Transport", "limit": 1000000 },
        { "cat": "Belanja", "limit": 1500000 },
        { "cat": "Hiburan", "limit": 1000000 }
      ],
      "custom_cats": {
        "income": [],
        "expense": [ { "n": "Cicilan", "i": "üí≥" }, { "n": "Kopi", "i": "‚òï" } ],
        "saving": [],
        "investment": [ { "n": "Crypto", "i": "ü™ô" } ]
      },
      "recurring": [
        { "id": 101, "name": "Netflix", "amount": 153000, "day": 15, "cat": "Hiburan", "lastPaidMonth": "" },
        { "id": 102, "name": "Internet Indihome", "amount": 350000, "day": 5, "cat": "Tagihan", "lastPaidMonth": "" }
      ],
      "tx": [
        { "id": 1, "type": "income", "amount": 10000000, "cat": "Gaji", "payment": "BCA Utama", "date": "2026-02-01", "desc": "Gaji Februari 2026" },
        { "id": 2, "type": "expense", "amount": 1350000, "cat": "Belanja", "payment": "CC BCA", "date": "2026-02-02", "desc": "Belanja Bulanan Supermarket" },
        { "id": 3, "type": "expense", "amount": 350000, "cat": "Tagihan", "payment": "BCA Utama", "date": "2026-02-05", "desc": "Internet Rumah" },
        { "id": 4, "type": "expense", "amount": 400000, "cat": "Transport", "payment": "Gopay", "date": "2026-02-10", "desc": "Isi Bensin Mobil" },
        { "id": 5, "type": "expense", "amount": 400000, "cat": "Transport", "payment": "Gopay", "date": "2026-02-15", "desc": "Isi Bensin Mobil" },
        { "id": 6, "type": "expense", "amount": 400000, "cat": "Transport", "payment": "Gopay", "date": "2026-02-20", "desc": "Isi Bensin Mobil (Overbudget trigger)" },
        { "id": 7, "type": "expense", "amount": 153000, "cat": "Hiburan", "payment": "CC BCA", "date": "2026-02-15", "desc": "Langganan Netflix" },
        { "id": 8, "type": "expense", "amount": 500000, "cat": "Makan", "payment": "Dompet Tunai", "date": "2026-02-18", "desc": "Makan siang kantor seminggu" },
        { "id": 9, "type": "expense", "amount": 1500000, "cat": "Makan", "payment": "BCA Utama", "date": "2026-02-22", "desc": "Traktir keluarga weekend" },
        { "id": 10, "type": "saving", "amount": 2000000, "cat": "Tabungan", "payment": "BCA Utama", "date": "2026-02-25", "desc": "Transfer ke rekening tabungan" },
        { "id": 11, "type": "investment", "amount": 1000000, "cat": "Reksadana", "payment": "BCA Utama", "date": "2026-02-26", "desc": "Auto debet Sucor" },
        { "id": 12, "type": "expense", "amount": 45000, "cat": "Kopi", "payment": "Gopay", "date": "2026-02-26", "desc": "Kopi Susu Gula Aren" },
        { "id": 13, "type": "income", "amount": 10000000, "cat": "Gaji", "payment": "BCA Utama", "date": "2026-01-01", "desc": "Gaji Januari 2026" },
        { "id": 14, "type": "income", "amount": 3000000, "cat": "Bonus", "payment": "BCA Utama", "date": "2026-01-15", "desc": "Bonus Tahunan" },
        { "id": 15, "type": "expense", "amount": 2500000, "cat": "Belanja", "payment": "CC BCA", "date": "2026-01-20", "desc": "Beli Sepatu" },
        { "id": 16, "type": "expense", "amount": 900000, "cat": "Transport", "payment": "Gopay", "date": "2026-01-10", "desc": "Transportasi Januari" },
        { "id": 17, "type": "saving", "amount": 3000000, "cat": "Darurat", "payment": "BCA Utama", "date": "2026-01-25", "desc": "Nabung Dana Darurat" },
        { "id": 18, "type": "expense", "amount": 1200000, "cat": "Makan", "payment": "Gopay", "date": "2026-01-12", "desc": "Makan harian" },
        { "id": 19, "type": "income", "amount": 10000000, "cat": "Gaji", "payment": "BCA Utama", "date": "2025-12-01", "desc": "Gaji Desember 2025" },
        { "id": 20, "type": "expense", "amount": 4500000, "cat": "Hiburan", "payment": "CC BCA", "date": "2025-12-25", "desc": "Staycation Akhir Tahun" }
      ]
    };

    let data = JSON.parse(localStorage.getItem(DB_KEY)) || DEMO_DATA_FALLBACK;
    
    let currentTxType = 'expense';
    let selectedCat = '';
    let selectedPay = 'Cash';
    let filterPeriod = 'this_month';
    let currentTxFilter = 'all'; 
    let calDate = new Date();
    let rangeStart = null;
    let rangeEnd = null;
    let editingId = null; 
    let isEditingUrl = false; 
    let loginFailedAttempts = 0;
    let expenseChartInstance = null;
    
    const BASE_CATS = {
        income: [{n:'Gaji', i:'üíº'}, {n:'Bonus', i:'üéÅ'}, {n:'Hadiah', i:'üßß'}, {n:'Lainnya', i:'‚ú®'}],
        expense: [{n:'Makan', i:'üçΩÔ∏è'}, {n:'Transport', i:'üöó'}, {n:'Belanja', i:'üõí'}, {n:'Tagihan', i:'üìÑ'}, {n:'Hiburan', i:'üçø'}, {n:'Kesehatan', i:'üíä'}],
        saving: [{n:'Tabungan', i:'üè¶'}, {n:'Darurat', i:'üÜò'}],
        investment: [{n:'Saham', i:'üìà'}, {n:'Emas', i:'üèÜ'}, {n:'Reksadana', i:'üìä'}]
    };
    const PAY_METHODS = [ {n:'Tunai', i:'üíµ'}, {n:'Transfer', i:'üè¶'}, {n:'E-Wallet', i:'üì±'}, {n:'Kartu Kredit', i:'üí≥'} ];

    function init() {
        if(data.user) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            if(document.getElementById('set-name')) {
                document.getElementById('set-name').value = data.user.name;
                document.getElementById('set-email').value = data.user.email;
                document.getElementById('settings-name-display').innerText = data.user.name;
                document.getElementById('settings-email-display').innerText = data.user.email;
                document.getElementById('user-greet').innerText = `Halo, ${data.user.name.split(' ')[0]}`;
                if(data.user.avatar) document.getElementById('settings-avatar').src = data.user.avatar;
                updateGsheetUI();
                const descInput = document.getElementById('tx-desc-new');
                if(descInput) descInput.addEventListener('input', (e) => autoCategorize(e.target.value));
            }
            checkRecurringBills();
            switchView('home');
        } else {
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('auth-section').classList.remove('hidden');
        }
    }

    function setSmartGreeting() {
        const hour = new Date().getHours();
        const day = new Date().getDay(); 
        let greeting = "Welcome Back! üëã";
        if (hour >= 5 && hour < 11) greeting = "Pagi Bestie! ‚òÄÔ∏è";
        else if (hour >= 11 && hour < 15) greeting = "Siang Bolong! üå§Ô∏è";
        else if (hour >= 15 && hour < 18) greeting = "Sore Chill! üåá";
        else { if (day === 6) greeting = "Malem Mingguan? üåô"; else greeting = "Malem Vibes! üåô"; }
        const greetEl = document.getElementById('smart-greeting');
        if(greetEl) greetEl.innerText = greeting;
    }

    function initPWA() {
        const manifestData = {
            "name": "FinZ App Ultimate", "short_name": "FinZ", "start_url": ".", "display": "standalone",
            "background_color": "#09090b", "theme_color": "#a855f7",
            "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/3135/3135679.png", "sizes": "512x512", "type": "image/png" }]
        };
        const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
        document.getElementById('dynamic-manifest').setAttribute('href', URL.createObjectURL(manifestBlob));
    }

    // --- NEW: AUTH TAB SWITCHER ---
    function switchAuthTab(tab) {
        const loginForm = document.getElementById('auth-form-login');
        const registerForm = document.getElementById('auth-form-register');
        const btnLogin = document.getElementById('tab-btn-login');
        const btnRegister = document.getElementById('tab-btn-register');
        const greeting = document.getElementById('auth-greeting');

        if (tab === 'login') {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            
            btnLogin.className = 'flex-1 pb-3 text-sm font-bold border-b-2 border-purple-500 text-purple-400 transition-all';
            btnRegister.className = 'flex-1 pb-3 text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-300 transition-all';
            
            // Revert to Smart Greeting (if within time frame) or default
            setSmartGreeting();
        } else {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            
            btnLogin.className = 'flex-1 pb-3 text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-300 transition-all';
            btnRegister.className = 'flex-1 pb-3 text-sm font-bold border-b-2 border-purple-500 text-purple-400 transition-all';
            
            greeting.innerText = 'Join the Squad! üöÄ';
        }
    }

    // --- NEW: HANDLE REGISTER (Simulasi Front-End) ---
    function handleRegister() {
        const name = document.getElementById('reg-name').value;
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-password').value;
        const passConf = document.getElementById('reg-password-confirm').value;

        if(!name || !email || !pass || !passConf) return Swal.fire('Oops!', 'Semua kolom wajib diisi ya Bestie!', 'warning');
        if(pass !== passConf) return Swal.fire('Oops!', 'Password dan konfirmasi tidak cocok!', 'error');

        const btn = document.getElementById('btn-register');
        btn.innerHTML = 'Memproses...'; btn.classList.add('opacity-50');

        setTimeout(() => {
            btn.innerHTML = 'Daftar Sekarang'; btn.classList.remove('opacity-50');
            Swal.fire({
                title: 'Yash! Sukses üéâ', text: 'Akun berhasil dibuat. Silakan login!', icon: 'success',
                background: data.settings.isDarkMode ? '#1e293b' : '#ffffff', color: data.settings.isDarkMode ? '#fff' : '#0f172a',
                confirmButtonColor: '#8b5cf6'
            }).then(() => {
                // Pindah kembali ke tab login & isi email otomatis
                switchAuthTab('login');
                document.getElementById('login-email').value = email;
            });
        }, 1000);
    }

    function handleLogin() { 
        const e = document.getElementById('login-email').value; const p = document.getElementById('login-password').value;
        const btn = document.getElementById('btn-login'); const card = document.getElementById('login-card');
        
        if(!e || !p) return Swal.fire('Oops!', 'Email dan Password wajib diisi ya!', 'warning');
        
        if(e === 'demo@finz.com' && p === 'demo123') {
            btn.innerHTML = 'Loading...'; btn.classList.add('opacity-50');
            setTimeout(() => {
                btn.innerHTML = 'Masuk'; btn.classList.remove('opacity-50');
                Swal.fire({
                    title: 'Slay! üî•', text: 'Welcome back ke dashboard!', icon: 'success',
                    background: data.settings.isDarkMode ? '#1e293b' : '#ffffff', color: data.settings.isDarkMode ? '#fff' : '#0f172a',
                    showConfirmButton: false, timer: 1200 // Pop-up menutup otomatis
                }).then(() => { data.user = {name:'Sarah QA', email:e}; saveData(); init(); });
            }, 800);
        } else {
            loginFailedAttempts++;
            if(loginFailedAttempts >= 3) {
                card.classList.add('glitch-active');
                Swal.fire({ title: 'Bruh üíÄ', text: 'Udah 3x salah nih!', icon: 'error', confirmButtonColor: '#e11d48' });
                setTimeout(() => { card.classList.remove('glitch-active'); }, 500);
                loginFailedAttempts = 0; 
            } else Swal.fire('Salah Kredensial üö©', `Sisa percobaan: ${3 - loginFailedAttempts}`, 'warning');
        }
    }
    
    function fillDemo() { 
        document.getElementById('login-email').value = 'demo@finz.com'; 
        document.getElementById('login-password').value = 'demo123'; 
        handleLogin(); // Auto-submit (langsung login) setelah form terisi
    }
    function handleLogout() { data.user = null; saveData(); location.reload(); }

    function checkRecurringBills() {
        if (!data.recurring) data.recurring = [];
        const today = new Date(); const currentMonth = today.getMonth() + '-' + today.getFullYear();
        let processed = false;
        data.recurring.forEach(bill => {
            if (today.getDate() >= bill.day && bill.lastPaidMonth !== currentMonth) {
                data.tx.push({ id: Date.now()+Math.random(), type: 'expense', amount: bill.amount, cat: bill.cat, payment: 'Tunai', date: today.toISOString().split('T')[0], desc: 'Tagihan: ' + bill.name });
                if(data.wallets[0]) data.wallets[0].balance -= bill.amount;
                bill.lastPaidMonth = currentMonth;
                processed = true;
            }
        });
        if (processed) saveData();
    }

    function toggleDateModal(show) {
        document.getElementById('date-range-modal').classList.toggle('active', show);
        if(show) { renderCalendar(); selectQuickRange(filterPeriod); }
    }
    function renderCalendar() {
        const grid = document.getElementById('cal-grid-body');
        grid.innerHTML = ['M','S','S','R','K','J','S'].map(d=>`<div class="text-[var(--text-muted)] text-xs">${d}</div>`).join('');
        const y = calDate.getFullYear(), m = calDate.getMonth();
        document.getElementById('cal-header-label').innerText = calDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
        for(let i=0; i<new Date(y, m, 1).getDay(); i++) grid.innerHTML += `<div></div>`;
        for(let d=1; d<=new Date(y, m+1, 0).getDate(); d++) {
            const cur = new Date(y, m, d).getTime();
            let cls = 'cal-day';
            if(rangeStart && rangeEnd) {
                if(cur === rangeStart.getTime()) cls += ' range-start';
                else if(cur === rangeEnd.getTime()) cls += ' range-end';
                else if(cur > rangeStart.getTime() && cur < rangeEnd.getTime()) cls += ' in-range';
            } else if (rangeStart && cur === rangeStart.getTime()) cls += ' active';
            grid.innerHTML += `<div class="${cls}" onclick="pickDate(${d})">${d}</div>`;
        }
    }
    function pickDate(d) {
        const picked = new Date(calDate.getFullYear(), calDate.getMonth(), d);
        if(!rangeStart || (rangeStart && rangeEnd)) { rangeStart = picked; rangeEnd = null; } 
        else { if(picked < rangeStart) { rangeEnd = rangeStart; rangeStart = picked; } else { rangeEnd = picked; } }
        filterPeriod = 'custom'; renderCalendar();
    }
    function changeCalMonth(dir) { calDate.setMonth(calDate.getMonth() + dir); renderCalendar(); }
    function selectQuickRange(type) { filterPeriod = type; rangeStart = null; rangeEnd = null; renderCalendar(); }
    function applyDateFilter() {
        const labels = {'this_month':'Bulan Ini', 'last_month':'Bulan Lalu', 'all':'Semua', 'today':'Hari Ini', 'yesterday':'Kemarin', 'this_year':'Tahun Ini', 'custom': 'Custom'};
        document.getElementById('home-period-label').innerText = `Periode ‚Äì ${labels[filterPeriod]}`;
        toggleDateModal(false); renderHome();
    }

    function switchView(view) {
        // 1. Sembunyikan semua panel utama
        ['home','planner','budget','aset','dompet','goals','settings'].forEach(v => {
            const el = document.getElementById('view-'+v); if(el) el.classList.add('hidden');
        });
        
        // 2. Selalu sembunyikan layar Tambah Transaksi
        const addTxView = document.getElementById('view-add-tx');
        if(addTxView) {
            addTxView.classList.add('hidden');
            addTxView.classList.remove('flex');
        }

        // 3. Tampilkan halaman yang dituju
        if(view === 'add-tx') { 
            if(addTxView) { addTxView.classList.remove('hidden'); addTxView.classList.add('flex'); }
            prepareAddTxNew(); 
        } else {
            const active = document.getElementById('view-'+view); if(active) active.classList.remove('hidden');
        }
        
        document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
        const link = document.getElementById('side-'+view); if(link) link.classList.add('active');
        if(document.getElementById('sidebar').classList.contains('active')) toggleSidebar();
        
        if(view === 'home') renderHome();
        if(view === 'planner') renderPlanner();
        if(view === 'budget') renderBudget();
        if(view === 'aset') renderAssets();
        if(view === 'dompet') renderWallets();
        if(view === 'goals') renderGoals();
    }

    function renderExpenseChart() {
        const ctx = document.getElementById('expenseChart');
        if(!ctx) return;
        const labels = []; const dataVals = [];
        const txs = data.tx.filter(t => t.type === 'expense');
        for(let i=6; i>=0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i);
            labels.push(d.toLocaleDateString('id-ID', {weekday:'short'}));
            const dateStr = d.toISOString().split('T')[0];
            dataVals.push(txs.filter(t => t.date === dateStr).reduce((a,b) => a+b.amount, 0));
        }

        const compStyle = getComputedStyle(document.body);
        const gridColor = compStyle.getPropertyValue('--border-glass').trim();
        const textColor = compStyle.getPropertyValue('--text-muted').trim();
        const primaryColor = compStyle.getPropertyValue('--primary').trim();

        if(expenseChartInstance) {
            expenseChartInstance.data.labels = labels;
            expenseChartInstance.data.datasets[0].data = dataVals;
            expenseChartInstance.data.datasets[0].borderColor = primaryColor;
            expenseChartInstance.options.scales.x.ticks.color = textColor;
            expenseChartInstance.options.scales.y.ticks.color = textColor;
            expenseChartInstance.options.scales.y.grid.color = gridColor;
            expenseChartInstance.update();
        } else {
            expenseChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pengeluaran (Rp)', data: dataVals,
                        borderColor: primaryColor, backgroundColor: 'transparent',
                        borderWidth: 3, tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
                        x: { grid: { display: false }, ticks: { color: textColor } }
                    }
                }
            });
        }
    }

    function filterTx(type, btn) {
        currentTxFilter = type; document.querySelectorAll('.filter-chip').forEach(el => el.classList.remove('active'));
        if(btn) btn.classList.add('active'); else if(document.getElementById('chip-'+type)) document.getElementById('chip-'+type).classList.add('active');
        renderHome();
    }
    
    function renderHome() {
        let txs = getFilteredTxs();
        const inc = txs.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0);
        const exp = txs.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0);
        const sav = txs.filter(t=>t.type==='saving').reduce((a,b)=>a+b.amount,0);
        const inv = txs.filter(t=>t.type==='investment').reduce((a,b)=>a+b.amount,0);
        
        document.getElementById('home-balance').innerText = formatRupiah(inc - exp);
        document.getElementById('home-inc').innerText = formatRupiah(inc);
        document.getElementById('home-exp').innerText = formatRupiah(exp);
        document.getElementById('home-sav').innerText = formatRupiah(sav);
        document.getElementById('home-inv').innerText = formatRupiah(inv);

        const totalVol = inc + exp + sav + inv;
        let currentOffset = 0;
        const updateSeg = (id, val, lblId) => {
             const el = document.getElementById(id); const lbl = document.getElementById(lblId);
             const len = totalVol > 0 ? (val / totalVol) * 251.2 : 0; 
             if(el) { el.style.strokeDasharray = `${len} 251.2`; el.style.strokeDashoffset = -currentOffset; }
             if(lbl) lbl.innerText = Math.round(totalVol > 0 ? (val/totalVol)*100 : 0) + '%';
             currentOffset += len;
        };
        updateSeg('d-inc', inc, 'l-inc'); updateSeg('d-exp', exp, 'l-exp'); updateSeg('d-sav', sav, 'l-sav'); updateSeg('d-inv', inv, 'l-inv');

        const top = txs.filter(t => t.type === 'expense').sort((a,b) => b.amount - a.amount)[0];
        document.getElementById('top-expense-val').innerText = top ? formatRupiah(top.amount) : 'Rp 0';
        document.getElementById('top-expense-cat').innerText = top ? top.cat : '-';
        
        const today = new Date(); today.setHours(0,0,0,0);
        const nextWeek = new Date(today); nextWeek.setDate(today.getDate() + 7);
        const bills = data.tx.filter(t => { const d = new Date(t.date); return t.type === 'expense' && d > today && d <= nextWeek; });
        document.getElementById('upcoming-bills-count').innerText = `${bills.length} Tagihan`;

        if(currentTxFilter !== 'all') { txs = txs.filter(t => t.type === currentTxFilter); }
        const list = document.getElementById('tx-list-container');
        if(txs.length === 0) list.innerHTML = '<p class="text-center text-[var(--text-muted)] text-xs py-10">Belum ada transaksi</p>';
        else {
            list.innerHTML = txs.slice().reverse().slice(0,10).map(t => {
                const isInc = t.type==='income'; const isExp = t.type==='expense';
                const colorCls = isInc ? 'text-[var(--text-positive)]' : isExp ? 'text-[var(--text-negative)]' : 'text-[var(--text-main)]';
                return `<div class="glass-card px-4 py-3 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-[var(--input-bg)] flex items-center justify-center">${isInc?'üí∞':isExp?'üí∏':'üè¶'}</div>
                        <div><p class="text-xs font-bold text-[var(--text-main)]">${t.cat}</p><p class="text-[10px] text-[var(--text-muted)]">${t.date}</p></div>
                    </div>
                    <div class="flex items-center gap-3">
                         <p class="text-xs font-black ${colorCls}">${isInc?'+':isExp?'-':''} ${formatRupiah(t.amount)}</p>
                         <div class="flex gap-1">
                             <div onclick="editTx(${t.id})" class="action-btn action-btn-edit">‚úé</div>
                             <div onclick="deleteTx(${t.id})" class="action-btn action-btn-del">üóë</div>
                         </div>
                    </div>
                </div>`;
            }).join('');
        }
        renderExpenseChart();
    }
    
    function getFilteredTxs() {
        const now = new Date();
        if(filterPeriod === 'custom' && rangeStart && rangeEnd) {
            return data.tx.filter(t => { const d = new Date(t.date); const start = new Date(rangeStart); start.setHours(0,0,0,0); const end = new Date(rangeEnd); end.setHours(23,59,59,999); return d >= start && d <= end; });
        }
        if(filterPeriod === 'all') return data.tx;
        return data.tx.filter(t => {
            const d = new Date(t.date);
            if(filterPeriod === 'today') return d.toDateString() === now.toDateString();
            if(filterPeriod === 'yesterday') { const y = new Date(now); y.setDate(y.getDate()-1); return d.toDateString() === y.toDateString(); }
            if(filterPeriod === 'this_month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            if(filterPeriod === 'last_month') { const last = new Date(now.getFullYear(), now.getMonth()-1, 1); return d.getMonth() === last.getMonth() && d.getFullYear() === last.getFullYear(); }
            if(filterPeriod === 'this_year') return d.getFullYear() === now.getFullYear();
            return true;
        });
    }

    function openReportModal() {
        toggleModal('report-modal', true);
        const txs = getFilteredTxs(); 
        const expTxs = txs.filter(t=>t.type==='expense');
        const incTxs = txs.filter(t=>t.type==='income');
        const savTxs = txs.filter(t=>t.type==='saving');
        
        const totalExp = expTxs.reduce((a,b)=>a+b.amount,0);
        const totalInc = incTxs.reduce((a,b)=>a+b.amount,0);
        const totalSav = savTxs.reduce((a,b)=>a+b.amount,0);
        
        const insightsDiv = document.getElementById('report-insights'); 
        if(insightsDiv) {
            insightsDiv.innerHTML = '';
            data.budget.forEach(b => {
                 const used = expTxs.filter(t=>t.cat===b.cat).reduce((a,x)=>a+x.amount,0);
                 const pct = b.limit>0 ? Math.round((used/b.limit)*100) : 0;
                 if(pct > 80) {
                     insightsDiv.innerHTML += `
                     <div class="glass-card p-4 min-w-[220px] max-w-[240px] border-l-4 border-[var(--text-negative)] snap-center shrink-0">
                         <div class="flex items-center gap-2 mb-2"><span class="text-lg">‚ö†Ô∏è</span><p class="text-[10px] font-bold text-[var(--text-negative)] uppercase tracking-wider">Warning Budget</p></div>
                         <p class="text-sm font-black mb-1 truncate text-[var(--text-main)]">${b.cat}</p>
                         <p class="text-xs text-[var(--text-muted)]">${formatRupiah(used)} <span class="font-bold text-[var(--text-negative)]">(${pct}%)</span></p>
                     </div>`;
                 }
            });

            const catsCount = {}; const catsAmount = {};
            expTxs.forEach(t => { catsCount[t.cat] = (catsCount[t.cat]||0) + 1; catsAmount[t.cat] = (catsAmount[t.cat]||0) + t.amount; });
            const topCatFreq = Object.entries(catsCount).sort((a,b)=>b[1]-a[1])[0];
            if(topCatFreq) {
                insightsDiv.innerHTML += `
                <div class="glass-card p-4 min-w-[220px] max-w-[240px] border-l-4 border-[var(--text-info)] snap-center shrink-0">
                     <div class="flex items-center gap-2 mb-2"><span class="text-lg">üõçÔ∏è</span><p class="text-[10px] font-bold text-[var(--text-info)] uppercase tracking-wider">Sering Dibeli</p></div>
                     <p class="text-sm font-black mb-1 truncate text-[var(--text-main)]">${topCatFreq[0]}</p>
                     <p class="text-xs text-[var(--text-muted)]">${topCatFreq[1]}x Transaksi <span class="font-bold text-[var(--text-info)]">(${formatRupiah(catsAmount[topCatFreq[0]])})</span></p>
                </div>`;
            }

            const savRate = totalInc > 0 ? Math.round((totalSav/totalInc)*100) : 0;
            let motivText = savRate >= 20 ? "Target 20% tembus, Slay! ‚ú®" : (savRate > 0 ? "Lumayan, bulan depan gas lagi! üî•" : "Waduh, belum nabung nih bestie! üíÄ");
            let savBorder = savRate >= 20 ? "border-[var(--text-positive)]" : (savRate > 0 ? "border-[var(--text-warning)]" : "border-[var(--text-negative)]");
            let savTextColor = savRate >= 20 ? "text-[var(--text-positive)]" : (savRate > 0 ? "text-[var(--text-warning)]" : "text-[var(--text-negative)]");
            insightsDiv.innerHTML += `
            <div class="glass-card p-4 min-w-[220px] max-w-[240px] border-l-4 ${savBorder} snap-center shrink-0">
                 <div class="flex items-center gap-2 mb-2"><span class="text-lg">üè¶</span><p class="text-[10px] font-bold ${savTextColor} uppercase tracking-wider">Pencapaian Menabung</p></div>
                 <p class="text-sm font-black mb-1 truncate text-[var(--text-main)]">${savRate}% dari Pemasukan</p>
                 <p class="text-xs text-[var(--text-muted)]">${motivText}</p>
            </div>`;
        }
        
        const savRateRaw = totalInc > 0 ? (totalSav/totalInc) : 0;
        let scoreSavCalc = Math.min((savRateRaw / 0.20) * 100, 100) * 0.4;
        let overbudgetCats = 0;
        data.budget.forEach(b => { const used = expTxs.filter(t=>t.cat===b.cat).reduce((a,x)=>a+x.amount,0); if(b.limit > 0 && used > b.limit) overbudgetCats++; });
        let budgetDiscipline = Math.max(0, 100 - (overbudgetCats * 25));
        let scoreBudCalc = budgetDiscipline * 0.4;
        const liquidAssets = data.wallets.filter(w=>w.type!=='Credit').reduce((a,b)=>a+b.balance,0) + totalSav;
        const monthsSafe = liquidAssets / (totalExp > 0 ? totalExp : 1);
        let scoreSecCalc = Math.min((monthsSafe / 6) * 100, 100) * 0.2;

        let finalScore = Math.round(scoreSavCalc + scoreBudCalc + scoreSecCalc);
        if(isNaN(finalScore)) finalScore = 0;
        
        const scoreValEl = document.getElementById('report-score-val'); 
        if(scoreValEl) scoreValEl.innerText = finalScore;
        const ring = document.getElementById('report-score-ring'); 
        if(ring) {
            let color = 'var(--text-positive)';
            if(finalScore < 50) color = 'var(--text-negative)';
            else if(finalScore < 75) color = 'var(--text-warning)';
            ring.style.stroke = color;
            setTimeout(() => { ring.style.strokeDashoffset = 251.2 - ((finalScore/100) * 251.2); }, 100);
            const scoreText = document.getElementById('report-score-text'); 
            if(scoreText) {
                if(finalScore < 50) { scoreText.innerText = 'Bisa Lebih Baik üö®'; scoreText.style.color = 'var(--text-negative)'; }
                else if(finalScore < 75) { scoreText.innerText = 'Cukup Terkendali üëç'; scoreText.style.color = 'var(--text-warning)'; }
                else { scoreText.innerText = 'Sangat Slay! üî•'; scoreText.style.color = 'var(--text-positive)'; }
            }
        }
        const scoreSavEl = document.getElementById('score-sav'); if(scoreSavEl) scoreSavEl.innerText = Math.round(savRateRaw*100) + '%';
        const scoreBudEl = document.getElementById('score-bud'); if(scoreBudEl) scoreBudEl.innerText = budgetDiscipline + '%';
        const scoreSecEl = document.getElementById('score-sec'); if(scoreSecEl) scoreSecEl.innerText = monthsSafe > 10 ? '>10 Bln' : monthsSafe.toFixed(1) + ' Bln';

        const bList = document.getElementById('report-budget-list'); 
        if(bList) {
            bList.innerHTML = '';
            data.budget.forEach(b => {
                 const used = expTxs.filter(t=>t.cat===b.cat).reduce((a,x)=>a+x.amount,0);
                 const pctRaw = b.limit>0 ? (used/b.limit)*100 : 0;
                 const pct = Math.min(pctRaw, 100); 
                 let color = 'bg-[var(--text-positive)]'; 
                 if(pctRaw >= 70 && pctRaw <= 90) color = 'bg-[var(--text-warning)]';
                 else if(pctRaw > 90) color = 'bg-[var(--text-negative)]';

                 bList.innerHTML += `
                 <div class="glass-card p-4">
                     <div class="flex justify-between items-end mb-3">
                         <div>
                             <p class="font-bold text-sm mb-1 text-[var(--text-main)]">${b.cat}</p>
                             <p class="text-[10px] text-[var(--text-muted)] font-bold">${formatRupiah(used)} / ${formatRupiah(b.limit)}</p>
                         </div>
                         <span class="text-lg font-black font-heading text-[var(--text-main)]">${Math.round(pctRaw)}%</span>
                     </div>
                     <div class="w-full h-2.5 bg-[var(--input-bg)] rounded-full overflow-hidden">
                         <div class="${color} h-full rounded-full transition-all duration-1000 ease-out" style="width:0%" data-target-width="${pct}%"></div>
                     </div>
                 </div>`;
            });
            setTimeout(() => { bList.querySelectorAll('[data-target-width]').forEach(bar => { bar.style.width = bar.getAttribute('data-target-width'); }); }, 50);
        }
    }

    function renderPlanner() {
        switchPlannerTab('overview');
        const txs = getFilteredTxs(); 
        const periodInc = txs.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0);
        const periodExp = txs.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0);
        const periodSav = txs.filter(t=>t.type==='saving').reduce((a,b)=>a+b.amount,0);
        
        const liquidAssets = data.wallets.filter(w=>w.type!=='Credit').reduce((a,b)=>a+b.balance,0);
        const totalDebt = data.wallets.filter(w=>w.type==='Credit').reduce((a,b)=>a+Math.abs(b.balance),0);
        const totalAssets = data.assets.reduce((a,b)=>a+b.value,0) + liquidAssets;

        const savingRate = periodInc > 0 ? (periodSav / periodInc) : 0;
        const expenseRatio = periodInc > 0 ? (periodExp / periodInc) : 0;
        const debtRatio = totalAssets > 0 ? (totalDebt / totalAssets) : 0;
        const avgMonthlyExp = periodExp > 0 ? periodExp : (data.budget.reduce((a,b)=>a+b.limit,0) || 1);
        const assetCover = liquidAssets / avgMonthlyExp;

        let finalScore = Math.round(Math.min((savingRate/0.2)*40, 40) + Math.max(0, 30-(debtRatio/0.3)*30) + Math.min((assetCover/6)*30, 30));
        if(isNaN(finalScore)) finalScore = 0;
        
        const scoreValEl = document.getElementById('planner-score-val');
        if(scoreValEl) scoreValEl.innerText = finalScore;
        
        const ring = document.getElementById('planner-score-ring');
        if(ring) {
            let color = 'var(--text-positive)';
            if(finalScore < 50) color = 'var(--text-negative)';
            else if(finalScore < 75) color = 'var(--text-warning)';
            
            ring.style.stroke = color;
            const statusEl = document.getElementById('planner-score-status');
            if(statusEl) {
                statusEl.style.color = color;
                statusEl.innerText = finalScore >= 80 ? 'Sangat Sehat Slay! üî•' : finalScore >= 60 ? 'Cukup Aman üëç' : 'Perlu Perbaikan üö®';
            }
            setTimeout(() => { ring.style.strokeDashoffset = 283 - (finalScore/100 * 283); }, 100);
        }

        const elDebt = document.getElementById('metric-debt'); if(elDebt) elDebt.innerText = Math.round(debtRatio*100) + '%';
        const elSav = document.getElementById('metric-saving'); if(elSav) elSav.innerText = Math.round(savingRate*100) + '%';
        const elAsset = document.getElementById('metric-asset'); if(elAsset) elAsset.innerText = assetCover.toFixed(1) + ' Bln';
        const elExp = document.getElementById('metric-expense'); if(elExp) elExp.innerText = Math.round(expenseRatio*100) + '%';

        const setInd = (id, isGood, goodText='‚Üì Aman', badText='‚Üë Bahaya') => {
            const el = document.getElementById(id);
            if (!el) return;
            if(isGood) { el.innerText = goodText; el.className = 'text-[10px] text-[var(--text-positive)] font-bold mb-1 whitespace-nowrap'; }
            else { el.innerText = badText; el.className = 'text-[10px] text-[var(--text-negative)] font-bold mb-1 whitespace-nowrap'; }
        }
        setInd('metric-debt-ind', debtRatio <= 0.3);
        setInd('metric-expense-ind', expenseRatio <= 0.5);
        setInd('metric-saving-ind', savingRate >= 0.2, '‚Üë Slay', '‚Üì Kurang');
        setInd('metric-asset-ind', assetCover >= 6, '‚Üë Aman', '‚Üì Rentan');

        // Tips (DIKEMBALIKAN UTUH & MEWAH)
        const tipsContainer = document.getElementById('planner-tips');
        if(tipsContainer) {
            tipsContainer.innerHTML = '';
            
            const buildTip = (icon, title, desc, colorVar) => `
            <div class="glass-card p-5 flex gap-4 items-start relative overflow-hidden group">
                <div class="absolute left-0 top-0 bottom-0 w-1.5" style="background-color: var(${colorVar});"></div>
                <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl shrink-0" style="background-color: color-mix(in srgb, var(${colorVar}) 15%, transparent);">
                    ${icon}
                </div>
                <div>
                    <h4 class="font-bold text-[var(--text-main)] text-sm mb-1">${title}</h4>
                    <p class="text-xs text-[var(--text-muted)] leading-relaxed">${desc}</p>
                </div>
            </div>`;

            if (debtRatio > 0.3) tipsContainer.innerHTML += buildTip('üö®', 'Fokus Lunasi Hutang', `Debt ratiomu ${Math.round(debtRatio*100)}% (di atas 30%). Stop tambah utang konsumtif dan pakai metode snowball untuk melunasi cicilan.`, '--text-negative');
            else tipsContainer.innerHTML += buildTip('‚úÖ', 'Hutang Terkendali', 'Rasio hutangmu sangat sehat. Pertahankan kebiasaan baik ini bestie dan hindari paylater impulsif!', '--text-positive');

            if (savingRate < 0.1) tipsContainer.innerHTML += buildTip('üí°', 'Mulai Pay Yourself First', `Kamu baru nabung ${Math.round(savingRate*100)}%. Sisihkan minimal 10-20% langsung saat gajian cair, jangan nunggu sisa akhir bulan.`, '--text-warning');
            else tipsContainer.innerHTML += buildTip('üöÄ', 'Master Nabung', `Saving rate ${Math.round(savingRate*100)}% Slay banget! Ini saatnya untuk mulai diversifikasi tabungan ke instrumen investasi.`, '--text-info');

            if (assetCover < 3) tipsContainer.innerHTML += buildTip('üõ°Ô∏è', 'Kebut Dana Darurat', `Dana tunaimu cuma cukup buat ${assetCover.toFixed(1)} bulan. Targetin kumpul minimal 3-6x pengeluaran bulananmu (${formatRupiah(avgMonthlyExp*3)}).`, '--text-warning');

            if (expenseRatio > 0.6) tipsContainer.innerHTML += buildTip('üí∏', 'Bocor Halus Terdeteksi', `Pengeluaranmu capai ${Math.round(expenseRatio*100)}% dari income. Cek budget 'Lifestyle' atau langganan yang jarang dipakai.`, '--text-negative');
        }
        
        // Roadmap (DIKEMBALIKAN UTUH & MEWAH)
        const rm = document.getElementById('roadmap-container');
        if(rm) {
            const s1_done = assetCover >= 1;
            const s2_done = s1_done && debtRatio < 0.1;
            const s3_done = s2_done && assetCover >= 6;
            const s4_done = s3_done && savingRate >= 0.2 && finalScore > 80;

            const getStatus = (isDone, isUnlocked) => {
                if (isDone) return { 
                    bg: 'bg-[var(--text-positive)]', text: 'text-white', 
                    badgeBg: 'bg-positive-alpha', badgeText: 'text-[var(--text-positive)]', 
                    label: 'Selesai', ring: 'border-[var(--bg-body)]', op: '' 
                };
                if (isUnlocked) return { 
                    bg: 'bg-[var(--primary)]', text: 'text-[var(--text-on-gradient)]', 
                    badgeBg: 'bg-primary-alpha', badgeText: 'text-[var(--primary)]', 
                    label: 'Proses', ring: 'border-[var(--bg-body)]', op: '' 
                };
                return { 
                    bg: 'bg-[var(--input-bg)]', text: 'text-[var(--text-muted)]', 
                    badgeBg: 'bg-[var(--input-bg)]', badgeText: 'text-[var(--text-muted)]', 
                    label: 'Rencana', ring: 'border-[var(--bg-body)]', op: 'opacity-50 grayscale-[50%]' 
                };
            };

            const st1 = getStatus(s1_done, true);
            const st2 = getStatus(s2_done, s1_done);
            const st3 = getStatus(s3_done, s2_done);
            const st4 = getStatus(s4_done, s3_done);

            const buildStage = (num, title, desc, checks, highlight, time, st) => `
            <div class="relative pl-8">
                <!-- Timeline Number Dot -->
                <div class="absolute -left-[17px] top-4 w-9 h-9 rounded-full ${st.bg} ${st.text} flex items-center justify-center font-black text-sm z-10 border-4 ${st.ring} transition-colors shadow-sm">${num}</div>
                
                <div class="glass-card p-5 transition-opacity ${st.op}">
                    <div class="flex justify-between items-start mb-3 gap-2">
                        <h4 class="font-bold text-sm leading-tight text-[var(--text-main)]">${title}</h4>
                        <span class="text-[10px] font-black px-3 py-1 rounded-full ${st.badgeBg} ${st.badgeText} shrink-0 uppercase tracking-widest">${st.label}</span>
                    </div>
                    <p class="text-xs text-[var(--text-muted)] mb-4 leading-relaxed">${desc}</p>
                    
                    <ul class="text-[11px] text-[var(--text-main)] opacity-90 space-y-2.5 mb-5 font-medium">
                        ${checks.map(c => `
                            <li class="flex items-start gap-2">
                                <span class="mt-0.5 ${st.label==='Selesai'?'text-[var(--text-positive)]':st.label==='Proses'?'text-[var(--primary)]':'text-[var(--text-muted)]'}">${st.label==='Selesai'?'‚úî':st.label==='Proses'?'‚óè':'‚óã'}</span> 
                                <span>${c}</span>
                            </li>`).join('')}
                    </ul>
                    
                    ${st.label !== 'Rencana' ? `
                    <div class="p-3 rounded-xl mb-4 border border-[var(--border-glass)] ${st.label==='Selesai'?'bg-positive-alpha':'bg-primary-alpha'}">
                        <p class="text-[10px] font-bold ${st.label==='Selesai'?'text-[var(--text-positive)]':'text-[var(--primary)]'}">‚ú® Highlight Capaian: ${highlight}</p>
                    </div>` : ''}
                    
                    <span class="text-[10px] font-bold bg-[var(--input-bg)] text-[var(--text-muted)] px-3 py-1.5 rounded-md uppercase tracking-wider border border-[var(--border-glass)]">‚è±Ô∏è Estimasi: ${time}</span>
                </div>
            </div>`;

            rm.innerHTML = `
                ${buildStage(1, 'Fondasi Keuangan', 'Membangun kebiasaan tracking yang disiplin dan safety net awal untuk bertahan hidup.', ['Catat pemasukan & pengeluaran tanpa bolong', 'Kumpulkan dana darurat minimal 1 bulan pengeluaran'], 'Dana darurat ' + formatRupiah(liquidAssets), '1-3 Bulan', st1)}
                ${buildStage(2, 'Bebas Hutang Konsumtif', 'Membersihkan beban bunga yang menghambat akumulasi kekayaan di masa depan.', ['Debt ratio di bawah 10%', 'Tidak ada sisa tagihan kartu kredit / paylater'], 'Debt Ratio saat ini ' + Math.round(debtRatio*100) + '%', '3-6 Bulan', st2)}
                ${buildStage(3, 'Keamanan Finansial Ekstra', 'Memperkuat sabuk pengaman agar tidak kembali miskin jika terjadi krisis besar.', ['Dana darurat stabil di 6 bulan pengeluaran', 'Miliki asuransi kesehatan dasar aktif'], 'Asset Coverage ' + assetCover.toFixed(1) + ' bln', '1-2 Tahun', st3)}
                ${buildStage(4, 'Akumulasi & Kebebasan', 'Fokus 100% pada investasi dan melipatgandakan aset secara agresif namun aman.', ['Rutin menabung & investasi > 20% pemasukan', 'Diversifikasi portofolio ke reksadana/saham'], 'Saving Rate konsisten ' + Math.round(savingRate*100) + '%', '3+ Tahun', st4)}
            `;
        }
    }

    function renderBudget() {
        const txs = getFilteredTxs().filter(t=>t.type==='expense');
        const totalExp = txs.reduce((a,b)=>a+b.amount,0);
        const totalBud = data.budget.reduce((a,b)=>a+b.limit,0);
        document.getElementById('budget-used').innerText = formatRupiah(totalExp);
        document.getElementById('budget-total').innerText = formatRupiah(totalBud);
        const pct = totalBud>0 ? Math.min((totalExp/totalBud)*100, 100) : 0;
        document.getElementById('budget-bar-main').style.width = pct + '%';
        document.getElementById('budget-pct').innerText = Math.round(pct) + '% Digunakan';
        
        const list = document.getElementById('budget-list'); list.innerHTML = '';
        data.budget.forEach(b => {
            const used = txs.filter(t=>t.cat===b.cat).reduce((a,x)=>a+x.amount,0);
            const bpct = b.limit>0 ? Math.min((used/b.limit)*100, 100) : 0;
            list.innerHTML += `
            <div class="glass-card p-4">
                <div class="flex justify-between text-xs font-bold mb-2 text-[var(--text-main)]"><span>${b.cat}</span><span>${formatRupiah(used)} / ${formatRupiah(b.limit)}</span></div>
                <div class="w-full h-2 bg-[var(--input-bg)] rounded-full mb-3"><div class="h-full bg-[var(--primary)] rounded-full" style="width:${bpct}%"></div></div>
                <div class="flex justify-end gap-4"><div onclick="editBudget('${b.cat}')" class="text-xs font-bold text-[var(--text-info)] cursor-pointer">‚úé Edit</div><div onclick="deleteBudget('${b.cat}')" class="text-xs font-bold text-[var(--text-negative)] cursor-pointer">üóë Hapus</div></div>
            </div>`;
        });
        
        const budCats = data.budget.map(b=>b.cat);
        const unBud = {};
        txs.filter(t=>!budCats.includes(t.cat)).forEach(t=>unBud[t.cat]=(unBud[t.cat]||0)+t.amount);
        const unList = document.getElementById('unbudgeted-list'); unList.innerHTML = '';
        Object.entries(unBud).forEach(([cat,val]) => {
            unList.innerHTML += `<div class="glass-card p-3 flex justify-between text-xs font-bold text-[var(--text-main)]"><span>${cat}</span><span class="text-[var(--text-negative)]">${formatRupiah(val)}</span></div>`;
        });
        
        const recList = document.getElementById('recurring-list'); recList.innerHTML = '';
        if(data.recurring.length === 0) recList.innerHTML = '<p class="text-[10px] text-[var(--text-muted)] text-center py-2">Belum ada tagihan rutin.</p>';
        else {
             data.recurring.forEach(r => {
                 recList.innerHTML += `<div class="flex justify-between items-center text-xs p-3 glass-card mb-2">
                     <div><b class="text-[var(--text-main)]">${r.name}</b> <span class="opacity-70 text-[var(--text-muted)]">(${r.cat})</span></div>
                     <div class="flex items-center gap-3"><span class="font-bold text-[var(--text-main)]">${formatRupiah(r.amount)}</span> <span onclick="deleteRecurring(${r.id})" class="text-[var(--text-negative)] cursor-pointer">üóë</span></div>
                 </div>`;
             });
        }
    }
    
    function editBudget(cat) {
        const b = data.budget.find(x => x.cat === cat);
        document.getElementById('budget-cat').value = b.cat; document.getElementById('budget-limit').value = b.limit;
        editingId = cat; toggleModal('budget-modal', true);
    }
    function deleteBudget(cat) { Swal.fire({title:'Hapus Budget?', showCancelButton:true}).then(r=>{if(r.isConfirmed){ data.budget=data.budget.filter(b=>b.cat!==cat); saveData(); renderBudget(); }}); }
    function saveBudget() {
        const cat = document.getElementById('budget-cat').value; const lim = parseInt(document.getElementById('budget-limit').value);
        if(cat && lim) {
            const newB = {cat, limit:lim};
            if(editingId) { const idx = data.budget.findIndex(b => b.cat === editingId); if(idx > -1) data.budget[idx] = newB; } else data.budget.push(newB);
            saveData(); renderBudget(); toggleModal('budget-modal',false);
        }
    }
    function generateAIBudget() {
        Swal.fire({title: 'ü§ñ AI Menganalisa...', text: 'Mempelajari pola pengeluaranmu', didOpen: () => Swal.showLoading()});
        setTimeout(() => {
            const expenses = data.tx.filter(t => t.type === 'expense');
            const catTotals = {}; expenses.forEach(t => catTotals[t.cat] = (catTotals[t.cat] || 0) + t.amount);
            const newBudget = Object.keys(catTotals).map(cat => ({ cat: cat, limit: Math.ceil(catTotals[cat] * 1.2 / 1000) * 1000 }));
            if(newBudget.length === 0) { newBudget.push({cat: 'Makan', limit: 1500000}); newBudget.push({cat: 'Transport', limit: 500000}); }
            data.budget = newBudget; saveData(); renderBudget();
            Swal.fire('Selesai!', 'Budget cerdas telah dibuat (+20% buffer aman).', 'success');
        }, 1500);
    }

    function renderAssets() {
        const total = data.assets.reduce((a,b)=>a+b.value,0) + data.wallets.filter(w=>w.type!=='Credit').reduce((a,b)=>a+b.balance,0);
        document.getElementById('asset-net-worth').innerText = formatRupiah(total);
        document.getElementById('asset-count').innerText = data.assets.length + data.wallets.length;
        const types = {}; [...data.assets, ...data.wallets].forEach(a => { const t = a.type || 'Other'; types[t] = (types[t]||0) + (a.value || a.balance); });
        
        const compDiv = document.getElementById('asset-composition'); compDiv.innerHTML = '';
        Object.entries(types).forEach(([t,v]) => {
            if(v > 0) compDiv.innerHTML += `
            <!-- PERBAIKAN: Tambah font-bold pada label komposisi -->
            <div class="flex justify-between text-xs font-bold mb-1 text-[var(--text-main)]"><span>${t}</span><span>${Math.round((v/total)*100)}%</span></div>
            <div class="w-full h-1.5 bg-[var(--input-bg)] rounded-full mb-2"><div class="h-full bg-[var(--text-positive)] rounded-full" style="width:${(v/total)*100}%"></div></div>`;
        });
        
        const list = document.getElementById('asset-list'); list.innerHTML = '';
        data.assets.forEach(a => list.innerHTML += `
        <div class="glass-card p-4 flex justify-between items-center">
            <div>
                <p class="font-bold text-sm text-[var(--text-main)]">${a.name}</p>
                <!-- PERBAIKAN: Hapus opacity redup, ganti dengan font-bold, uppercase dan tracking-wider agar 10px mudah dibaca -->
                <p class="text-[10px] font-bold uppercase tracking-wider text-[var(--text-muted)] mt-0.5">${a.type}</p>
            </div>
            <div class="text-right">
                <!-- PERBAIKAN: Font nominal dipertebal jadi font-black -->
                <p class="font-black text-base text-[var(--text-positive)] mb-1">${formatRupiah(a.value)}</p>
                <!-- PERBAIKAN: Spacing gap antar tombol diperbesar (gap-4) dan opacity hover ditambahkan -->
                <div class="flex gap-4 justify-end mt-2">
                    <div onclick="editAsset('${a.id}')" class="text-xs font-bold text-[var(--text-info)] cursor-pointer hover:opacity-70 transition-opacity">‚úé Edit</div>
                    <div onclick="deleteAsset('${a.id}')" class="text-xs font-bold text-[var(--text-negative)] cursor-pointer hover:opacity-70 transition-opacity">üóë Hapus</div>
                </div>
            </div>
        </div>`);
    }
    
    function editAsset(id) { const a = data.assets.find(x => x.id == id); document.getElementById('asset-name').value = a.name; document.getElementById('asset-val').value = a.value; editingId = id; toggleModal('asset-modal', true); }
    function deleteAsset(id) { Swal.fire({title:'Hapus Aset?', showCancelButton:true}).then(r=>{if(r.isConfirmed){ data.assets=data.assets.filter(a=>a.id!=id); saveData(); renderAssets(); }}); }
    function saveAsset() {
        const n = document.getElementById('asset-name').value; const v = parseInt(document.getElementById('asset-val').value);
        if(n && v) { 
            const newA = {id: editingId || Date.now(), name:n, value:v, type: document.getElementById('asset-type').value};
            if(editingId) { const idx = data.assets.findIndex(x=>x.id==editingId); if(idx>-1) data.assets[idx]=newA; } else data.assets.push(newA);
            saveData(); renderAssets(); toggleModal('asset-modal',false); 
        }
    }

    function renderWallets() {
        const cashList = document.getElementById('wallet-list-cash'); cashList.innerHTML = '';
        const credList = document.getElementById('wallet-list-credit'); credList.innerHTML = '';
        let debt = 0;
        data.wallets.forEach(w => {
            const isCredit = w.type === 'Credit';
            const nominalColor = isCredit ? 'text-[var(--text-negative)]' : 'text-[var(--text-main)]';
            const html = `
            <div class="glass-card p-5">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-bold uppercase text-[var(--text-muted)] tracking-wider">${w.name}</span>
                    <span class="text-xl">${isCredit ? 'üí≥' : 'üè¶'}</span>
                </div>
                <p class="text-2xl font-black mb-4 font-heading ${nominalColor}">${isCredit ? '-' : ''}${formatRupiah(Math.abs(w.balance))}</p>
                <div class="flex justify-end items-center gap-4 border-t border-[var(--border-glass)] pt-3">
                    <button onclick="editWallet('${w.id}')" class="text-xs font-bold text-[var(--text-info)] hover:opacity-70 transition-opacity">‚úé Edit</button>
                    <button onclick="deleteWallet('${w.id}')" class="text-xs font-bold text-[var(--text-negative)] hover:opacity-70 transition-opacity">üóë Hapus</button>
                </div>
            </div>`;
            if(isCredit) { debt += Math.abs(w.balance); credList.innerHTML += html; } else { cashList.innerHTML += html; }
        });
        document.getElementById('total-debt').innerText = `Utang: ${formatRupiah(debt)}`;
    }
    function editWallet(id) { const w = data.wallets.find(x => x.id == id); document.getElementById('wallet-name').value = w.name; document.getElementById('wallet-bal').value = w.balance; editingId = id; toggleModal('wallet-modal', true); }
    function deleteWallet(id) { Swal.fire({title:'Hapus Dompet?', showCancelButton:true}).then(r=>{if(r.isConfirmed){ data.wallets=data.wallets.filter(w=>w.id!=id); saveData(); renderWallets(); }}); }
    function saveWallet() {
        const n = document.getElementById('wallet-name').value; const v = parseInt(document.getElementById('wallet-bal').value);
        if(n && !isNaN(v)) { 
            const newW = {id: editingId || Date.now(), name:n, balance:v, type: document.getElementById('wallet-type').value};
            if(editingId) { const idx = data.wallets.findIndex(x=>x.id==editingId); if(idx>-1) data.wallets[idx]=newW; } else data.wallets.push(newW);
            saveData(); renderWallets(); toggleModal('wallet-modal',false); 
        }
    }

    function renderGoals() {
        const list = document.getElementById('goals-list-container'); list.innerHTML = '';
        data.goals.forEach(g => {
            const target = new Date(g.date); const diff = Math.max(0, Math.ceil((target - new Date()) / (1000 * 60 * 60 * 24)));
            const months = Math.max(1, Math.ceil(diff/30)); const remain = g.target - g.current;
            const monthly = remain > 0 ? remain / months : 0; const pct = Math.min((g.current/g.target)*100, 100);
            list.innerHTML += `
            <div class="glass-card p-5">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-sm text-[var(--text-main)]">${g.name}</h3>
                    <span class="text-[10px] font-black bg-primary-alpha text-[var(--primary)] px-2.5 py-1 rounded-md uppercase tracking-wider">Sisa ${diff} Hari</span>
                </div>
                <div class="flex justify-between text-xs mb-2">
                    <span class="font-bold text-[var(--text-positive)] text-sm">${formatRupiah(g.current)}</span>
                    <span class="text-[var(--text-muted)] font-medium mt-0.5">Target: ${formatRupiah(g.target)}</span>
                </div>
                <div class="w-full h-2.5 bg-[var(--border-glass)] rounded-full mb-4 overflow-hidden border border-[var(--border-glass)]">
                    <div class="h-full bg-[var(--primary)]" style="width:${pct}%"></div>
                </div>
                <div class="flex items-center gap-3 text-[11px] font-medium bg-[var(--input-bg)] text-[var(--text-muted)] p-3 rounded-xl mb-4 border border-[var(--border-glass)]">
                    <span class="text-lg">üí°</span><span>Perlu nabung <b class="text-[var(--text-main)] font-black tracking-wide">${formatRupiah(monthly)}</b> / bln</span>
                </div>
                <div class="flex justify-end items-center gap-4 border-t border-[var(--border-glass)] pt-4">
                    <button onclick="editGoal('${g.id}')" class="text-xs font-bold text-[var(--text-info)] hover:opacity-70 transition-opacity flex items-center gap-1">‚úé Edit</button>
                    <button onclick="deleteGoal('${g.id}')" class="text-xs font-bold text-[var(--text-negative)] hover:opacity-70 transition-opacity flex items-center gap-1">üóë Hapus</button>
                    <button onclick="openForecastModal('${g.id}')" class="text-xs font-bold bg-primary-alpha text-[var(--primary)] px-4 py-2 rounded-xl hover:opacity-80 transition-opacity ml-2">‚ú® Prediksi</button>
                </div>
            </div>`;
        });
    }
    function editGoal(id) { const g = data.goals.find(x => x.id == id); document.getElementById('goal-name').value = g.name; document.getElementById('goal-target').value = g.target; document.getElementById('goal-current').value = g.current; document.getElementById('goal-date').value = g.date; editingId = id; toggleModal('goal-modal', true); }
    function deleteGoal(id) { Swal.fire({title:'Hapus Goal?', showCancelButton:true}).then(r=>{if(r.isConfirmed){ data.goals=data.goals.filter(g=>g.id!=id); saveData(); renderGoals(); }}); }
    function saveGoal() {
        const name = document.getElementById('goal-name').value; const target = parseInt(document.getElementById('goal-target').value);
        const current = parseInt(document.getElementById('goal-current').value); const date = document.getElementById('goal-date').value;
        if(name && target) {
            const newG = {id: editingId || 'g'+Date.now(), name, target, current: current||0, date};
            if(editingId) { const idx = data.goals.findIndex(x=>x.id==editingId); if(idx>-1) data.goals[idx]=newG; } else data.goals.push(newG);
            saveData(); renderGoals(); toggleModal('goal-modal',false);
        }
    }

    function prepareAddTxNew() {
        editingId = null;
        document.getElementById('tx-date-new').valueAsDate = new Date();
        document.getElementById('tx-amount-new').value = '';
        document.getElementById('tx-desc-new').value = '';
        setTxTypeNew('expense');
        const payGrid = document.getElementById('pay-grid-container');
        const walletMethods = data.wallets.map(w => ({n: w.name, i: w.type==='Cash'?'üíµ':w.type==='Bank'?'üè¶':w.type==='Credit'?'üí≥':'üì±'}));
        const combined = [...PAY_METHODS, ...walletMethods.filter(w => !PAY_METHODS.some(p => p.n === w.n))];
        if(payGrid) payGrid.innerHTML = combined.map(p => `<div class="grid-icon-item ${selectedPay===p.n?'active':''}" onclick="setPaymentNew('${p.n}', this)"><span class="grid-icon-emoji">${p.i}</span><span class="grid-icon-text text-[10px]">${p.n}</span></div>`).join('');
    }
    function editTx(id) {
        const tx = data.tx.find(t => t.id == id); if(!tx) return; editingId = id; switchView('add-tx');
        setTxTypeNew(tx.type); document.getElementById('tx-amount-new').value = formatRupiah(tx.amount).replace('Rp ','');
        document.getElementById('tx-date-new').value = tx.date; document.getElementById('tx-desc-new').value = tx.desc || '';
        selectedCat = tx.cat; selectedPay = tx.payment || 'Tunai'; setTxTypeNew(tx.type); 
    }
    function deleteTx(id) { Swal.fire({title:'Hapus Transaksi?', icon:'warning', showCancelButton:true, confirmButtonText:'Ya, Hapus'}).then(res=>{ if(res.isConfirmed) { data.tx = data.tx.filter(t => t.id != id); saveData(); renderHome(); } }); }
    function setTxTypeNew(type) {
        currentTxType = type;
        ['income','expense','saving','investment'].forEach(t => { const el = document.getElementById('pill-'+t); if(el) { if(t === type) el.classList.add('active'); else el.classList.remove('active'); } });
        const catGrid = document.getElementById('cat-grid-container');
        if(catGrid) {
            const allCats = [...(BASE_CATS[type] || []), ...(data.custom_cats[type] || [])];
            if(!editingId) selectedCat = allCats[0]?.n || ''; 
            catGrid.innerHTML = allCats.map(c => `<div class="grid-icon-item ${selectedCat===c.n?'active':''}" onclick="setCategoryNew('${c.n}', this)"><span class="grid-icon-emoji">${c.i}</span><span class="grid-icon-text text-[10px]">${c.n}</span></div>`).join('');
        }
    }

    // PERBAIKAN: Gunakan class 'active' alih-alih menghapus 'hidden' untuk memunculkan overlay modal
    function openAddCategoryModal() { 
        document.getElementById('modal-add-category').classList.add('active'); 
        document.getElementById('new-cat-emoji').value = ''; 
        document.getElementById('new-cat-name').value = ''; 
    }
    
    // PERBAIKAN: Hapus class 'active' untuk menutup modal
    function closeAddCategoryModal() { 
        document.getElementById('modal-add-category').classList.remove('active'); 
    }

    function saveNewCategoryCustom() {
        const emoji = document.getElementById('new-cat-emoji').value || '‚ú®'; const name = document.getElementById('new-cat-name').value;
        if(name) {
            if(!data.custom_cats) data.custom_cats = { income: [], expense: [], saving: [], investment: [] };
            if(!data.custom_cats[currentTxType]) data.custom_cats[currentTxType] = [];
            data.custom_cats[currentTxType].push({n: name, i: emoji}); saveData(); setTxTypeNew(currentTxType); closeAddCategoryModal();
            Swal.fire({icon:'success', title:'Tersimpan', timer:1000, showConfirmButton:false});
        } else Swal.fire('Error', 'Nama wajib diisi', 'warning');
    }
    
    function setCategoryNew(name, el) { selectedCat = name; const siblings = el.parentElement.children; for(let sib of siblings) sib.classList.remove('active'); el.classList.add('active'); }
    function setPaymentNew(name, el) { selectedPay = name; const siblings = el.parentElement.children; for(let sib of siblings) sib.classList.remove('active'); el.classList.add('active'); }
    function formatInputRibuan(input) { let val = input.value.replace(/\D/g, ''); if(val) input.value = new Intl.NumberFormat('id-ID').format(val); }
    function saveTxNew() {
        const amt = parseInt(document.getElementById('tx-amount-new').value.replace(/\./g,''));
        if(!amt) return Swal.fire('Error','Nominal wajib diisi','warning');
        const txObj = { id: editingId || Date.now(), type: currentTxType, amount: amt, cat: selectedCat, payment: selectedPay, date: document.getElementById('tx-date-new').value, desc: document.getElementById('tx-desc-new').value || selectedCat };
        if(editingId) { const idx = data.tx.findIndex(t => t.id == editingId); if(idx > -1) data.tx[idx] = txObj; } 
        else { data.tx.push(txObj); if(data.wallets[0]) { if(currentTxType === 'income') data.wallets[0].balance += amt; else if(currentTxType === 'expense') data.wallets[0].balance -= amt; } }
        saveData(); detectAnomaly(txObj); switchView('home'); Swal.fire({icon: 'success', title: 'Tersimpan', timer: 1000, showConfirmButton: false});
    }

    function switchPlannerTab(tab) {
        ['overview','tips','roadmap'].forEach(t => { 
            const panel = document.getElementById('planner-'+t); if(panel) panel.classList.add('hidden'); 
            const btn = document.getElementById('tab-'+t);
            if(btn) { btn.classList.remove('text-[var(--primary)]', 'border-[var(--primary)]'); btn.classList.add('text-[var(--text-muted)]', 'border-transparent'); }
        });
        const activePanel = document.getElementById('planner-'+tab); if(activePanel) activePanel.classList.remove('hidden'); 
        const activeBtn = document.getElementById('tab-'+tab);
        if(activeBtn) { activeBtn.classList.remove('text-[var(--text-muted)]', 'border-transparent'); activeBtn.classList.add('text-[var(--primary)]', 'border-[var(--primary)]'); }
    }
    
    function toggleModal(id,show){ if(!show) editingId = null; document.getElementById(id).classList.toggle('active', show); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('sidebar-overlay').classList.toggle('active'); }
    function showMetricInfo(type) { document.getElementById('metric-info-modal').classList.remove('hidden'); }
    function closeMetricInfo() { document.getElementById('metric-info-modal').classList.add('hidden'); }
    function formatRupiah(num) { return 'Rp ' + new Intl.NumberFormat('id-ID').format(num); }
    
    function applyDarkMode() {
        const btn = document.getElementById('theme-toggle-btn');
        if (data.settings.isDarkMode) { document.body.classList.add('dark-mode'); if(btn) btn.innerText = '‚òÄÔ∏è'; } 
        else { document.body.classList.remove('dark-mode'); if(btn) btn.innerText = 'üåô'; }
    }
    function toggleDarkMode() { data.settings.isDarkMode = !data.settings.isDarkMode; applyDarkMode(); saveData(); renderExpenseChart(); }
    function setThemeOption(theme) {
        data.settings.theme = theme;
        document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
        const opt = document.getElementById('theme-opt-'+theme); if(opt) opt.classList.add('active');
        document.body.className = 'theme-'+theme; renderExpenseChart(); 
    }
    function saveSettings() {
        if(document.getElementById('set-name')) data.user.name = document.getElementById('set-name').value;
        saveData();
        Swal.fire({ icon: 'success', title: 'Tersimpan', timer: 1500, showConfirmButton: false, background: data.settings.isDarkMode ? '#1e293b' : '#ffffff', color: data.settings.isDarkMode ? '#fff' : '#0f172a' });
    }
    function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(data)); }
    
    function updateGsheetUI() { 
        const urlInput = document.getElementById('gsheet-url-display');
        const statusInd = document.getElementById('gsheet-status-indicator');
        const previewStatus = document.getElementById('gsheet-status-preview');
        
        if (urlInput && data.settings) urlInput.value = data.settings.gsheet_url || '';
        
        if (data.settings && data.settings.gsheet_url) {
            if (statusInd) statusInd.innerHTML = '<span class="text-lg">‚úÖ</span> <span class="text-[var(--text-positive)]">Terhubung</span>';
            if (previewStatus) { previewStatus.innerText = 'Terhubung'; previewStatus.className = 'text-[11px] font-bold text-[var(--text-positive)] mt-0.5'; }
        } else {
            if (statusInd) statusInd.innerHTML = '<span class="text-lg">‚ùå</span> <span class="text-[var(--text-negative)]">Tidak Terhubung</span>';
            if (previewStatus) { previewStatus.innerText = 'Belum Terhubung'; previewStatus.className = 'text-[11px] font-bold text-[var(--text-negative)] opacity-70 mt-0.5'; }
        }
    }
    
    function toggleEditUrl() {
        const input = document.getElementById('gsheet-url-display'); const btn = document.getElementById('btn-edit-url');
        if (!isEditingUrl) {
            input.removeAttribute('readonly'); input.classList.remove('opacity-60', 'cursor-not-allowed', 'bg-[var(--input-bg)]'); input.classList.add('bg-[var(--bg-card)]', 'border-[var(--primary)]'); input.focus();
            btn.innerText = 'Simpan URL Apps Script'; btn.classList.remove('bg-[var(--input-bg)]', 'text-[var(--text-main)]', 'border-[var(--border-color)]'); btn.classList.add('bg-[var(--primary)]', 'text-[var(--text-on-gradient)]', 'border-transparent');
            isEditingUrl = true;
        } else {
            const newUrl = input.value.trim();
            if (newUrl !== undefined) { data.settings.gsheet_url = newUrl; saveData(); updateGsheetUI(); Swal.fire({ title: 'Tersimpan', text: 'URL berhasil diatur.', icon: 'success' }); }
            input.setAttribute('readonly', true); input.classList.add('opacity-60', 'cursor-not-allowed', 'bg-[var(--input-bg)]'); input.classList.remove('bg-[var(--bg-card)]', 'border-[var(--primary)]');
            btn.innerText = 'Edit URL Apps Script'; btn.classList.remove('bg-[var(--primary)]', 'text-[var(--text-on-gradient)]', 'border-transparent'); btn.classList.add('bg-[var(--input-bg)]', 'text-[var(--text-main)]', 'border-[var(--border-color)]');
            isEditingUrl = false;
        }
    }

    function syncToGsheet() { 
        if(!data.settings.gsheet_url) return Swal.fire('Error','URL belum diatur','error');
        Swal.fire({title:'Menyimpan...', didOpen:()=>Swal.showLoading()});
        fetch(data.settings.gsheet_url, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }).then(() => { Swal.fire('Sukses','Data tersimpan ke Google Sheets','success'); }).catch(e => Swal.fire('Error', 'Gagal menyimpan: ' + e, 'error'));
    }
    function loadFromGsheet() { 
        if(!data.settings.gsheet_url) return Swal.fire('Error','URL belum diatur','error');
        Swal.fire({title:'Mengambil Data...', didOpen:()=>Swal.showLoading()});
        fetch(data.settings.gsheet_url).then(r => r.json()).then(d => { data = d; saveData(); init(); Swal.fire('Sukses','Data berhasil dimuat','success'); }).catch(e => Swal.fire('Error', 'Gagal memuat: ' + e, 'error'));
    }
    
    function copyAppsScriptCode() {
        const code = `function doGet(e) { return ContentService.createTextOutput(SpreadsheetApp.getActiveSpreadsheet().getSheets()[0].getRange("A1").getValue()).setMimeType(ContentService.MimeType.JSON); } function doPost(e) { SpreadsheetApp.getActiveSpreadsheet().getSheets()[0].getRange("A1").setValue(e.postData.contents); return ContentService.createTextOutput(JSON.stringify({status:"success"})).setMimeType(ContentService.MimeType.JSON); }`;
        const ta = document.createElement("textarea"); ta.value = code; ta.style.position = "fixed"; ta.style.left = "-9999px"; document.body.appendChild(ta); ta.focus(); ta.select();
        try { document.execCommand('copy') ? Swal.fire('Tersalin', 'Kode berhasil disalin', 'success') : Swal.fire('Error', 'Gagal menyalin manual.', 'error'); } catch (err) { Swal.fire('Error', 'Gagal menyalin', 'error'); }
        document.body.removeChild(ta);
    }
    function changeAvatar() { document.getElementById('avatar-input').click(); }
    function previewAvatar(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { document.getElementById('settings-avatar').src = e.target.result; if(data.user) { data.user.avatar = e.target.result; saveData(); } }; reader.readAsDataURL(input.files[0]); } }
    function toggleCustomInput(id) {
        const sel = document.getElementById(id); const p = sel.parentElement;
        if(sel.tagName === 'SELECT') { const inp = document.createElement('input'); inp.id = id; inp.className = 'input-field flex-1'; inp.placeholder = 'Ketik tipe custom...'; p.replaceChild(inp, sel); } 
        else { const nSel = document.createElement('select'); nSel.id = id; nSel.className = 'input-field flex-1'; nSel.innerHTML = id.includes('asset') ? '<option>Tunai & Tabungan</option><option>Investasi</option><option>Properti</option>' : '<option value="Cash">Cash</option><option value="Bank">Bank</option><option value="Credit">Kartu Kredit</option><option value="E-Wallet">E-Wallet</option>'; p.replaceChild(nSel, sel); }
    }

    function openReceiptScanner() { toggleModal('receipt-modal', true); }

    function processReceipt() {
        const text = document.getElementById('receipt-text').value;
        if(!text) return;
        const lines = text.split('\n');
        let count = 0;
        lines.forEach(line => {
            const match = line.match(/(\D+)(\d+)/);
            if(match) {
                const desc = match[1].trim();
                const amount = parseInt(match[2]);
                data.tx.push({ id: Date.now() + Math.random(), type: 'expense', amount: amount, cat: 'Belanja', payment: 'Tunai', date: new Date().toISOString().split('T')[0], desc: desc });
                if(data.wallets[0]) data.wallets[0].balance -= amount;
                count++;
            }
        });
        saveData();
        toggleModal('receipt-modal', false);
        Swal.fire('Sukses', `Berhasil memproses ${count} item dari struk!`, 'success');
        renderHome();
    }

    function startVoiceRecognition() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            Swal.fire('Error', 'Browser tidak mendukung fitur suara', 'error'); return;
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'id-ID';
        recognition.interimResults = false;
        
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            parseVoiceInput(transcript);
            Swal.fire({ icon: 'success', title: 'Suara Terdeteksi', text: `"${transcript}"`, timer: 1500, showConfirmButton: false });
        };
        recognition.onerror = function(event) { console.error(event.error); };
        
        switchView('add-tx');
        setTimeout(() => recognition.start(), 500);
    }

    function parseVoiceInput(text) {
        const numbers = text.match(/\d+/g);
        let amount = 0;
        let multiplier = 1;
        if (text.toLowerCase().includes('juta')) multiplier = 1000000;
        else if (text.toLowerCase().includes('ribu')) multiplier = 1000;

        if (numbers) {
            const rawNum = parseInt(numbers.join(''));
            amount = rawNum;
            if (amount < 1000 && multiplier > 1) amount *= multiplier;
        }
        
        if (amount > 0) document.getElementById('tx-amount-new').value = new Intl.NumberFormat('id-ID').format(amount);
        document.getElementById('tx-desc-new').value = text;
        autoCategorize(text);
    }

    function openForecastModal(goalId) {
        const goal = data.goals.find(g => g.id == goalId);
        if(!goal) return;
        
        toggleModal('forecast-modal', true);
        document.getElementById('forecast-title').innerText = `Prediksi: ${goal.name}`;
        
        const totalInc = data.tx.filter(t => t.type === 'income').reduce((a,b) => a+b.amount, 0);
        const totalExp = data.tx.filter(t => t.type === 'expense').reduce((a,b) => a+b.amount, 0);
        const avgSaving = Math.max(0, (totalInc - totalExp) / 1); 
        
        document.getElementById('forecast-saving').innerText = formatRupiah(avgSaving);
        
        const remaining = goal.target - goal.current;
        let months = 0;
        if(remaining <= 0) {
             document.getElementById('forecast-time').innerText = "Tercapai! üéâ";
        } else if (avgSaving <= 0) {
             document.getElementById('forecast-time').innerText = "Tidak Ada Surplus";
        } else {
            months = Math.ceil(remaining / avgSaving);
            document.getElementById('forecast-time').innerText = `${months} Bulan Lagi`;
        }
        
        const chart = document.getElementById('forecast-chart'); chart.innerHTML = '';
        const pctCurrent = Math.min((goal.current / goal.target) * 100, 100);
        chart.innerHTML += `<div class="w-8 bg-[var(--input-bg)] rounded-t-lg relative group h-full flex items-end"><div style="height:${pctCurrent}%" class="w-full bg-[var(--text-positive)] rounded-t-lg transition-all duration-1000"></div></div>`;
        
        for(let i=1; i<=5; i++) {
             let proj = goal.current + (avgSaving * i);
             let pct = Math.min((proj / goal.target) * 100, 100);
             let opacity = 1 - (i * 0.15);
             chart.innerHTML += `<div class="w-8 bg-[var(--input-bg)] rounded-t-lg relative group h-full flex items-end"><div style="height:${pct}%" class="w-full bg-[var(--primary)] opacity-[${opacity}] rounded-t-lg transition-all duration-1000 delay-${i*100}"></div></div>`;
        }
    }

    function autoCategorize(text) {
        if(!text) return;
        const lowerText = text.toLowerCase();
        const keywords = {
            'makan': 'Makan', 'minum': 'Makan', 'kopi': 'Makan', 'warteg': 'Makan', 'cafe': 'Makan',
            'bensin': 'Transport', 'grab': 'Transport', 'gojek': 'Transport', 'parkir': 'Transport',
            'gaji': 'Gaji', 'bonus': 'Bonus',
            'belanja': 'Belanja', 'supermarket': 'Belanja', 'indomaret': 'Belanja',
            'saham': 'Saham', 'reksadana': 'Reksadana', 'listrik': 'Tagihan', 'air': 'Tagihan'
        };
        for (const [key, cat] of Object.entries(keywords)) {
            if (lowerText.includes(key)) {
                if (['Makan', 'Transport', 'Belanja', 'Tagihan'].includes(cat)) setTxTypeNew('expense');
                else if (['Gaji', 'Bonus'].includes(cat)) setTxTypeNew('income');
                else if (['Saham', 'Reksadana'].includes(cat)) setTxTypeNew('investment');
                
                const catItems = document.querySelectorAll('#cat-grid-container .grid-icon-item');
                catItems.forEach(item => {
                    if(item.querySelector('.grid-icon-text').innerText === cat) item.click();
                });
                break;
            }
        }
    }

    function detectAnomaly(newTx) {
        if(newTx.type !== 'expense') return;
        const history = data.tx.filter(t => t.type === 'expense' && t.cat === newTx.cat && t.id !== newTx.id);
        if(history.length < 3) return; 
        const total = history.reduce((a,b) => a+b.amount, 0);
        const avg = total / history.length;
        if (newTx.amount > avg * 3) {
             setTimeout(() => {
                 toggleAICoach();
                 const historyChat = document.getElementById('chat-history-sidebar');
                 historyChat.innerHTML += `<div class="chat-bubble chat-bot bg-warning-alpha text-[var(--text-warning)] border-[var(--border-color)]">üö® <b>Peringatan Boros!</b><br>Transaksi ${newTx.cat} sebesar ${formatRupiah(newTx.amount)} jauh diatas rata-rata biasamu (${formatRupiah(avg)}).</div>`;
             }, 1000);
        }
    }

    window.onload = () => {
        if (typeof data.settings.isDarkMode === 'undefined') data.settings.isDarkMode = true;
        applyDarkMode();
        setThemeOption(data.settings.theme || 'neon');
        initPWA();
        setSmartGreeting();
        init();
    };
</script>
</body>
</html>