<!DOCTYPE html>
<html lang="id">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
 <title>FinZ App - Ultimate AI</title>
 <!-- Tailwind CSS -->
 <script src="https://cdn.tailwindcss.com"></script>
 <!-- SweetAlert2 Library -->
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 <!-- Google Fonts -->
 <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
 <style id="theme-style">
    /* --- DESIGN TOKENS & THEMES --- */
    :root {
      /* Default: Neon */
      --p-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #db2777 100%);
      --bg-gradient: radial-gradient(circle at top right, #f8fafc, #f1f5f9 100%);
      --card-bg: #ffffff;
      --card-glass: rgba(255, 255, 255, 0.95);
      --header-bg: rgba(255, 255, 255, 0.9);
      --border-glass: rgba(0, 0, 0, 0.08);
      --primary: #4f46e5;
      --text-main: #0f172a; 
      --text-muted: #64748b; 
      --radius-lg: 24px;
      --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.08);
      --modal-bg: #ffffff;
      --input-bg: #f8fafc;
    }

    /* THEME 2: PASTEL ENERJIK */
    body.theme-pastel-enerjik {
      --p-gradient: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 50%, #96E6A1 100%);
      --bg-gradient: linear-gradient(to top, #fff1eb 0%, #ace0f9 100%);
      --header-bg: rgba(255, 255, 255, 0.95);
      --primary: #ff5252;
      --text-main: #1a1a1a;
      --text-muted: #4a4a4a;
      --card-bg: rgba(255, 255, 255, 0.9);
      --modal-bg: #fff0f5;
      --input-bg: #ffffff;
    }

    /* THEME 3: EARTH TONE MODERN */
    body.theme-earth {
      --p-gradient: linear-gradient(135deg, #606c38 0%, #283618 100%);
      --bg-gradient: #fefae0;
      --header-bg: #faedcd;
      --card-bg: #faedcd;
      --primary: #bc6c25;
      --text-main: #1c260d;
      --text-muted: #485226;
      --border-glass: rgba(40, 54, 24, 0.15);
      --modal-bg: #fefae0;
      --input-bg: #faedcd;
    }

    /* THEME 4: IRIDESCENT */
    body.theme-iridescent {
      --p-gradient: linear-gradient(45deg, #00DBDE 0%, #FC00FF 100%);
      --bg-gradient: linear-gradient(180deg, #E0C3FC 0%, #8EC5FC 100%);
      --header-bg: rgba(255, 255, 255, 0.85);
      --primary: #6a00f4;
      --text-main: #1a0b2e;
      --text-muted: #4a3b5e;
      --card-bg: rgba(255, 255, 255, 0.8);
      --border-glass: rgba(255, 255, 255, 0.6);
      --modal-bg: #f0f8ff;
      --input-bg: rgba(255,255,255,0.6);
    }

    /* DARK MODE OVERRIDES */
    .dark-mode {
      --bg-gradient: radial-gradient(circle at top right, #0f172a, #020617 100%);
      --card-bg: #1e293b; 
      --header-bg: rgba(15, 23, 42, 0.95);
      --card-glass: rgba(30, 41, 59, 0.95);
      --border-glass: rgba(255, 255, 255, 0.15);
      --text-main: #f8fafc; 
      --text-muted: #cbd5e1;
      --modal-bg: #1e293b;
      --input-bg: #0f172a;
    }
    
    /* --- BASE STYLES --- */
    *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
        font-family: 'Plus Jakarta Sans', sans-serif; 
        background: var(--bg-gradient); color: var(--text-main); 
        min-height: 100vh; transition: background 0.3s, color 0.3s;
        display: flex; flex-direction: column; overflow-x: hidden;
    }

    /* --- COMPONENTS --- */
    .brand-text { font-family: 'Poppins', sans-serif; font-weight: 800; letter-spacing: -1px; }
    .glass-card { background: var(--card-bg); border: 1px solid var(--border-glass); border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); transition: 0.2s; color: var(--text-main); }
    .sticky-header { background: var(--header-bg); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-glass); transition: background 0.3s; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    /* --- SIDEBAR --- */
    #sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
    #sidebar-overlay.active { opacity: 1; pointer-events: auto; }
    #sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 85%; max-width: 300px; background: var(--card-bg); z-index: 1001; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 24px; display: flex; flex-direction: column; border-right: 1px solid var(--border-glass); }
    #sidebar.active { transform: translateX(0); }
    .sidebar-link { display: flex; align-items: center; gap: 14px; padding: 14px 16px; border-radius: 16px; font-weight: 700; font-size: 14px; color: var(--text-muted); transition: 0.2s; margin-bottom: 4px; cursor: pointer; }
    .sidebar-link.active { background: var(--p-gradient); color: white !important; box-shadow: 0 8px 20px rgba(79, 70, 229, 0.25); }

    /* --- AI COACH SIDEBAR --- */
    #ai-sidebar { position: fixed; top: 0; right: 0; height: 100%; width: 85%; max-width: 340px; background: var(--card-bg); z-index: 1002; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 20px; display: flex; flex-direction: column; border-left: 1px solid var(--border-glass); box-shadow: -10px 0 30px rgba(0,0,0,0.1); }
    #ai-sidebar.active { transform: translateX(0); }

    /* --- DATE FILTER MODAL --- */
    .quick-select-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
    .quick-btn { padding: 12px; border-radius: 14px; border: 1px solid var(--border-glass); font-size: 12px; font-weight: 700; text-align: center; color: var(--text-muted); cursor: pointer; background: var(--card-bg); transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .quick-btn.active { border-color: var(--primary); background: rgba(79, 70, 229, 0.1); color: var(--primary); }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; font-size: 12px; font-weight: 600; margin-top: 10px; }
    .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; color: var(--text-main); }
    .cal-day:hover { background: rgba(0,0,0,0.05); }
    .cal-day.active { background: var(--primary); color: white !important; }
    .cal-day.in-range { background: rgba(79, 70, 229, 0.2); }
    .cal-day.range-start { background: var(--primary); color: white !important; border-top-right-radius: 0; border-bottom-right-radius: 0; }
    .cal-day.range-end { background: var(--primary); color: white !important; border-top-left-radius: 0; border-bottom-left-radius: 0; }
    
    /* --- OTHER STYLES --- */
    .balance-card { background: var(--p-gradient); border-radius: 32px; padding: 28px 24px; color: white; position: relative; overflow: hidden; box-shadow: 0 20px 40px -10px rgba(79, 70, 229, 0.4); }
    .balance-sub-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 24px; }
    .balance-sub-item { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); border-radius: 18px; padding: 12px; backdrop-filter: blur(4px); }
    
    /* Filter Chip Tabs */
    .filter-chip-container { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
    .filter-chip { padding: 6px 12px; border-radius: 99px; font-size: 10px; font-weight: 800; border: 1px solid var(--border-glass); background: var(--card-bg); color: var(--text-muted); white-space: nowrap; transition: 0.2s; flex-grow: 1; text-align: center; }
    .filter-chip.active { background: var(--text-main); color: var(--card-bg); border-color: var(--text-main); }
    .dark-mode .filter-chip.active { background: #fff; color: #000; }
    
    .fab-btn { position: fixed; bottom: 30px; right: 24px; width: 64px; height: 64px; border-radius: 24px; background: var(--text-main); color: var(--card-bg); font-size: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 15px 30px rgba(0,0,0,0.2); z-index: 900; cursor: pointer; transition: 0.3s; }
    
    /* FAB MENU OVERLAY */
    #fab-menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
    #fab-menu-overlay.active { opacity: 1; pointer-events: auto; }
    
    /* FAB ACTIONS */
    .fab-action-container { position: fixed; bottom: 110px; right: 32px; display: flex; flex-direction: column; gap: 12px; z-index: 1000; pointer-events: none; opacity: 0; transform: translateY(20px); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .fab-action-container.active { pointer-events: auto; opacity: 1; transform: translateY(0); }
    .fab-action-item { display: flex; align-items: center; justify-content: flex-end; gap: 12px; cursor: pointer; }
    .fab-action-btn { width: 48px; height: 48px; border-radius: 50%; background: var(--card-bg); color: var(--text-main); display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: 0.2s; border: 1px solid var(--border-glass); }
    .fab-action-label { background: var(--card-bg); padding: 8px 12px; border-radius: 12px; font-size: 11px; font-weight: 700; color: var(--text-main); box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid var(--border-glass); }
    .fab-action-item:hover .fab-action-btn { transform: scale(1.1); background: var(--primary); color: white; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    .modal-sheet { background: var(--modal-bg); color: var(--text-main); width: 100%; max-width: 480px; border-radius: 32px 32px 0 0; padding: 24px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); position: relative; border: 1px solid var(--border-glass); }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .health-circle { width: 80px; height: 80px; position: relative; display: flex; align-items: center; justify-content: center; }
    .health-circle svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .health-track { fill: none; stroke: var(--border-glass); stroke-width: 8; }
    .health-progress { fill: none; stroke-width: 8; stroke-linecap: round; stroke-dasharray: 226; stroke-dashoffset: 226; transition: 1s ease; }
    .planner-tab { padding: 10px 20px; font-weight: 700; font-size: 13px; color: var(--text-muted); border-radius: 99px; transition: 0.2s; white-space: nowrap; }
    .planner-tab.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
    
    /* INPUT FIELDS STYLING */
    .input-field { width: 100%; padding: 16px; border-radius: 18px; border: 1.5px solid var(--border-glass); background: var(--input-bg); font-weight: 600; font-size: 14px; outline: none; color: var(--text-main); transition: 0.2s; }
    .input-field:focus { border-color: var(--primary); }
    .input-field:disabled, .input-field[readonly] { opacity: 0.7; cursor: not-allowed; }
    
    .wallet-card-bg { background: linear-gradient(135deg, #1e293b, #0f172a); color: white; }
    .credit-card-bg { background: linear-gradient(135deg, #be123c, #881337); color: white; }
    .profile-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--card-bg); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .theme-option { border: 2px solid var(--border-glass); border-radius: 18px; padding: 12px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .theme-option.active { border-color: var(--primary); background: rgba(79, 70, 229, 0.05); }
    .theme-preview { width: 100%; height: 40px; border-radius: 10px; }
    .tx-type-pill { padding: 10px 20px; border-radius: 99px; font-size: 12px; font-weight: 800; border: 1.5px solid var(--border-glass); cursor: pointer; text-align: center; color: var(--text-muted); transition: 0.2s; flex: 1; }
    .tx-type-pill.active { border-color: #10b981; background: #f0fdf4; color: #15803d; }
    .dark-mode .tx-type-pill.active { background: #14532d; color: #86efac; }
    .grid-icon-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 12px; border: 1.5px solid var(--border-glass); border-radius: 16px; cursor: pointer; transition: 0.2s; background: var(--input-bg); }
    .grid-icon-item.active { border-color: var(--primary); background: rgba(79, 70, 229, 0.1); transform: translateY(-2px); }
    .big-amount-input { font-size: 32px; font-weight: 900; width: 100%; text-align: left; background: transparent; border: none; outline: none; border-bottom: 2px solid var(--border-glass); padding-bottom: 8px; color: var(--text-main); }
    .big-amount-input:focus { border-color: var(--primary); }
    .gsheet-status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    .gsheet-status-dot.connected { background-color: #10b981; box-shadow: 0 0 10px #10b981; }
    .gsheet-status-dot.disconnected { background-color: #ef4444; }
    .emoji-select-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: var(--input-bg); cursor: pointer; font-size: 1.2rem; transition: 0.2s; border: 1px solid var(--border-glass); }
    .emoji-select-btn:hover { transform: scale(1.1); background: var(--card-bg); }

    /* SWEETALERT Z-INDEX FIX */
    div.swal2-container { z-index: 9999 !important; }

    /* GUIDE BOX COLOR FIX */
    .guide-box { background-color: #f1f5f9; color: #1e293b; border: 1px solid #cbd5e1; }
    .dark-mode .guide-box { background-color: #1e293b; color: #e2e8f0; border-color: #334155; }
    
    .note-box { background-color: #eff6ff; color: #1e3a8a; border-left: 4px solid #3b82f6; }
    .dark-mode .note-box { background-color: rgba(30, 58, 138, 0.3); color: #dbeafe; border-left-color: #60a5fa; }
    
    /* ROADMAP LINE */
    .roadmap-line { position: absolute; left: 24px; top: 30px; bottom: 0; width: 2px; background: var(--border-glass); z-index: 0; }
    .roadmap-item { position: relative; z-index: 1; padding-left: 56px; margin-bottom: 32px; }
    .roadmap-dot { position: absolute; left: 10px; top: 0; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 12px; border: 3px solid var(--card-bg); background: var(--primary); color: white; }

    /* DONUT CHART COLORS (FIX) */
    #d-inc { stroke: #10b981; } /* Emerald */
    #d-exp { stroke: #f43f5e; } /* Rose */
    #d-sav { stroke: #3b82f6; } /* Blue */
    #d-inv { stroke: #a855f7; } /* Purple */

    /* ACTION BUTTONS */
    .action-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 14px; transition: 0.2s; cursor: pointer; }
    .action-btn-edit { background: #e0e7ff; color: #4338ca; } /* Indigo */
    .action-btn-del { background: #fee2e2; color: #b91c1c; } /* Red */
    .dark-mode .action-btn-edit { background: rgba(67, 56, 202, 0.2); color: #818cf8; }
    .dark-mode .action-btn-del { background: rgba(185, 28, 28, 0.2); color: #f87171; }
    
    /* TEXT VISIBILITY FIX FOR ROADMAP & GOALS */
    .roadmap-target-pill { background-color: #e0e7ff; color: #3730a3; } /* Indigo 100/800 */
    .dark-mode .roadmap-target-pill { background-color: #1e293b; color: #cbd5e1; } /* Slate 800/300 */
    
    /* GOAL SAVING BOX - HIGH CONTRAST */
    .goal-saving-box { background-color: #eef2ff; color: #312e81; border: 1px solid #c7d2fe; } /* Indigo 50 / 900 */
    .dark-mode .goal-saving-box { background-color: #1e1b4b; color: #e0e7ff; border-color: #312e81; }
    
    /* VOICE MIC ANIMATION */
    .voice-active { animation: pulse-red 1.5s infinite; background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #ef4444 !important; }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

    /* CHATBOT STYLES */
    .chat-bubble { padding: 10px 14px; border-radius: 18px; margin-bottom: 8px; font-size: 12px; line-height: 1.5; max-width: 85%; }
    .chat-user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .chat-bot { background: var(--input-bg); color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid var(--border-glass); }
 </style>
</head>
<body class="no-scrollbar">

  <!-- SIDEBAR SYSTEM -->
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <nav id="sidebar">
      <div class="mb-10 flex items-center justify-between">
         <div class="brand-text text-2xl"><span class="text-indigo-600">FinZ</span><span class="text-pink-500">App</span></div>
         <button onclick="toggleSidebar()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center">‚úï</button>
      </div>
      <div class="flex-1 space-y-2 overflow-y-auto no-scrollbar">
          <div class="sidebar-link active" id="side-home" onclick="switchView('home')">üè† Beranda</div>
          <div class="sidebar-link" id="side-reports" onclick="openReportModal()">üìä Laporan Keuangan</div>
          <div class="sidebar-link" id="side-planner" onclick="switchView('planner')">üìã Financial Planner</div>
          <div class="sidebar-link" id="side-budget" onclick="switchView('budget')">üìâ Budgeting</div>
          <div class="sidebar-link" id="side-aset" onclick="switchView('aset')">üìà Aset</div>
          <div class="sidebar-link" id="side-dompet" onclick="switchView('dompet')">üí≥ Dompet</div>
          <div class="sidebar-link" id="side-goals" onclick="switchView('goals')">üéØ Goals</div>
          <div class="sidebar-link" id="side-settings" onclick="switchView('settings')">‚öôÔ∏è Pengaturan</div>
      </div>
      <div class="pt-6 border-t border-slate-100 dark:border-slate-800">
          <button onclick="handleLogout()" class="sidebar-link text-rose-500">üö™ Keluar</button>
      </div>
  </nav>

  <!-- AI COACH SIDEBAR -->
  <div id="ai-sidebar">
      <div class="flex justify-between items-center mb-6">
          <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-xl">ü§ñ</div>
              <div><h3 class="font-bold text-sm">FinZ Coach</h3><p class="text-[10px] opacity-60">Asisten Pintar</p></div>
          </div>
          <button onclick="toggleAICoach()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center font-bold text-slate-500">‚úï</button>
      </div>
      <div id="chat-history-sidebar" class="flex-1 overflow-y-auto mb-4 space-y-2 flex flex-col p-1">
          <div class="chat-bubble chat-bot">Halo! Saya FinZ Coach. Saya akan membantumu menganalisa keuangan dan memberi peringatan jika ada pengeluaran tidak wajar.</div>
      </div>
      <div class="flex gap-2">
          <input type="text" id="chat-input-sidebar" class="input-field py-3 text-xs" placeholder="Tanya sesuatu..." onkeypress="if(event.key==='Enter') sendChatSidebar()">
          <button onclick="sendChatSidebar()" class="p-3 bg-indigo-600 text-white rounded-xl">‚û§</button>
      </div>
  </div>

  <!-- AUTH SECTION -->
  <section id="auth-section" class="fixed inset-0 z-[3000] flex items-center justify-center p-6 bg-slate-50 dark:bg-slate-900">
    <div class="glass-card w-full max-w-sm p-8 text-center">
      <h1 class="text-4xl font-black mb-2 tracking-tighter"><span class="text-indigo-600">FinZ</span><span class="text-pink-500">App</span></h1>
      <p class="text-xs font-bold opacity-60 mb-8">Financial Freedom Starts Here</p>
      <input type="email" id="login-email" class="input-field mb-4" placeholder="user@keuangan.com">
      <input type="password" id="login-password" class="input-field mb-6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <button onclick="handleLogin()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-200">Masuk Aplikasi</button>
      <p class="mt-4 text-xs font-bold text-slate-400 cursor-pointer" onclick="fillDemo()">Gunakan Akun Demo</p>
    </div>
  </section>

  <!-- MAIN APP CONTAINER -->
  <main id="main-app" class="container mx-auto max-w-md min-h-screen pb-24 relative hidden">
      
    <!-- HEADER -->
    <header class="sticky-header sticky top-0 z-50 px-5 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="w-10 h-10 rounded-xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 flex flex-col items-center justify-center gap-1 shadow-sm">
                <div class="w-5 h-0.5 bg-slate-900 dark:bg-white rounded-full"></div>
                <div class="w-5 h-0.5 bg-slate-900 dark:bg-white rounded-full"></div>
            </button>
            <div>
                <h1 id="page-title" class="text-lg font-extrabold tracking-tight">Beranda</h1>
                <p id="user-greet" class="text-[10px] font-bold text-indigo-500 uppercase tracking-wider">Halo, User</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="toggleAICoach()" class="w-10 h-10 rounded-xl bg-indigo-100 dark:bg-indigo-900 text-xl flex items-center justify-center">ü§ñ</button>
            <button onclick="toggleDarkMode()" class="text-xl w-10 h-10 flex items-center justify-center">üåô</button>
        </div>
    </header>

    <!-- CONTENT VIEWS -->
    <div class="p-5 space-y-6">

        <!-- VIEW: HOME (BERANDA) -->
        <div id="view-home" class="space-y-6">
            <!-- Filter Periode -->
            <div onclick="toggleDateModal(true)" class="glass-card px-4 py-3 flex items-center justify-between cursor-pointer active:scale-95 transition-transform">
                <div class="flex items-center gap-3"><span class="text-lg">üìÖ</span><span id="home-period-label" class="text-xs font-bold uppercase tracking-wide">Periode ‚Äì Bulan Ini</span></div>
                <span class="opacity-50 text-xs">‚ñº</span>
            </div>
            <!-- Card Utama -->
            <div class="balance-card">
                <div class="flex justify-between items-start mb-1">
                    <span class="text-[10px] font-black tracking-widest opacity-80">Keuanganku</span>
                </div>
                <h2 id="home-balance" class="text-3xl font-black mb-6">Rp 0</h2>
                <div class="balance-sub-grid">
                    <div class="balance-sub-item"><p class="text-[9px] font-bold uppercase opacity-80 mb-1">Pemasukan</p><p id="home-inc" class="text-xs font-black text-emerald-300">Rp 0</p></div>
                    <div class="balance-sub-item"><p class="text-[9px] font-bold uppercase opacity-80 mb-1">Pengeluaran</p><p id="home-exp" class="text-xs font-black text-rose-300">Rp 0</p></div>
                    <div class="balance-sub-item"><p class="text-[9px] font-bold uppercase opacity-80 mb-1">Tabungan</p><p id="home-sav" class="text-xs font-black text-blue-300">Rp 0</p></div>
                    <div class="balance-sub-item"><p class="text-[9px] font-bold uppercase opacity-80 mb-1">Investasi</p><p id="home-inv" class="text-xs font-black text-purple-300">Rp 0</p></div>
                </div>
            </div>
            <!-- Distribusi -->
            <div class="glass-card p-5">
                <h3 class="text-sm font-bold mb-4">Distribusi Keuangan</h3>
                <div class="flex items-center gap-6">
                    <div class="relative w-24 h-24 flex items-center justify-center shrink-0">
                        <svg class="donut-chart-svg" viewBox="0 0 100 100">
                            <circle class="donut-circle-bg" cx="50" cy="50" r="40" style="fill: none; stroke: var(--border-glass); stroke-width: 12;"></circle>
                            <circle id="d-inc" class="donut-circle-val" cx="50" cy="50" r="40" stroke-dasharray="0 251" style="fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dasharray 0.6s ease;"></circle>
                            <circle id="d-exp" class="donut-circle-val" cx="50" cy="50" r="40" stroke-dasharray="0 251" style="fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dasharray 0.6s ease;"></circle>
                            <circle id="d-sav" class="donut-circle-val" cx="50" cy="50" r="40" stroke-dasharray="0 251" style="fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dasharray 0.6s ease;"></circle>
                            <circle id="d-inv" class="donut-circle-val" cx="50" cy="50" r="40" stroke-dasharray="0 251" style="fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dasharray 0.6s ease;"></circle>
                        </svg>
                    </div>
                    <div class="space-y-2 flex-1">
                        <div class="flex justify-between text-[10px] font-bold"><span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500"></span>Pemasukan</span><span id="l-inc">0%</span></div>
                        <div class="flex justify-between text-[10px] font-bold"><span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-rose-500"></span>Pengeluaran</span><span id="l-exp">0%</span></div>
                        <div class="flex justify-between text-[10px] font-bold"><span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span>Tabungan</span><span id="l-sav">0%</span></div>
                        <div class="flex justify-between text-[10px] font-bold"><span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-purple-500"></span>Investasi</span><span id="l-inv">0%</span></div>
                    </div>
                </div>
            </div>
            <!-- Horizontal Cards (Cleaned Up) -->
            <div class="grid grid-cols-2 gap-3">
                <div class="glass-card p-4"><p class="text-[10px] opacity-60 font-bold uppercase mb-1">Pengeluaran Terbesar</p><p id="top-expense-val" class="text-sm font-black truncate">Rp 0</p><p id="top-expense-cat" class="text-[10px] font-bold opacity-80">-</p></div>
                <div class="glass-card p-4"><p class="text-[10px] opacity-60 font-bold uppercase mb-1">Tagihan Mendatang</p><p id="upcoming-bills-count" class="text-sm font-black">0 Tagihan</p><p class="text-[10px] font-bold opacity-80">Cek Kalender</p></div>
            </div>
            
            <!-- Smart Filter Search -->
             <div class="relative mb-2">
                <input type="text" id="smart-filter-input" class="input-field py-3 pl-10 text-xs" placeholder="Cari: 'Makan diatas 50rb'..." oninput="applySmartFilter(this.value)">
                <span class="absolute left-3 top-3 opacity-50">üîç</span>
            </div>

            <!-- Daftar Transaksi (Filter Tab Small & Wrapped) -->
            <div>
                <h3 class="text-sm font-bold mb-3 px-1">Daftar Transaksi</h3>
                <div class="filter-chip-container">
                    <button class="filter-chip active" id="chip-all" onclick="filterTx('all', this)">Semua</button>
                    <button class="filter-chip" id="chip-income" onclick="filterTx('income', this)">Pemasukan</button>
                    <button class="filter-chip" id="chip-expense" onclick="filterTx('expense', this)">Pengeluaran</button>
                    <button class="filter-chip" id="chip-saving" onclick="filterTx('saving', this)">Tabungan</button>
                    <button class="filter-chip" id="chip-investment" onclick="filterTx('investment', this)">Investasi</button>
                </div>
                <div id="tx-list-container" class="space-y-3 pb-20"></div>
            </div>
        </div>

        <!-- VIEW: SETTINGS -->
        <div id="view-settings" class="hidden space-y-6 pb-24">
             <div class="glass-card p-6 flex flex-col items-center relative">
                 <div class="relative mb-4 cursor-pointer" onclick="changeAvatar()">
                     <img id="settings-avatar" src="https://ui-avatars.com/api/?name=User&background=random" class="profile-avatar">
                     <div class="absolute bottom-0 right-0 w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center border-2 border-white text-white text-xs shadow-lg">üì∑</div>
                 </div>
                 <h2 id="settings-name-display" class="text-lg font-black">User Name</h2>
                 <p id="settings-email-display" class="text-xs opacity-60 font-bold">user@email.com</p>
                 <input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="previewAvatar(this)">
             </div>
             <div>
                 <h3 class="text-xs font-bold uppercase opacity-60 mb-3 px-1">Preferensi Akun</h3>
                 <div class="glass-card p-5 space-y-4">
                     <div><label class="text-[10px] font-bold uppercase opacity-70 block mb-1">Nama Tampilan</label><input type="text" id="set-name" class="input-field py-3 text-sm" placeholder="Nama Anda"></div>
                     <div><label class="text-[10px] font-bold uppercase opacity-70 block mb-1">Email</label><input type="email" id="set-email" class="input-field py-3 text-sm" readonly></div>
                 </div>
             </div>
             <div>
                 <h3 class="text-xs font-bold uppercase opacity-60 mb-3 px-1">Database & Cloud</h3>
                 <div class="glass-card p-4 flex items-center justify-between cursor-pointer active:scale-95 transition-transform border border-indigo-100 dark:border-indigo-900" onclick="toggleModal('gsheet-modal', true)">
                     <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xl">üìÖ</div><div><p class="text-sm font-bold">Integrasi Google Sheets</p><p class="text-[10px] opacity-60" id="gsheet-status-preview">Belum Terhubung</p></div></div><span class="text-lg opacity-40">‚Ä∫</span>
                 </div>
             </div>
             <div>
                 <h3 class="text-xs font-bold uppercase opacity-60 mb-3 px-1">Tampilan Aplikasi</h3>
                 <div class="glass-card p-5 space-y-4">
                     <div>
                         <label class="text-[10px] font-bold uppercase opacity-70 block mb-3">Tema Warna</label>
                         <div class="grid grid-cols-3 gap-3">
                             <div class="theme-option active" id="theme-opt-neon" onclick="setThemeOption('neon')"><div class="theme-preview bg-gradient-to-r from-indigo-500 to-purple-500"></div><p class="text-[10px] font-bold text-center">Neon</p></div>
                             <div class="theme-option" id="theme-opt-pastel-enerjik" onclick="setThemeOption('pastel-enerjik')"><div class="theme-preview bg-gradient-to-r from-pink-400 to-yellow-300"></div><p class="text-[10px] font-bold text-center">Pastel Enerjik</p></div>
                             <div class="theme-option" id="theme-opt-earth" onclick="setThemeOption('earth')"><div class="theme-preview bg-gradient-to-r from-[#606c38] to-[#bc6c25]"></div><p class="text-[10px] font-bold text-center">Earth Tone</p></div>
                             <div class="theme-option" id="theme-opt-iridescent" onclick="setThemeOption('iridescent')"><div class="theme-preview bg-gradient-to-r from-cyan-400 to-fuchsia-500"></div><p class="text-[10px] font-bold text-center">Iridescent</p></div>
                             <div class="theme-option" id="theme-opt-pastel" onclick="setThemeOption('pastel')"><div class="theme-preview bg-gradient-to-r from-pink-300 to-rose-300"></div><p class="text-[10px] font-bold text-center">Soft</p></div>
                         </div>
                     </div>
                 </div>
             </div>
             <button onclick="saveSettings()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-transform">Simpan Perubahan</button>
        </div>

        <!-- OTHER VIEWS -->
        <div id="view-planner" class="hidden space-y-6">
            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2 border-b border-slate-100 dark:border-slate-800">
                <button onclick="switchPlannerTab('overview')" id="tab-overview" class="planner-tab active">Overview</button>
                <button onclick="switchPlannerTab('tips')" id="tab-tips" class="planner-tab">Smart Tips</button>
                <button onclick="switchPlannerTab('roadmap')" id="tab-roadmap" class="planner-tab">Roadmap</button>
            </div>
            <div id="planner-overview" class="space-y-6 animate-fade">
                <div class="glass-card p-6 text-center">
                    <h3 class="text-xs font-bold uppercase opacity-60 mb-4">Financial Health Score</h3>
                    <div class="health-circle mx-auto mb-4"><svg viewBox="0 0 80 80"><circle class="health-track" cx="40" cy="40" r="36"></circle><circle id="planner-score-ring" class="health-progress stroke-indigo-500" cx="40" cy="40" r="36"></circle></svg><span id="planner-score-val" class="absolute text-2xl font-black">0</span></div>
                    <p id="planner-score-status" class="text-sm font-bold text-indigo-600 mb-2">Cukup Baik</p>
                </div>
                <!-- Metrics with Descriptions -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="glass-card p-4"><p class="text-[9px] font-bold uppercase opacity-60">Debt Ratio</p><h4 id="metric-debt" class="text-lg font-black my-1">0%</h4><p class="text-[8px] opacity-70">Total Utang / Total Aset</p><p class="text-[9px] text-emerald-500 font-bold mt-1">Target <30%</p></div>
                    <div class="glass-card p-4"><p class="text-[9px] font-bold uppercase opacity-60">Saving Rate</p><h4 id="metric-saving" class="text-lg font-black my-1">0%</h4><p class="text-[8px] opacity-70">Tabungan / Pendapatan</p><p class="text-[9px] text-indigo-500 font-bold mt-1">Target >20%</p></div>
                    <div class="glass-card p-4"><p class="text-[9px] font-bold uppercase opacity-60">Asset Coverage</p><h4 id="metric-asset" class="text-lg font-black my-1">0 Bln</h4><p class="text-[8px] opacity-70">Aset Lancar / Pengeluaran</p><p class="text-[9px] text-purple-500 font-bold mt-1">Target 6 Bulan</p></div>
                    <div class="glass-card p-4"><p class="text-[9px] font-bold uppercase opacity-60">Expense Ratio</p><h4 id="metric-expense" class="text-lg font-black my-1">0%</h4><p class="text-[8px] opacity-70">Pengeluaran / Pendapatan</p><p class="text-[9px] text-rose-500 font-bold mt-1">Limit <50%</p></div>
                </div>
            </div>
            <!-- Planner: Tips -->
            <div id="planner-tips" class="hidden space-y-4 animate-fade">
                <div class="glass-card p-5 border-l-4 border-emerald-500"><h4 class="font-bold text-sm mb-1">üí° Dana Darurat</h4><p class="text-xs opacity-80">Prioritaskan mengumpulkan 6x pengeluaran bulanan.</p></div>
                <div class="glass-card p-5 border-l-4 border-indigo-500"><h4 class="font-bold text-sm mb-1">üìâ Efisiensi</h4><p class="text-xs opacity-80">Cek langganan berulang yang jarang dipakai.</p></div>
            </div>
            <!-- Planner: Roadmap -->
            <div id="planner-roadmap" class="hidden relative pl-2 animate-fade">
                <div class="roadmap-line"></div>
                <div class="roadmap-item"><div class="roadmap-dot">1</div><div class="glass-card p-4"><h4 class="font-bold text-sm mb-1">Fondasi Keuangan</h4><p class="text-xs opacity-70">Dana Darurat & Lunasi Hutang</p><div class="mt-2 text-[10px] roadmap-target-pill px-2 py-1 rounded w-fit">Target: 6 Bulan</div></div></div>
                <div class="roadmap-item"><div class="roadmap-dot bg-slate-300 text-slate-600">2</div><div class="glass-card p-4 opacity-80"><h4 class="font-bold text-sm mb-1">Akumulasi Aset</h4><p class="text-xs opacity-70">Investasi rutin & Diversifikasi</p><div class="mt-2 text-[10px] roadmap-target-pill px-2 py-1 rounded w-fit">Target: 3 Tahun</div></div></div>
            </div>
        </div>

        <div id="view-budget" class="hidden space-y-6">
             <div class="bg-lime-400 text-lime-950 rounded-3xl p-6 shadow-lg">
                 <div class="flex justify-between items-start mb-4"><h2 class="font-black text-2xl">Budget Saya</h2><span class="text-[10px] font-bold bg-white/30 px-2 py-1 rounded uppercase">On Track</span></div>
                 <div class="mb-2 flex justify-between text-xs font-bold"><span>Terpakai: <span id="budget-used">Rp 0</span></span><span>Total: <span id="budget-total">Rp 0</span></span></div>
                 <div class="w-full bg-black/10 rounded-full h-3 mb-2"><div id="budget-bar-main" class="bg-lime-900 h-3 rounded-full w-0 transition-all duration-500"></div></div>
                 <p id="budget-pct" class="text-right text-[10px] font-black">0% Digunakan</p>
             </div>
             <button onclick="generateAIBudget()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg"><span>‚ú®</span> Buat Budget dengan AI</button>
             
             <!-- Recurring Bills Section (NEW) -->
             <div class="glass-card p-4 border border-indigo-100 dark:border-indigo-900">
                 <div class="flex justify-between items-center mb-3">
                     <h3 class="font-bold text-sm">Tagihan Rutin</h3>
                     <button onclick="toggleModal('recurring-modal', true)" class="text-xs font-bold text-indigo-600">+ Tambah</button>
                 </div>
                 <div id="recurring-list" class="space-y-2">
                     <!-- Injected by JS -->
                     <p class="text-[10px] opacity-60 text-center py-2">Belum ada tagihan rutin.</p>
                 </div>
             </div>

             <div><div class="flex justify-between items-center mb-3"><h3 class="font-bold text-sm">Kategori Budget</h3><button onclick="toggleModal('budget-modal', true)" class="text-xs font-bold text-indigo-600">+ Tambah</button></div><div id="budget-list" class="space-y-3"></div></div>
             <div><h3 class="font-bold text-sm mb-3">Pengeluaran Tanpa Budget</h3><div id="unbudgeted-list" class="space-y-2"></div></div>
        </div>

        <!-- VIEW: ASET (RESTORED) -->
        <div id="view-aset" class="hidden space-y-6">
            <div class="glass-card p-6 bg-slate-900 text-white border-none shadow-xl">
                <p class="text-[10px] font-bold uppercase opacity-60 mb-1">Total Kekayaan Bersih</p><h2 id="asset-net-worth" class="text-3xl font-black mb-4">Rp 0</h2>
                <div class="flex gap-2 text-[10px] font-bold opacity-80"><span class="px-2 py-1 bg-white/10 rounded">Aktif: <span id="asset-count">0</span> Item</span></div>
            </div>
            <div><h3 class="font-bold text-sm mb-3">Komposisi Aset</h3><div id="asset-composition" class="space-y-3"></div></div>
            <div><div class="flex justify-between items-center mb-3"><h3 class="font-bold text-sm">Daftar Aset</h3><button onclick="toggleModal('asset-modal', true)" class="text-xs font-bold text-indigo-600">+ Tambah</button></div><div id="asset-list" class="space-y-3 pb-20"></div></div>
        </div>

        <!-- VIEW: DOMPET (RESTORED) -->
        <div id="view-dompet" class="hidden space-y-8">
            <div class="flex justify-between items-center"><h2 class="text-xl font-black">Dompet Saya</h2><button onclick="toggleModal('wallet-modal', true)" class="w-8 h-8 bg-indigo-600 text-white rounded-lg font-bold">+</button></div>
            <div><h3 class="text-xs font-bold uppercase opacity-60 mb-3 tracking-wider">Saldo & Tabungan</h3><div id="wallet-list-cash" class="space-y-3"></div></div>
            <div><h3 class="text-xs font-bold uppercase opacity-60 mb-3 tracking-wider flex justify-between"><span>Kartu Kredit & Cicilan</span><span class="text-rose-500" id="total-debt">Utang: Rp 0</span></h3><div id="wallet-list-credit" class="space-y-3"></div></div>
        </div>

        <!-- VIEW: GOALS (RESTORED) -->
        <div id="view-goals" class="hidden space-y-6">
             <div class="flex justify-between items-center"><h2 class="text-xl font-black">Target Keuangan</h2><button onclick="toggleModal('goal-modal', true)" class="w-8 h-8 bg-indigo-600 text-white rounded-lg font-bold">+</button></div>
             <div id="goals-list-container" class="space-y-4 pb-20"></div>
        </div>
    </div>

    <!-- FAB ADD BUTTON (WITH MENU) -->
    <div id="fab-menu-overlay" onclick="toggleFabMenu()"></div>
    <div class="fab-action-container" id="fab-actions">
        <div class="fab-action-item" onclick="startVoiceRecognition()">
            <div class="fab-action-label">Rekam Suara</div>
            <div class="fab-action-btn">üé§</div>
        </div>
        <div class="fab-action-item" onclick="openReceiptScanner()">
            <div class="fab-action-label">Foto Struk</div>
            <div class="fab-action-btn">üßæ</div>
        </div>
        <div class="fab-action-item" onclick="switchView('add-tx')">
            <div class="fab-action-label">Manual</div>
            <div class="fab-action-btn">üìù</div>
        </div>
    </div>
    <div id="fab-container" class="fab-btn" onclick="toggleFabMenu()">+</div>

  </main>

  <!-- MODAL: DATE FILTER -->
  <div id="date-range-modal" class="modal-overlay">
      <div class="modal-sheet">
          <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100 dark:border-slate-800">
              <span class="text-xl">üìÖ</span>
              <h2 class="text-lg font-black">Filter Rentang Tanggal</h2>
              <button onclick="toggleDateModal(false)" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center font-bold text-slate-500">‚úï</button>
          </div>
          <h3 class="text-[10px] font-black uppercase tracking-widest opacity-60 mb-3">Pilihan Cepat</h3>
          <div class="quick-select-grid">
              <div onclick="selectQuickRange('today')" class="quick-btn" id="qs-today">Hari Ini</div>
              <div onclick="selectQuickRange('yesterday')" class="quick-btn" id="qs-yesterday">Kemarin</div>
              <div onclick="selectQuickRange('this_month')" class="quick-btn active" id="qs-this_month">Bulan Ini</div>
              <div onclick="selectQuickRange('last_month')" class="quick-btn" id="qs-last_month">Bulan Lalu</div>
              <div onclick="selectQuickRange('this_year')" class="quick-btn" id="qs-this_year">Tahun Ini</div>
              <div onclick="selectQuickRange('all')" class="quick-btn" id="qs-all">Semua Data</div>
          </div>
          <div style="background-color: var(--input-bg);" class="rounded-2xl p-4 mb-4">
              <div class="flex justify-between items-center mb-4">
                  <button onclick="changeCalMonth(-1)" class="w-8 h-8 flex items-center justify-center font-black">‚Üê</button>
                  <h4 id="cal-header-label" class="text-sm font-black uppercase">Januari 2026</h4>
                  <button onclick="changeCalMonth(1)" class="w-8 h-8 flex items-center justify-center font-black">‚Üí</button>
              </div>
              <div class="cal-grid" id="cal-grid-body"></div>
          </div>
          <div class="flex gap-3">
              <button onclick="toggleDateModal(false)" class="flex-1 py-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-bold text-xs text-slate-500">Batal</button>
              <button onclick="applyDateFilter()" class="flex-[2] py-3 bg-indigo-600 text-white rounded-xl font-bold text-xs shadow-lg">Terapkan</button>
          </div>
      </div>
  </div>

  <!-- MODAL: GOOGLE SHEETS INTEGRATION -->
  <div id="gsheet-modal" class="modal-overlay">
      <div class="modal-sheet">
          <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100 dark:border-slate-800">
              <h2 class="text-xl font-black">Pengaturan</h2>
              <button onclick="toggleModal('gsheet-modal', false)" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center font-bold text-slate-500">‚úï</button>
          </div>
          <div class="space-y-6">
              <h3 class="text-sm font-bold uppercase tracking-wide opacity-80">Integrasi Google Sheets</h3>
              <details class="group guide-box rounded-2xl">
                  <summary class="p-4 font-bold text-xs cursor-pointer list-none flex justify-between items-center">
                      <span>üìò Panduan Setup Lengkap</span>
                      <span class="transition group-open:rotate-180">‚ñº</span>
                  </summary>
                  <div class="p-4 pt-0 text-[11px] leading-relaxed opacity-90 border-t border-slate-200 dark:border-slate-600 mt-2">
                      <ol class="list-decimal pl-4 space-y-2 pt-2">
                          <li>Buka Google Spreadsheet baru.</li>
                          <li>Klik menu <b>Extensions</b> > <b>Apps Script</b>.</li>
                          <li>Salin kode dari tombol "Salin Kode" di bawah & tempel ke editor.</li>
                          <li>Klik <b>Deploy</b> > <b>New Deployment</b>.</li>
                          <li>Pilih type: <b>Web App</b>.</li>
                          <li>Execute as: <b>Me</b>.</li>
                          <li>Who has access: <b>Anyone</b> (Penting!).</li>
                          <li>Klik <b>Deploy</b>, lalu salin <b>Web App URL</b>.</li>
                          <li>Paste URL ke aplikasi ini via tombol "Simpan URL".</li>
                      </ol>
                  </div>
              </details>
              <div class="glass-card p-4 flex items-center justify-between">
                  <span class="text-xs font-bold opacity-70">Status Koneksi</span>
                  <div class="flex items-center"><div id="gsheet-dot" class="gsheet-status-dot disconnected"></div><span id="gsheet-text" class="text-xs font-bold">Tidak Terhubung</span></div>
              </div>
              <div>
                  <label class="text-[10px] font-bold uppercase opacity-60 block mb-2">URL Tersimpan</label>
                  <input type="text" id="gsheet-url-display" class="input-field bg-slate-100 dark:bg-slate-800 text-xs py-3 opacity-60 cursor-not-allowed" readonly placeholder="https://script.google.com/macros/s/..." value="">
              </div>
              <div class="flex flex-col gap-3">
                  <button id="btn-edit-url" onclick="toggleEditUrl()" class="w-full py-3 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl font-bold text-sm">Edit URL Apps Script</button>
                  <button onclick="syncToGsheet()" class="w-full py-3 bg-emerald-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-emerald-200">Simpan ke Google Sheets</button>
                  <button onclick="loadFromGsheet()" class="w-full py-3 bg-indigo-50 dark:bg-slate-800 text-indigo-600 dark:text-indigo-400 rounded-xl font-bold text-sm border border-indigo-100 dark:border-slate-700">Ambil dari Google Sheets</button>
                  <button onclick="copyAppsScriptCode()" class="w-full py-3 bg-amber-100 dark:bg-amber-900/30 text-amber-900 dark:text-amber-400 rounded-xl font-bold text-sm border border-amber-200 dark:border-amber-800 flex items-center justify-center gap-2"><span>üìã</span> Salin Kode Apps Script</button>
              </div>
              <div class="note-box p-4 rounded-2xl">
                  <h4 class="text-xs font-bold mb-2">Catatan Penting:</h4>
                  <ul class="text-[10px] space-y-1 list-disc pl-3 opacity-90"><li>URL hanya perlu disimpan sekali.</li><li>Data akan otomatis tersinkronisasi.</li></ul>
              </div>
          </div>
      </div>
  </div>

  <!-- MODAL: ADD TRANSACTION -->
  <div id="view-add-tx" class="fixed inset-0 z-[2500] p-0 hidden flex-col" style="background-color: var(--card-bg);">
       <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center sticky top-0 z-10" style="background-color: var(--card-bg);">
          <h2 class="text-lg font-black tracking-tight" style="color: var(--text-main);">Tambah Transaksi</h2>
          <button onclick="switchView('home')" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center font-bold text-slate-500">‚úï</button>
      </div>
      <div class="flex-1 overflow-y-auto no-scrollbar p-6 space-y-6 pb-24">
          <div class="flex gap-2">
              <div onclick="setTxTypeNew('income')" id="pill-income" class="tx-type-pill">Pemasukan</div>
              <div onclick="setTxTypeNew('expense')" id="pill-expense" class="tx-type-pill active">Pengeluaran</div>
              <div onclick="setTxTypeNew('saving')" id="pill-saving" class="tx-type-pill">Tabungan</div>
              <div onclick="setTxTypeNew('investment')" id="pill-investment" class="tx-type-pill">Investasi</div>
          </div>
          <div>
              <label class="text-[10px] font-bold uppercase opacity-60 block mb-2">Jumlah Nominal</label>
              <div class="relative"><span class="absolute left-0 bottom-2 text-xl font-bold opacity-50">Rp</span><input type="text" id="tx-amount-new" class="big-amount-input pl-10" placeholder="0" oninput="formatInputRibuan(this)">
                <!-- Voice Input Button -->
                <button onclick="startVoiceRecognition()" id="btn-voice" class="absolute right-0 bottom-2 w-10 h-10 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-xl transition-all">üé§</button>
              </div>
          </div>
          <div>
               <label class="text-[10px] font-bold uppercase opacity-60 block mb-3">Pilih Kategori</label>
               <div id="cat-grid-container" class="grid grid-cols-4 gap-3"></div>
               <button onclick="openAddCategoryModal()" class="mt-3 text-xs font-bold text-indigo-600 flex items-center gap-1 cursor-pointer hover:underline">+ Tambah Kategori</button>
          </div>
          <div>
               <label class="text-[10px] font-bold uppercase opacity-60 block mb-2">Tanggal</label>
               <!-- Removed Calendar Icon & Adjusted Padding -->
               <div class="relative"><input type="date" id="tx-date-new" class="input-field py-3 pl-4"></div>
          </div>
          <div>
               <label class="text-[10px] font-bold uppercase opacity-60 block mb-3">Metode Pembayaran</label>
               <div id="pay-grid-container" class="grid grid-cols-3 gap-3"></div>
          </div>
          <div>
               <label class="text-[10px] font-bold uppercase opacity-60 block mb-2">Deskripsi (Opsional)</label>
               <input type="text" id="tx-desc-new" placeholder="Catatan transaksi..." class="input-field py-3">
          </div>
      </div>
      <div class="p-4 border-t border-slate-100 dark:border-slate-800 flex gap-3" style="background-color: var(--card-bg);">
          <button onclick="switchView('home')" class="flex-1 py-4 bg-slate-100 dark:bg-slate-800 text-slate-500 rounded-2xl font-bold text-sm">Batal</button>
          <button onclick="saveTxNew()" class="flex-[2] py-4 bg-indigo-600 text-white rounded-2xl font-bold text-sm shadow-lg shadow-indigo-200">Simpan Transaksi</button>
      </div>
  </div>

  <!-- MODAL: ADD CATEGORY -->
  <div id="modal-add-category" class="fixed inset-0 z-[3000] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
      <div class="w-[90%] max-w-sm rounded-3xl p-6 shadow-2xl border border-slate-100 dark:border-slate-800 transform scale-100 transition-all" style="background-color: var(--card-bg); color: var(--text-main);">
          <h3 class="text-lg font-black mb-4 text-center">Tambah Kategori</h3>
          <div class="flex gap-3 mb-4">
              <input type="text" id="new-cat-emoji" class="w-20 text-center text-2xl border-2 border-slate-200 rounded-2xl py-3 focus:border-indigo-500 outline-none bg-transparent" placeholder="Emoji">
              <input type="text" id="new-cat-name" class="flex-1 border-2 border-slate-200 rounded-2xl px-4 py-3 font-bold focus:border-indigo-500 outline-none bg-transparent" placeholder="Nama Kategori" style="color: var(--text-main);">
          </div>
          <div class="flex gap-3">
              <button onclick="closeAddCategoryModal()" class="flex-1 py-3 bg-slate-100 dark:bg-slate-800 text-slate-500 font-bold rounded-xl">Batal</button>
              <button onclick="saveNewCategoryCustom()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg">Simpan</button>
          </div>
      </div>
  </div>

  <!-- MODAL: REPORT INSIGHTS (RESTORED) -->
  <div id="report-modal" class="modal-overlay">
      <div class="modal-sheet">
          <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-black">Laporan Keuangan</h2>
              <button onclick="toggleModal('report-modal', false)" class="p-2 bg-slate-100 rounded-full font-bold">‚úï</button>
          </div>
          <!-- 1. Insight Section -->
          <div class="mb-6">
              <h3 class="text-xs font-bold uppercase opacity-60 mb-3">Wawasan Cerdas</h3>
              <div class="flex overflow-x-auto gap-3 no-scrollbar pb-2" id="report-insights"></div>
          </div>
          <!-- 2. Health Score -->
          <div class="glass-card p-5 mb-6 text-center bg-slate-50 dark:bg-slate-800">
               <h3 class="text-xs font-bold uppercase opacity-60 mb-4">Skor Finansial Bulan Ini</h3>
               <div class="health-circle mx-auto mb-2 w-24 h-24">
                    <svg viewBox="0 0 80 80"><circle class="health-track" cx="40" cy="40" r="36"></circle><circle id="report-score-ring" class="health-progress stroke-emerald-500" cx="40" cy="40" r="36"></circle></svg><span id="report-score-val" class="absolute text-3xl font-black">0</span>
                </div>
                <p id="report-score-text" class="font-bold text-emerald-600 mb-4">Sangat Baik</p>
                <div class="flex justify-between text-[10px] font-bold px-2 opacity-70">
                    <span class="flex flex-col"><span>Tabungan</span><span id="score-sav">0/100</span></span>
                    <span class="flex flex-col"><span>Budget</span><span id="score-bud">0/100</span></span>
                    <span class="flex flex-col"><span>Aman</span><span id="score-sec">0/100</span></span>
                </div>
          </div>
          <!-- 3. Budget Perf -->
          <div><h3 class="text-xs font-bold uppercase opacity-60 mb-3">Performa Anggaran</h3><div id="report-budget-list" class="space-y-3"></div></div>
      </div>
  </div>

  <!-- OTHER ASSET & WALLET MODALS -->
  <div id="asset-modal" class="modal-overlay"><div class="modal-sheet"><h2 class="text-lg font-black mb-4">Kelola Aset</h2><input id="asset-name" class="input-field mb-2" placeholder="Nama Aset"><select id="asset-type" class="input-field mb-2"><option>Tunai & Tabungan</option><option>Investasi</option><option>Properti</option></select><input id="asset-val" class="input-field mb-2" type="number" placeholder="Nilai (Rp)"><button onclick="saveAsset()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">Simpan</button><button onclick="toggleModal('asset-modal', false)" class="mt-2 w-full py-3 bg-slate-100 rounded-xl font-bold">Batal</button></div></div>
  <div id="wallet-modal" class="modal-overlay"><div class="modal-sheet"><h2 class="text-lg font-black mb-4">Kelola Dompet</h2><input id="wallet-name" class="input-field mb-2" placeholder="Nama Dompet"><input id="wallet-bal" class="input-field mb-2" type="number" placeholder="Saldo Awal"><select id="wallet-type" class="input-field mb-2"><option value="Cash">Cash</option><option value="Bank">Bank</option><option value="Credit">Kartu Kredit</option></select><button onclick="saveWallet()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">Simpan</button><button onclick="toggleModal('wallet-modal', false)" class="mt-2 w-full py-3 bg-slate-100 rounded-xl font-bold">Batal</button></div></div>
  <!-- Budget Modal -->
  <div id="budget-modal" class="modal-overlay"><div class="modal-sheet"><h2 class="text-lg font-black mb-4">Kelola Budget</h2><input id="budget-cat" class="input-field mb-2" placeholder="Kategori (Misal: Makan)"><input id="budget-limit" class="input-field mb-2" type="number" placeholder="Limit Bulanan (Rp)"><button onclick="saveBudget()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">Simpan</button><button onclick="toggleModal('budget-modal', false)" class="mt-2 w-full py-3 bg-slate-100 rounded-xl font-bold">Batal</button></div></div>
  <!-- Goals Modal -->
  <div id="goal-modal" class="modal-overlay"><div class="modal-sheet"><h2 class="text-lg font-black mb-4">Kelola Goals</h2><input id="goal-name" class="input-field mb-2" placeholder="Nama Target"><input id="goal-target" class="input-field mb-2" type="number" placeholder="Nominal Target (Rp)"><input id="goal-current" class="input-field mb-2" type="number" placeholder="Terkumpul Saat Ini (Rp)"><input id="goal-date" class="input-field mb-2" type="date"><button onclick="saveGoal()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">Simpan</button><button onclick="toggleModal('goal-modal', false)" class="mt-2 w-full py-3 bg-slate-100 rounded-xl font-bold">Batal</button></div></div>

<script>
    /* --- DATA STORE --- */
    const DB_KEY = 'finz_data_ultimate_v2'; 
    let data = JSON.parse(localStorage.getItem(DB_KEY)) || {
        user: null,
        settings: { theme: 'neon', gsheet_url: '' },
        tx: [],
        wallets: [{id: 'w1', name: 'Cash', type: 'Cash', balance: 500000}],
        assets: [], 
        goals: [{id:'g1', name:'Dana Darurat', target:10000000, current:2000000, date:'2026-12-31'}], 
        budget: [{cat: 'Makan', limit: 1500000}],
        custom_cats: { income: [], expense: [], saving: [], investment: [] }
    };
    
    // State
    let currentTxType = 'expense';
    let selectedCat = '';
    let selectedPay = 'Cash';
    let filterPeriod = 'this_month';
    let currentTxFilter = 'all'; 
    let calDate = new Date();
    // New: Date Range State
    let rangeStart = null;
    let rangeEnd = null;
    let editingId = null; // For Edit Mode
    let isEditingUrl = false; // For URL Edit
    
    // Configs
    const BASE_CATS = {
        income: [{n:'Gaji', i:'üíº'}, {n:'Bonus', i:'üéÅ'}, {n:'Hadiah', i:'üßß'}, {n:'Lainnya', i:'‚ú®'}],
        expense: [{n:'Makan', i:'üçΩÔ∏è'}, {n:'Transport', i:'üöó'}, {n:'Belanja', i:'üõí'}, {n:'Tagihan', i:'üìÑ'}, {n:'Hiburan', i:'üçø'}, {n:'Kesehatan', i:'üíä'}],
        saving: [{n:'Tabungan', i:'üè¶'}, {n:'Darurat', i:'üÜò'}],
        investment: [{n:'Saham', i:'üìà'}, {n:'Emas', i:'üèÜ'}, {n:'Reksadana', i:'üìä'}]
    };
    const PAY_METHODS = [
        {n:'Tunai', i:'üíµ'}, {n:'Transfer', i:'üè¶'}, {n:'E-Wallet', i:'üì±'}, 
        {n:'K. Kredit', i:'üí≥'}, {n:'K. Debit', i:'üí≥'}, {n:'QRIS', i:'ü§≥'}
    ];
    
    /* --- INIT --- */
    function init() {
        if(data.user) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            if(document.getElementById('set-name')) {
                document.getElementById('set-name').value = data.user.name;
                document.getElementById('set-email').value = data.user.email;
                document.getElementById('settings-name-display').innerText = data.user.name;
                document.getElementById('settings-email-display').innerText = data.user.email;
                if(data.user.avatar) document.getElementById('settings-avatar').src = data.user.avatar;
                setThemeOption(data.settings.theme || 'neon');
                updateGsheetUI();
                
                // Add Listener for Description Input for AI Categorization
                const descInput = document.getElementById('tx-desc-new');
                if(descInput) {
                    descInput.addEventListener('input', (e) => {
                        autoCategorize(e.target.value);
                    });
                }
            }
            switchView('home');
        } else {
            document.getElementById('auth-section').classList.remove('hidden');
        }
    }

    /* --- DATE FILTER LOGIC (CUSTOM RANGE) --- */
    function toggleDateModal(show) {
        document.getElementById('date-range-modal').classList.toggle('active', show);
        if(show) { 
            // Reset temp range if needed, or keep last selected
            renderCalendar(); 
            selectQuickRange(filterPeriod); 
        }
    }
    
    function renderCalendar() {
        const grid = document.getElementById('cal-grid-body');
        grid.innerHTML = ['M','S','S','R','K','J','S'].map(d=>`<div class="opacity-50">${d}</div>`).join('');
        const y = calDate.getFullYear(), m = calDate.getMonth();
        document.getElementById('cal-header-label').innerText = calDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
        const firstDay = new Date(y, m, 1).getDay();
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
        for(let d=1; d<=daysInMonth; d++) {
            const current = new Date(y, m, d);
            let cls = 'cal-day';
            if(rangeStart && rangeEnd) {
                if(current.getTime() === rangeStart.getTime()) cls += ' range-start';
                else if(current.getTime() === rangeEnd.getTime()) cls += ' range-end';
                else if(current > rangeStart && current < rangeEnd) cls += ' in-range';
            } else if (rangeStart && current.getTime() === rangeStart.getTime()) { cls += ' active'; }
            grid.innerHTML += `<div class="${cls}" onclick="pickDate(${d})">${d}</div>`;
        }
    }
    
    function pickDate(d) {
        const picked = new Date(calDate.getFullYear(), calDate.getMonth(), d);
        if(!rangeStart || (rangeStart && rangeEnd)) { rangeStart = picked; rangeEnd = null; } 
        else { if(picked < rangeStart) { rangeEnd = rangeStart; rangeStart = picked; } else { rangeEnd = picked; } }
        filterPeriod = 'custom';
        document.querySelectorAll('.quick-btn').forEach(b => b.classList.remove('active'));
        renderCalendar();
    }
    
    function changeCalMonth(dir) { calDate.setMonth(calDate.getMonth() + dir); renderCalendar(); }
    function selectQuickRange(type) {
        document.querySelectorAll('.quick-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById('qs-'+type); if(btn) btn.classList.add('active');
        filterPeriod = type; rangeStart = null; rangeEnd = null;
        renderCalendar();
    }
    function applyDateFilter() {
        const labels = {'this_month':'Bulan Ini', 'last_month':'Bulan Lalu', 'all':'Semua', 'today':'Hari Ini', 'yesterday':'Kemarin', 'this_year':'Tahun Ini', 'custom': 'Custom'};
        let label = labels[filterPeriod];
        if(filterPeriod === 'custom' && rangeStart) {
            const opts = { day: 'numeric', month: 'short', year: 'numeric' };
            label = rangeStart.toLocaleDateString('id-ID', opts);
            if(rangeEnd) label += ' - ' + rangeEnd.toLocaleDateString('id-ID', opts);
        }
        document.getElementById('home-period-label').innerText = `Periode ‚Äì ${label}`;
        toggleDateModal(false); renderHome();
    }

    /* --- CORE SYSTEM --- */
    function switchView(view) {
        document.querySelectorAll('[id^="view-"]').forEach(el => { if(el.id === 'view-add-tx') { el.classList.remove('flex'); el.classList.add('hidden'); } else el.classList.add('hidden'); });
        if(view === 'add-tx') { document.getElementById('view-add-tx').classList.remove('hidden'); document.getElementById('view-add-tx').classList.add('flex'); prepareAddTxNew(); } 
        else { const el = document.getElementById('view-'+view); if(el) el.classList.remove('hidden'); }
        document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
        const link = document.getElementById('side-'+view); if(link) link.classList.add('active');
        const fab = document.getElementById('fab-container'); if(fab) fab.style.display = view === 'home' ? 'flex' : 'none';
        if(document.getElementById('sidebar').classList.contains('active')) toggleSidebar();
        if(view === 'home') renderHome();
        if(view === 'planner') renderPlanner();
        if(view === 'budget') renderBudget();
        if(view === 'aset') renderAssets();
        if(view === 'dompet') renderWallets();
        if(view === 'goals') renderGoals();
    }

    /* --- ADD TX LOGIC --- */
    function prepareAddTxNew() {
        editingId = null;
        document.getElementById('tx-date-new').valueAsDate = new Date();
        document.getElementById('tx-amount-new').value = '';
        document.getElementById('tx-desc-new').value = '';
        setTxTypeNew('expense');
        const payGrid = document.getElementById('pay-grid-container');
        if(payGrid) payGrid.innerHTML = PAY_METHODS.map(p => `<div class="grid-icon-item ${selectedPay===p.n?'active':''}" onclick="setPaymentNew('${p.n}', this)"><span class="grid-icon-emoji">${p.i}</span><span class="grid-icon-text">${p.n}</span></div>`).join('');
    }

    function editTx(id) {
        const tx = data.tx.find(t => t.id == id);
        if(!tx) return;
        editingId = id;
        switchView('add-tx');
        setTxTypeNew(tx.type);
        document.getElementById('tx-amount-new').value = formatRupiah(tx.amount).replace('Rp ','');
        document.getElementById('tx-date-new').value = tx.date;
        document.getElementById('tx-desc-new').value = tx.desc || '';
        selectedCat = tx.cat;
        selectedPay = tx.payment || 'Tunai';
        // Trigger re-render of grids to show selected
        setTxTypeNew(tx.type); 
    }

    function deleteTx(id) {
        Swal.fire({title:'Hapus Transaksi?', icon:'warning', showCancelButton:true, confirmButtonText:'Ya, Hapus'}).then(res=>{
            if(res.isConfirmed) {
                data.tx = data.tx.filter(t => t.id != id);
                saveData(); renderHome();
            }
        });
    }

    function setTxTypeNew(type) {
        currentTxType = type;
        ['income','expense','saving','investment'].forEach(t => { const el = document.getElementById('pill-'+t); if(el) { if(t === type) el.classList.add('active'); else el.classList.remove('active'); } });
        const catGrid = document.getElementById('cat-grid-container');
        if(catGrid) {
            const base = BASE_CATS[type] || [];
            const custom = data.custom_cats[type] || [];
            const allCats = [...base, ...custom];
            if(!editingId) selectedCat = allCats[0]?.n || ''; 
            catGrid.innerHTML = allCats.map(c => `<div class="grid-icon-item ${selectedCat===c.n?'active':''}" onclick="setCategoryNew('${c.n}', this)"><span class="grid-icon-emoji">${c.i}</span><span class="grid-icon-text">${c.n}</span></div>`).join('');
        }
    }
    function openAddCategoryModal() { document.getElementById('modal-add-category').classList.remove('hidden'); document.getElementById('new-cat-emoji').value = ''; document.getElementById('new-cat-name').value = ''; }
    function closeAddCategoryModal() { document.getElementById('modal-add-category').classList.add('hidden'); }
    function saveNewCategoryCustom() {
        const emoji = document.getElementById('new-cat-emoji').value || '‚ú®';
        const name = document.getElementById('new-cat-name').value;
        if(name) {
            if(!data.custom_cats) data.custom_cats = { income: [], expense: [], saving: [], investment: [] };
            if(!data.custom_cats[currentTxType]) data.custom_cats[currentTxType] = [];
            data.custom_cats[currentTxType].push({n: name, i: emoji});
            saveData(); setTxTypeNew(currentTxType); closeAddCategoryModal();
            Swal.fire({icon:'success', title:'Kategori tersimpan', timer:1000, showConfirmButton:false});
        } else { Swal.fire('Error', 'Nama kategori wajib diisi', 'warning'); }
    }
    function setCategoryNew(name, el) { selectedCat = name; const siblings = el.parentElement.children; for(let sib of siblings) sib.classList.remove('active'); el.classList.add('active'); }
    function setPaymentNew(name, el) { selectedPay = name; const siblings = el.parentElement.children; for(let sib of siblings) sib.classList.remove('active'); el.classList.add('active'); }
    function formatInputRibuan(input) { let val = input.value.replace(/\D/g, ''); if(val) input.value = new Intl.NumberFormat('id-ID').format(val); }
    
    function saveTxNew() {
        const amt = parseInt(document.getElementById('tx-amount-new').value.replace(/\./g,''));
        if(!amt) return Swal.fire('Error','Nominal wajib diisi','warning');
        
        const txObj = {
            id: editingId || Date.now(),
            type: currentTxType,
            amount: amt,
            cat: selectedCat,
            payment: selectedPay,
            date: document.getElementById('tx-date-new').value,
            desc: document.getElementById('tx-desc-new').value || selectedCat
        };

        if(editingId) {
            const idx = data.tx.findIndex(t => t.id == editingId);
            if(idx > -1) data.tx[idx] = txObj;
        } else {
            data.tx.push(txObj);
             if(currentTxType === 'income') data.wallets[0].balance += amt; else if(currentTxType === 'expense') data.wallets[0].balance -= amt;
        }
        
        saveData(); 
        detectAnomaly(txObj); // Trigger AI Anomaly Detection
        switchView('home'); 
        Swal.fire({icon: 'success', title: 'Tersimpan', timer: 1000, showConfirmButton: false});
    }

    /* --- HOME & FILTER LOGIC --- */
    function filterTx(type, btn) {
        currentTxFilter = type; document.querySelectorAll('.filter-chip').forEach(el => el.classList.remove('active'));
        if(btn) btn.classList.add('active'); else if(document.getElementById('chip-'+type)) document.getElementById('chip-'+type).classList.add('active');
        renderHome();
    }
    function renderHome() {
        let txs = getFilteredTxs();
        const inc = txs.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0);
        const exp = txs.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0);
        const sav = txs.filter(t=>t.type==='saving').reduce((a,b)=>a+b.amount,0);
        const inv = txs.filter(t=>t.type==='investment').reduce((a,b)=>a+b.amount,0);
        const total = inc - exp; 
        
        document.getElementById('home-balance').innerText = formatRupiah(total);
        document.getElementById('home-inc').innerText = formatRupiah(inc);
        document.getElementById('home-exp').innerText = formatRupiah(exp);
        document.getElementById('home-sav').innerText = formatRupiah(sav);
        document.getElementById('home-inv').innerText = formatRupiah(inv);

        // Chart Update Logic
        const totalVol = inc + exp + sav + inv;
        let currentOffset = 0;
        const updateSegment = (id, val, labelId) => {
             const el = document.getElementById(id);
             const lbl = document.getElementById(labelId);
             const pct = totalVol > 0 ? (val / totalVol) : 0;
             const len = pct * 251.2; 
             if(el) {
                 el.style.strokeDasharray = `${len} 251.2`;
                 el.style.strokeDashoffset = -currentOffset;
             }
             if(lbl) lbl.innerText = Math.round(pct * 100) + '%';
             currentOffset += len;
        };
        updateSegment('d-inc', inc, 'l-inc');
        updateSegment('d-exp', exp, 'l-exp');
        updateSegment('d-sav', sav, 'l-sav');
        updateSegment('d-inv', inv, 'l-inv');

        // Real-time Home Cards (FIXED)
        // 1. Top Expense
        const expenseTxs = txs.filter(t => t.type === 'expense');
        const sortedExp = expenseTxs.sort((a,b) => b.amount - a.amount);
        const top = sortedExp[0];
        document.getElementById('top-expense-val').innerText = top ? formatRupiah(top.amount) : 'Rp 0';
        document.getElementById('top-expense-cat').innerText = top ? top.cat : '-';

        // 2. Upcoming Bills (H+7)
        const today = new Date(); today.setHours(0,0,0,0);
        const nextWeek = new Date(today); nextWeek.setDate(today.getDate() + 7);
        const bills = data.tx.filter(t => {
            const d = new Date(t.date);
            return t.type === 'expense' && d > today && d <= nextWeek;
        });
        document.getElementById('upcoming-bills-count').innerText = `${bills.length} Tagihan`;


        if(currentTxFilter !== 'all') { txs = txs.filter(t => t.type === currentTxFilter); }
        const list = document.getElementById('tx-list-container');
        if(txs.length === 0) list.innerHTML = '<p class="text-center opacity-50 text-xs py-10">Belum ada transaksi</p>';
        else {
            list.innerHTML = txs.slice().reverse().slice(0,10).map(t => {
                const color = t.type==='income'?'text-emerald-500': t.type==='saving'?'text-blue-500': t.type==='investment'?'text-purple-500': 'text-rose-500';
                const sign = t.type==='income'?'+': t.type==='expense'?'-':'';
                return `<div class="glass-card px-4 py-3 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center text-lg">${t.type==='income'?'üí∞': t.type==='saving'?'üè¶': t.type==='investment'?'üìà':'üí∏'}</div>
                        <div><p class="text-xs font-bold">${t.cat}</p><p class="text-[10px] opacity-60">${t.date} ‚Ä¢ ${t.desc}</p></div>
                    </div>
                    <div class="flex items-center gap-3">
                         <p class="text-xs font-black ${color}">${sign} ${formatRupiah(t.amount)}</p>
                         <div class="flex gap-1">
                             <div onclick="editTx(${t.id})" class="action-btn action-btn-edit">‚úé</div>
                             <div onclick="deleteTx(${t.id})" class="action-btn action-btn-del">üóë</div>
                         </div>
                    </div>
                </div>`;
            }).join('');
        }
    }
    function getFilteredTxs() {
        const now = new Date();
        if(filterPeriod === 'custom' && rangeStart && rangeEnd) {
            return data.tx.filter(t => { const d = new Date(t.date); const start = new Date(rangeStart); start.setHours(0,0,0,0); const end = new Date(rangeEnd); end.setHours(23,59,59,999); return d >= start && d <= end; });
        }
        if(filterPeriod === 'all') return data.tx;
        return data.tx.filter(t => {
            const d = new Date(t.date);
            if(filterPeriod === 'today') return d.toDateString() === now.toDateString();
            if(filterPeriod === 'yesterday') { const y = new Date(now); y.setDate(y.getDate()-1); return d.toDateString() === y.toDateString(); }
            if(filterPeriod === 'this_month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            if(filterPeriod === 'last_month') { const last = new Date(now.getFullYear(), now.getMonth()-1, 1); return d.getMonth() === last.getMonth() && d.getFullYear() === last.getFullYear(); }
            if(filterPeriod === 'this_year') return d.getFullYear() === now.getFullYear();
            return true;
        });
    }

    /* --- RESTORED FUNCTIONS (REPORTS, PLANNER, BUDGET, ASSETS, GOALS) --- */
    function openReportModal() {
        toggleModal('report-modal', true);
        const insightsDiv = document.getElementById('report-insights'); if(insightsDiv) insightsDiv.innerHTML = '';
        const txs = getFilteredTxs(); const expTxs = txs.filter(t=>t.type==='expense');
        data.budget.forEach(b => {
             const used = expTxs.filter(t=>t.cat===b.cat).reduce((a,x)=>a+x.amount,0);
             const pct = b.limit>0 ? Math.round((used/b.limit)*100) : 0;
             if(pct > 80 && insightsDiv) insightsDiv.innerHTML += `<div class="glass-card p-3 min-w-[140px] border-l-4 border-rose-500 bg-rose-50"><p class="text-[9px] font-bold text-rose-600 uppercase">Warning</p><p class="text-xs font-bold my-1">${b.cat}</p><p class="text-[10px]">${pct}% dari Budget</p></div>`;
        });
        const cats = {}; expTxs.forEach(t=>cats[t.cat]=(cats[t.cat]||0)+1);
        const topCat = Object.entries(cats).sort((a,b)=>b[1]-a[1])[0];
        if(topCat && insightsDiv) insightsDiv.innerHTML += `<div class="glass-card p-3 min-w-[140px] border-l-4 border-indigo-500"><p class="text-[9px] font-bold text-indigo-600 uppercase">Kebiasaan</p><p class="text-xs font-bold my-1">${topCat[0]}</p><p class="text-[10px]">${topCat[1]}x Transaksi</p></div>`;
        const inc = txs.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0);
        const sav = txs.filter(t=>t.type==='saving').reduce((a,b)=>a+b.amount,0);
        const savRate = inc>0 ? Math.round((sav/inc)*100) : 0;
        if(insightsDiv) insightsDiv.innerHTML += `<div class="glass-card p-3 min-w-[140px] border-l-4 border-emerald-500"><p class="text-[9px] font-bold text-emerald-600 uppercase">Saving Rate</p><p class="text-xs font-bold my-1">${savRate}%</p><p class="text-[10px]">Dari Pemasukan</p></div>`;
        
        let score = Math.min(100, savRate * 2 + 40); 
        const scoreVal = document.getElementById('report-score-val'); if(scoreVal) scoreVal.innerText = score;
        const scoreRing = document.getElementById('report-score-ring'); if(scoreRing) scoreRing.style.strokeDashoffset = 226 - (score/100 * 226);
        const scoreText = document.getElementById('report-score-text'); if(scoreText) scoreText.innerText = score > 80 ? 'Sangat Sehat' : score > 50 ? 'Cukup Baik' : 'Perlu Perhatian';
        const scoreSav = document.getElementById('score-sav'); if(scoreSav) scoreSav.innerText = savRate + '/100';
        const scoreBud = document.getElementById('score-bud'); if(scoreBud) scoreBud.innerText = '80/100';
        const scoreSec = document.getElementById('score-sec'); if(scoreSec) scoreSec.innerText = '90/100';

        const bList = document.getElementById('report-budget-list'); 
        if(bList) {
            bList.innerHTML = '';
            data.budget.forEach(b => {
                 const used = expTxs.filter(t=>t.cat===b.cat).reduce((a,x)=>a+x.amount,0);
                 const pct = b.limit>0 ? Math.min((used/b.limit)*100, 100) : 0;
                 let color = 'bg-emerald-500'; if(pct > 80) color = 'bg-rose-500';
                 bList.innerHTML += `<div class="flex items-center gap-3 text-xs"><span class="w-16 font-bold truncate">${b.cat}</span><div class="flex-1 h-2 bg-slate-100 rounded-full"><div class="${color} h-full rounded-full" style="width:${pct}%"></div></div><span class="w-12 text-right text-[10px] font-bold">${Math.round(pct)}%</span></div>`;
            });
        }
    }

    function renderPlanner() {
        switchPlannerTab('overview');
        // Metrics Logic
        const debt = data.wallets.filter(w=>w.type==='Credit').reduce((a,b)=>a+Math.abs(b.balance),0);
        const asset = data.assets.reduce((a,b)=>a+b.value,0) + data.wallets.filter(w=>w.type!=='Credit').reduce((a,b)=>a+b.balance,0);
        const debtRatio = asset>0 ? Math.round((debt/asset)*100) : 0;
        document.getElementById('metric-debt').innerText = debtRatio + '%';
        document.getElementById('metric-asset').innerText = Math.round(asset/2000000) + ' Bln'; 
    }

    function renderBudget() {
        const txs = getFilteredTxs().filter(t=>t.type==='expense');
        const totalExp = txs.reduce((a,b)=>a+b.amount,0);
        const totalBud = data.budget.reduce((a,b)=>a+b.limit,0);
        document.getElementById('budget-used').innerText = formatRupiah(totalExp);
        document.getElementById('budget-total').innerText = formatRupiah(totalBud);
        const pct = totalBud>0 ? Math.min((totalExp/totalBud)*100, 100) : 0;
        document.getElementById('budget-bar-main').style.width = pct + '%';
        document.getElementById('budget-pct').innerText = Math.round(pct) + '% Digunakan';
        
        const list = document.getElementById('budget-list'); list.innerHTML = '';
        data.budget.forEach(b => {
            const used = txs.filter(t=>t.cat===b.cat).reduce((a,x)=>a+x.amount,0);
            const bpct = b.limit>0 ? Math.min((used/b.limit)*100, 100) : 0;
            list.innerHTML += `<div class="glass-card p-4">
                <div class="flex justify-between text-xs font-bold mb-2"><span>${b.cat}</span><span>${formatRupiah(used)} / ${formatRupiah(b.limit)}</span></div>
                <div class="w-full h-2 bg-slate-100 rounded-full mb-3"><div class="h-full bg-indigo-500 rounded-full" style="width:${bpct}%"></div></div>
                <div class="flex justify-end gap-2"><div onclick="editBudget('${b.cat}')" class="action-btn action-btn-edit text-[10px]">‚úé</div><div onclick="deleteBudget('${b.cat}')" class="action-btn action-btn-del text-[10px]">üóë</div></div>
            </div>`;
        });
        
        const budCats = data.budget.map(b=>b.cat);
        const unBud = {};
        txs.filter(t=>!budCats.includes(t.cat)).forEach(t=>unBud[t.cat]=(unBud[t.cat]||0)+t.amount);
        const unList = document.getElementById('unbudgeted-list'); unList.innerHTML = '';
        Object.entries(unBud).forEach(([cat,val]) => {
            unList.innerHTML += `<div class="glass-card p-3 flex justify-between text-xs font-bold"><span>${cat}</span><span class="text-rose-500">${formatRupiah(val)}</span></div>`;
        });
        
        // Render Recurring List
        const recList = document.getElementById('recurring-list');
        recList.innerHTML = '';
        if(data.recurring.length === 0) recList.innerHTML = '<p class="text-[10px] opacity-60 text-center py-2">Belum ada tagihan rutin.</p>';
        else {
             data.recurring.forEach(r => {
                 recList.innerHTML += `<div class="flex justify-between items-center text-xs p-2 border-b border-slate-100 dark:border-slate-800 last:border-0">
                     <div><b>${r.name}</b> <span class="opacity-70">(${r.cat})</span></div>
                     <div class="flex items-center gap-2"><span>${formatRupiah(r.amount)}</span> <span onclick="deleteRecurring(${r.id})" class="text-rose-500 cursor-pointer">üóë</span></div>
                 </div>`;
             });
        }
    }
    
    function editBudget(cat) {
        const b = data.budget.find(x => x.cat === cat);
        document.getElementById('budget-cat').value = b.cat;
        document.getElementById('budget-limit').value = b.limit;
        editingId = cat; // Use category as ID for simple key
        toggleModal('budget-modal', true);
    }
    function deleteBudget(cat) {
        Swal.fire({title:'Hapus Budget?', showCancelButton:true}).then(r=>{if(r.isConfirmed){ data.budget=data.budget.filter(b=>b.cat!==cat); saveData(); renderBudget(); }});
    }
    function saveBudget() {
        const cat = document.getElementById('budget-cat').value;
        const lim = parseInt(document.getElementById('budget-limit').value);
        if(cat && lim) {
            const newB = {cat, limit:lim};
            if(editingId) {
                const idx = data.budget.findIndex(b => b.cat === editingId);
                if(idx > -1) data.budget[idx] = newB;
            } else data.budget.push(newB);
            saveData(); renderBudget(); toggleModal('budget-modal',false);
        }
    }
    function generateAIBudget() {
        Swal.fire({title: 'ü§ñ AI Menganalisa...', text: 'Mempelajari pola pengeluaranmu', didOpen: () => Swal.showLoading()});
        setTimeout(() => {
            const expenses = data.tx.filter(t => t.type === 'expense');
            const catTotals = {}; expenses.forEach(t => catTotals[t.cat] = (catTotals[t.cat] || 0) + t.amount);
            const newBudget = Object.keys(catTotals).map(cat => ({
                cat: cat,
                limit: Math.ceil(catTotals[cat] * 1.2 / 1000) * 1000 // Average + 20% buffer
            }));
            if(newBudget.length === 0) {
                 newBudget.push({cat: 'Makan', limit: 1500000});
                 newBudget.push({cat: 'Transport', limit: 500000});
            }
            data.budget = newBudget; saveData(); renderBudget();
            Swal.fire('Selesai!', 'Budget cerdas telah dibuat (+20% buffer aman).', 'success');
        }, 1500);
    }

    function renderAssets() {
        const total = data.assets.reduce((a,b)=>a+b.value,0) + data.wallets.filter(w=>w.type!=='Credit').reduce((a,b)=>a+b.balance,0);
        document.getElementById('asset-net-worth').innerText = formatRupiah(total);
        document.getElementById('asset-count').innerText = data.assets.length + data.wallets.length;
        const types = {}; [...data.assets, ...data.wallets].forEach(a => { const t = a.type || 'Other'; types[t] = (types[t]||0) + (a.value || a.balance); });
        const compDiv = document.getElementById('asset-composition'); compDiv.innerHTML = '';
        Object.entries(types).forEach(([t,v]) => {
            if(v > 0) compDiv.innerHTML += `<div class="flex justify-between text-xs mb-1"><span>${t}</span><span>${Math.round((v/total)*100)}%</span></div><div class="w-full h-1.5 bg-slate-100 rounded-full mb-2"><div class="h-full bg-emerald-500 rounded-full" style="width:${(v/total)*100}%"></div></div>`;
        });
        const list = document.getElementById('asset-list'); list.innerHTML = '';
        data.assets.forEach(a => list.innerHTML += `<div class="glass-card p-4 flex justify-between items-center"><div><p class="font-bold text-sm">${a.name}</p><p class="text-[10px] opacity-60">${a.type}</p></div><div class="text-right"><p class="font-bold text-emerald-600 mb-1">${formatRupiah(a.value)}</p><div class="flex gap-1 justify-end"><div onclick="editAsset(${a.id})" class="action-btn action-btn-edit text-[10px]">‚úé</div><div onclick="deleteAsset(${a.id})" class="action-btn action-btn-del text-[10px]">üóë</div></div></div></div>`);
    }
    function editAsset(id) {
        const a = data.assets.find(x => x.id == id);
        document.getElementById('asset-name').value = a.name;
        document.getElementById('asset-val').value = a.value;
        editingId = id; toggleModal('asset-modal', true);
    }
    function deleteAsset(id) {
        Swal.fire({title:'Hapus Aset?', showCancelButton:true}).then(r=>{if(r.isConfirmed){ data.assets=data.assets.filter(a=>a.id!=id); saveData(); renderAssets(); }});
    }
    function saveAsset() {
        const n = document.getElementById('asset-name').value; const v = parseInt(document.getElementById('asset-val').value);
        if(n && v) { 
            const newA = {id: editingId || Date.now(), name:n, value:v, type: document.getElementById('asset-type').value};
            if(editingId) { const idx = data.assets.findIndex(x=>x.id==editingId); if(idx>-1) data.assets[idx]=newA; }
            else data.assets.push(newA);
            saveData(); renderAssets(); toggleModal('asset-modal',false); 
        }
    }

    function renderWallets() {
        const cashList = document.getElementById('wallet-list-cash'); cashList.innerHTML = '';
        const credList = document.getElementById('wallet-list-credit'); credList.innerHTML = '';
        let debt = 0;
        data.wallets.forEach(w => {
            const html = `<div class="glass-card p-4 ${w.type==='Credit'?'credit-card-bg':'wallet-card-bg'} text-white"><div class="flex justify-between mb-4"><span class="text-xs font-bold uppercase">${w.name}</span><span>${w.type==='Credit'?'üí≥':'üè¶'}</span></div><p class="text-xl font-black mb-2">${w.type==='Credit'?'-':''}${formatRupiah(Math.abs(w.balance))}</p><div class="flex gap-2 justify-end"><div onclick="editWallet(${w.id})" class="text-[10px] cursor-pointer opacity-80 hover:opacity-100">‚úé Edit</div><div onclick="deleteWallet(${w.id})" class="text-[10px] cursor-pointer opacity-80 hover:opacity-100">üóë Hapus</div></div></div>`;
            if(w.type === 'Credit') { debt += Math.abs(w.balance); credList.innerHTML += html; } else cashList.innerHTML += html;
        });
        document.getElementById('total-debt').innerText = `Utang: ${formatRupiah(debt)}`;
    }
    function editWallet(id) {
        const w = data.wallets.find(x => x.id == id);
        document.getElementById('wallet-name').value = w.name;
        document.getElementById('wallet-bal').value = w.balance;
        editingId = id; toggleModal('wallet-modal', true);
    }
    function deleteWallet(id) {
        Swal.fire({title:'Hapus Dompet?', showCancelButton:true}).then(r=>{if(r.isConfirmed){ data.wallets=data.wallets.filter(w=>w.id!=id); saveData(); renderWallets(); }});
    }
    function saveWallet() {
        const n = document.getElementById('wallet-name').value; const v = parseInt(document.getElementById('wallet-bal').value);
        if(n && !isNaN(v)) { 
            const newW = {id: editingId || Date.now(), name:n, balance:v, type: document.getElementById('wallet-type').value};
            if(editingId) { const idx = data.wallets.findIndex(x=>x.id==editingId); if(idx>-1) data.wallets[idx]=newW; }
            else data.wallets.push(newW);
            saveData(); renderWallets(); toggleModal('wallet-modal',false); 
        }
    }

    function renderGoals() {
        const list = document.getElementById('goals-list-container'); list.innerHTML = '';
        data.goals.forEach(g => {
            const today = new Date(); const target = new Date(g.date);
            const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            const months = Math.max(1, Math.ceil(diff/30));
            const remain = g.target - g.current;
            const monthly = remain > 0 ? remain / months : 0;
            const pct = Math.min((g.current/g.target)*100, 100);
            
            list.innerHTML += `<div class="glass-card p-5">
                <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-sm">${g.name}</h3><span class="text-[10px] font-bold bg-indigo-50 text-indigo-600 px-2 py-1 rounded">Sisa ${diff} Hari</span></div>
                <div class="flex justify-between text-xs mb-1"><span class="font-bold text-emerald-600">${formatRupiah(g.current)}</span><span class="opacity-60">Target: ${formatRupiah(g.target)}</span></div>
                <div class="w-full h-2 bg-slate-100 rounded-full mb-3 overflow-hidden"><div class="h-full bg-indigo-500" style="width:${pct}%"></div></div>
                <div class="flex items-center gap-2 text-[10px] goal-saving-box font-bold bg-slate-50 dark:bg-slate-800 p-2 rounded mb-3"><span>üí°</span><span>Perlu menabung <b>${formatRupiah(monthly)}</b> / bulan</span></div>
                <div class="flex justify-end gap-2 border-t border-slate-100 pt-2"><button onclick="editGoal('${g.id}')" class="text-xs font-bold text-indigo-600">Edit</button><button onclick="deleteGoal('${g.id}')" class="text-xs font-bold text-rose-600">Hapus</button><button onclick="openForecastModal('${g.id}')" class="text-xs font-bold text-purple-600">Prediksi</button></div>
            </div>`;
        });
    }
    function editGoal(id) {
        const g = data.goals.find(x => x.id == id);
        document.getElementById('goal-name').value = g.name;
        document.getElementById('goal-target').value = g.target;
        document.getElementById('goal-current').value = g.current;
        document.getElementById('goal-date').value = g.date;
        editingId = id; toggleModal('goal-modal', true);
    }
    function deleteGoal(id) {
        Swal.fire({title:'Hapus Goal?', showCancelButton:true}).then(r=>{if(r.isConfirmed){ data.goals=data.goals.filter(g=>g.id!=id); saveData(); renderGoals(); }});
    }
    function saveGoal() {
        const name = document.getElementById('goal-name').value;
        const target = parseInt(document.getElementById('goal-target').value);
        const current = parseInt(document.getElementById('goal-current').value);
        const date = document.getElementById('goal-date').value;
        if(name && target) {
            const newG = {id: editingId || 'g'+Date.now(), name, target, current: current||0, date};
            if(editingId) { const idx = data.goals.findIndex(x=>x.id==editingId); if(idx>-1) data.goals[idx]=newG; }
            else data.goals.push(newG);
            saveData(); renderGoals(); toggleModal('goal-modal',false);
        }
    }

    function switchPlannerTab(tab) {
        ['overview','tips','roadmap'].forEach(t => { document.getElementById('planner-'+t).classList.add('hidden'); document.getElementById('tab-'+t).classList.remove('active'); });
        document.getElementById('planner-'+tab).classList.remove('hidden'); document.getElementById('tab-'+tab).classList.add('active');
    }
    function toggleModal(id,show){ 
        if(!show) editingId = null; // Clear edit mode on close
        document.getElementById(id).classList.toggle('active', show); 
    }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('sidebar-overlay').classList.toggle('active'); }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function formatRupiah(num) { return 'Rp ' + new Intl.NumberFormat('id-ID').format(num); }
    function setThemeOption(theme) {
        data.settings.theme = theme;
        document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
        const opt = document.getElementById('theme-opt-'+theme); if(opt) opt.classList.add('active');
        document.body.className = 'theme-'+theme;
    }
    function saveSettings() {
        if(document.getElementById('set-name')) data.user.name = document.getElementById('set-name').value;
        saveData();
        Swal.fire({icon: 'success', title: 'Tersimpan', timer: 1500, showConfirmButton: false});
    }
    function handleLogin() { const e = document.getElementById('login-email').value; if(e) { data.user = {name:'User', email:e}; saveData(); init(); } }
    function fillDemo() { document.getElementById('login-email').value = 'demo@finz.com'; }
    function handleLogout() { data.user = null; saveData(); location.reload(); }
    function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(data)); }
    function updateGsheetUI() { /* Gsheet logic */ }
    
    function toggleEditUrl() {
        const input = document.getElementById('gsheet-url-display');
        const btn = document.getElementById('btn-edit-url');
        
        if (!isEditingUrl) {
            // Enable Edit
            input.removeAttribute('readonly');
            input.classList.remove('opacity-60', 'cursor-not-allowed');
            input.focus();
            btn.innerText = 'Simpan URL Apps Script';
            btn.classList.remove('bg-slate-100', 'text-slate-600');
            btn.classList.add('bg-indigo-600', 'text-white');
            isEditingUrl = true;
        } else {
            // Save
            const newUrl = input.value.trim();
            if (newUrl) {
                data.settings.gsheet_url = newUrl;
                saveData();
                updateGsheetUI();
                Swal.fire('Tersimpan', 'URL Apps Script berhasil disimpan.', 'success');
            }
            
            // Disable Edit
            input.setAttribute('readonly', true);
            input.classList.add('opacity-60', 'cursor-not-allowed');
            btn.innerText = 'Edit URL Apps Script';
            btn.classList.remove('bg-indigo-600', 'text-white');
            btn.classList.add('bg-slate-100', 'text-slate-600');
            isEditingUrl = false;
        }
    }

    function editGsheetUrl() { /* ... replaced by toggleEditUrl ... */ } 
    function syncToGsheet() { 
        if(!data.settings.gsheet_url) return Swal.fire('Error','URL belum diatur','error');
        Swal.fire({title:'Menyimpan...', didOpen:()=>Swal.showLoading()});
        
        fetch(data.settings.gsheet_url, {
            method: 'POST',
            mode: 'no-cors', // Important for GAS
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        }).then(() => {
            Swal.fire('Sukses','Data tersimpan ke Google Sheets','success');
        }).catch(e => Swal.fire('Error', 'Gagal menyimpan: ' + e, 'error'));
    }

    function loadFromGsheet() { 
        if(!data.settings.gsheet_url) return Swal.fire('Error','URL belum diatur','error');
        Swal.fire({title:'Mengambil Data...', didOpen:()=>Swal.showLoading()});
        
        fetch(data.settings.gsheet_url)
        .then(r => r.json())
        .then(d => {
            data = d;
            saveData();
            init();
            Swal.fire('Sukses','Data berhasil dimuat','success');
        }).catch(e => Swal.fire('Error', 'Gagal memuat: ' + e, 'error'));
    }
    
    function copyAppsScriptCode() {
        const code = `function doGet(e) {
  var s = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
  var json = s.getRange("A1").getValue();
  return ContentService.createTextOutput(json).setMimeType(ContentService.MimeType.JSON);
}
function doPost(e) {
  var s = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
  s.getRange("A1").setValue(e.postData.contents);
  return ContentService.createTextOutput(JSON.stringify({status:"success"})).setMimeType(ContentService.MimeType.JSON);
}`;
        const textArea = document.createElement("textarea");
        textArea.value = code;
        textArea.style.position = "fixed"; // Prevent scrolling
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try { 
            const successful = document.execCommand('copy'); 
            if(successful) Swal.fire('Tersalin', 'Kode berhasil disalin', 'success');
            else Swal.fire('Error', 'Gagal menyalin. Silakan salin manual.', 'error');
        } catch (err) { 
            Swal.fire('Error', 'Gagal menyalin kode', 'error'); 
        }
        document.body.removeChild(textArea);
    }
    function changeAvatar() { document.getElementById('avatar-input').click(); }
    function previewAvatar(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { document.getElementById('settings-avatar').src = e.target.result; if(data.user) { data.user.avatar = e.target.result; saveData(); } }; reader.readAsDataURL(input.files[0]); } }
    
    // AI FEATURES (RESTORED & FIXED)
    function autoCategorize(text) {
        if(!text) return;
        const lowerText = text.toLowerCase();
        
        const keywords = {
            'makan': 'Makan', 'minum': 'Makan', 'kopi': 'Makan', 'warteg': 'Makan', 'cafe': 'Makan',
            'bensin': 'Transport', 'grab': 'Transport', 'gojek': 'Transport', 'parkir': 'Transport',
            'gaji': 'Gaji', 'bonus': 'Bonus',
            'belanja': 'Belanja', 'supermarket': 'Belanja', 'indomaret': 'Belanja',
            'saham': 'Saham', 'reksadana': 'Reksadana', 'listrik': 'Tagihan', 'air': 'Tagihan'
        };

        for (const [key, cat] of Object.entries(keywords)) {
            if (lowerText.includes(key)) {
                if (['Makan', 'Transport', 'Belanja', 'Tagihan'].includes(cat)) setTxTypeNew('expense');
                else if (['Gaji', 'Bonus'].includes(cat)) setTxTypeNew('income');
                else if (['Saham', 'Reksadana'].includes(cat)) setTxTypeNew('investment');
                
                const catItems = document.querySelectorAll('#cat-grid-container .grid-icon-item');
                catItems.forEach(item => {
                    if(item.querySelector('.grid-icon-text').innerText === cat) item.click();
                });
                break;
            }
        }
    }
    
    function toggleAICoach() {
        document.getElementById('ai-sidebar').classList.toggle('active');
        document.getElementById('sidebar-overlay').classList.toggle('active');
    }

    function sendChatSidebar() {
        const input = document.getElementById('chat-input-sidebar');
        const text = input.value;
        if(!text) return;
        
        const history = document.getElementById('chat-history-sidebar');
        history.innerHTML += `<div class="chat-bubble chat-user">${text}</div>`;
        input.value = '';
        
        let response = "Maaf, saya kurang paham. Coba tanya tentang saldo atau saran hemat.";
        const lowerText = text.toLowerCase();
        
        const totalBal = data.wallets.reduce((a,b)=>a+b.balance,0);
        
        if(lowerText.includes('saldo') || lowerText.includes('uang')) {
            response = `Total saldomu saat ini adalah ${formatRupiah(totalBal)}. Aman terkendali!`;
        } else if (lowerText.includes('boros') || lowerText.includes('hemat')) {
            const cats = {}; 
            data.tx.filter(t=>t.type==='expense').forEach(t => cats[t.cat] = (cats[t.cat]||0) + t.amount);
            const top = Object.entries(cats).sort((a,b)=>b[1]-a[1])[0];
            if(top) response = `Hati-hati, pengeluaran terbesarmu di kategori **${top[0]}** sebesar ${formatRupiah(top[1])}. Coba kurangi ya!`;
            else response = "Pengeluaranmu masih stabil kok.";
        }
        
        setTimeout(() => {
            history.innerHTML += `<div class="chat-bubble chat-bot">${response}</div>`;
            history.scrollTop = history.scrollHeight;
        }, 800);
    }
    
    function openReceiptScanner() { toggleModal('receipt-modal', true); }
    
    function processReceipt() {
        const text = document.getElementById('receipt-text').value;
        if(!text) return;
        
        const lines = text.split('\n');
        let count = 0;
        
        lines.forEach(line => {
            const match = line.match(/(\D+)(\d+)/);
            if(match) {
                const desc = match[1].trim();
                const amount = parseInt(match[2]);
                let type = 'expense';
                let cat = 'Belanja'; 
                
                data.tx.push({
                    id: Date.now() + Math.random(),
                    type: type,
                    amount: amount,
                    cat: cat,
                    payment: 'Tunai',
                    date: new Date().toISOString().split('T')[0],
                    desc: desc
                });
                
                data.wallets[0].balance -= amount;
                count++;
            }
        });
        
        saveData();
        toggleModal('receipt-modal', false);
        Swal.fire('Sukses', `Berhasil memproses ${count} item dari struk!`, 'success');
        renderHome();
    }

    function detectAnomaly(newTx) {
        if(newTx.type !== 'expense') return;
        const history = data.tx.filter(t => t.type === 'expense' && t.cat === newTx.cat && t.id !== newTx.id);
        if(history.length < 3) return; 
        const total = history.reduce((a,b) => a+b.amount, 0);
        const avg = total / history.length;
        if (newTx.amount > avg * 3) {
             setTimeout(() => {
                 toggleAICoach();
                 const historyChat = document.getElementById('chat-history-sidebar');
                 historyChat.innerHTML += `<div class="chat-bubble chat-bot bg-rose-100 text-rose-800 border-rose-200">üö® <b>Peringatan Boros!</b><br>Transaksi ${newTx.cat} sebesar ${formatRupiah(newTx.amount)} jauh diatas rata-rata biasamu (${formatRupiah(avg)}).</div>`;
             }, 1000);
        }
    }
    
    function startVoiceRecognition() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            Swal.fire('Error', 'Browser tidak mendukung fitur suara', 'error');
            return;
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'id-ID';
        recognition.interimResults = false;
        const btn = document.getElementById('btn-voice');
        if (btn) btn.classList.add('voice-active');
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            parseVoiceInput(transcript);
            if (btn) btn.classList.remove('voice-active');
            Swal.fire({ icon: 'success', title: 'Suara Terdeteksi', text: `"${transcript}"`, timer: 1500, showConfirmButton: false });
        };
        recognition.onerror = function(event) { if (btn) btn.classList.remove('voice-active'); console.error(event.error); };
        recognition.onend = function() { if (btn) btn.classList.remove('voice-active'); };
        // Ensure view is open
        switchView('add-tx');
        recognition.start();
    }
    
    function parseVoiceInput(text) {
        const numbers = text.match(/\d+/g);
        let amount = 0;
        let multiplier = 1;
        if (text.toLowerCase().includes('juta')) multiplier = 1000000;
        else if (text.toLowerCase().includes('ribu')) multiplier = 1000;
        if (numbers) {
            const rawNum = parseInt(numbers.join(''));
            amount = rawNum;
            if (amount < 1000 && multiplier > 1) amount *= multiplier;
        }
        if (amount > 0) { document.getElementById('tx-amount-new').value = new Intl.NumberFormat('id-ID').format(amount); }
        document.getElementById('tx-desc-new').value = text;
        autoCategorize(text);
    }
    
    function checkRecurringBills() {
        if (!data.recurring) data.recurring = [];
        const today = new Date();
        const currentDay = today.getDate();
        const currentMonth = today.getMonth() + '-' + today.getFullYear();
        let processed = false;
        data.recurring.forEach(bill => {
            if (currentDay >= bill.day && bill.lastPaidMonth !== currentMonth) {
                data.tx.push({ id: Date.now() + Math.random(), type: 'expense', amount: bill.amount, cat: bill.cat, payment: 'Tunai', date: today.toISOString().split('T')[0], desc: 'Tagihan Otomatis: ' + bill.name });
                data.wallets[0].balance -= bill.amount;
                bill.lastPaidMonth = currentMonth;
                processed = true;
                Swal.fire({ icon: 'info', title: 'Tagihan Dibayar', text: `Tagihan ${bill.name} sebesar ${formatRupiah(bill.amount)} telah dicatat otomatis.`, timer: 3000 });
            }
        });
        if (processed) saveData();
    }
    
    function saveRecurring() {
        const name = document.getElementById('rec-name').value;
        const amount = parseInt(document.getElementById('rec-amount').value);
        const date = parseInt(document.getElementById('rec-date').value);
        const cat = document.getElementById('rec-cat').value;
        if (name && amount && date) {
            data.recurring.push({ id: Date.now(), name: name, amount: amount, day: date, cat: cat, lastPaidMonth: '' });
            saveData(); toggleModal('recurring-modal', false); renderBudget(); Swal.fire('Sukses', 'Tagihan rutin ditambahkan', 'success');
        }
    }
    
    function deleteRecurring(id) { data.recurring = data.recurring.filter(r => r.id != id); saveData(); renderBudget(); }
    
    function toggleFabMenu() {
        document.getElementById('fab-actions').classList.toggle('active');
        document.getElementById('fab-menu-overlay').classList.toggle('active');
    }
    
    function applySmartFilter(val) {
        if(!val) { renderHome(); return; }
        const lower = val.toLowerCase();
        // Mock search logic
        const filtered = data.tx.filter(t => t.desc.toLowerCase().includes(lower) || t.cat.toLowerCase().includes(lower));
        // Only rendering logic below needs adjustment to use filtered data if needed, currently reusing renderHome logic which relies on global filters.
        // For simple search, we can just update the list directly:
        const list = document.getElementById('tx-list-container');
        list.innerHTML = filtered.map(t => `<div class="glass-card px-4 py-3 flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center text-lg">üîç</div><div><p class="text-xs font-bold">${t.cat}</p><p class="text-[10px] opacity-60">${t.desc}</p></div></div><p class="text-xs font-black">${formatRupiah(t.amount)}</p></div>`).join('');
    }

    window.onload = init;
</script>
</body>
</html>